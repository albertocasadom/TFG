SEEDLabsŒRemoteDNSCachePoisoningAttackLab 1 RemoteDNSCachePoisoningAttackLab Copyright©2006-2016WenliangDu SyracuseUniversity ThedevelopmentofthisdocumentwaspartiallyfundedbytheNationalScienceFoundationunderAward No.1303306and1318814.ThisworkislicensedunderaCreativeCommonsAttribution-NonCommercial- ShareAlike4.0InternationalLicense.Ahuman-readablesummaryof andnotasubstitutefor thelicenseis thefollowing Youarefreetocopyandredistributethematerialinanymediumorformat.Youmustgive appropriatecredit.Ifyouremix transform orbuilduponthematerial youmustdistributeyourcontributions underthesamelicenseastheoriginal.Youmaynotusethematerialforcommercialpurposes 1LabOverview TheobjectiveofthislabisforstudentstogaintheexperienceontheremoteDNScachepoisoning attack alsocalledtheKaminskyDNSattack.DNS DomainNameSystem istheInternet'sphonebook ittranslateshostnamestoIPaddressesandviceversa.ThistranslationisthroughDNSresolution happensbehindthescene.DNSPharmingattacksmanipulatethisresolutionprocessinvariousways anintenttomisdirectuserstoalternativedestinations whichareoftenmalicious.Thislabfocusesona particularDNSPharmingattacktechnique called DNSCachePoisoningattack .InanotherSEEDLab havedesignedactivitiestoconductthesameattackinalocalnetworkenvironment i.e. theattackerandthe victimDNSserverareonthesamenetwork wherepacketsnifispossible.Inthisremoteattacklab packetsnifisnotpossible sotheattackbecomesmuchmorechallengingthanthelocalattack.Thislab coversthefollowingtopics Ł DNSandhowitworks Ł DNSserversetup Ł DNScachepoisoningattack Ł DNSresponses Ł Packetsnifand Readingsandrelatedtopics DetailedcoverageofDNSanditsattackscanbefoundinChapter15ofthe SEEDbook ComputerSecurity AHands-onApproach byWenliangDu Labenvironment Thislabhasbeentestedonourpre-builtUbuntu16.04VM whichcanbedownloaded fromtheSEEDwebsite 2LabEnvironment ThemainpurposeofthislabisonDNSattacks andourattackingtargetisalocalDNSserver.Obviously isillegaltoattackarealmachine soweneedtosetupourownDNSservertoconducttheattackexperiments Thelabenvironmentneedsthreeseparatemachines oneforthevictim onefortheDNSserver andtheother fortheattacker.Wewillrunthesethreevirtualmachinesononephysicalmachine.AlltheseVMswillrun ourpre-built Ubuntu VMimage.Figure1illustratesthesetupoftheexperimentenvironment.FortheVM networksetting ifyouareusing VirtualBox pleaseuse '' NATNetwork '' asthenetworkadapterfor eachVM.Ifyouareusing Vmware thedefault '' NAT '' settingisgoodenough.WeputalltheseVMson thesameLANonlyforthesakeofsimplicity studentsarenotallowedtoexploitthisfactintheirattacks SEEDLabsŒRemoteDNSCachePoisoningAttackLab 2 andtheyshouldtreattheattackermachineasaremotemachine i.e. theattackercannotsniffvictimDNS server'spackets Inthefollowingsections weassumethattheusermachine'sIPaddressis 10.0.2.18 thelocalDNS Server'sIPis 10.0.2.16 andtheattackermachine'sIPis 10.0.2.17 .WecalltheLocalDNSserver Apollo inthisdocument Figure1 Environmentsetupfortheexperiment 2.1etheLocalDNSServer Apollo ForthelocalDNSserver weneedtorunaDNSserverprogram.ThemostwidelyusedDNSserversoftware iscalledBIND BerkeleyInternetNameDomain asthenamesuggests wasoriginallydesignedat theUniversityofCaliforniaBerkeleyintheearly1980s.ThelatestversionofBINDisBIND9 whichwas releasedin2000.WewillshowhowtoBIND9forourlabenvironment.TheBIND9server programisalreadyinstalledinourpre-built Ubuntu VMimage Step1 etheBIND9server BIND9getsitsfromacalled /etc/bind/ named.conf .Thisistheprimaryanditusuallycontainsseveral '' include '' entries i.e. theactualarestoredinthoseincludedOneoftheincludediscalled /etc/bind/named.conf.options .Thisiswherewetypicallysetuptheoptions.Let ussetupanoptionrelatedtoDNScachebyaddinga dump-file entrytothe options block options { dump-file '' /var/cache/bind/dump.db '' } TheaboveoptionwherethecachecontentshouldbedumpedtoifBINDisaskedtodumpits cache.Ifthisoptionisnoted BINDdumpsthecachetoadefaultcalled /var/cache/bind/ named_dump.db .ThetwocommandsshownbelowarerelatedtoDNScache.Thecommanddumps thecontentofthecachetotheabove andthesecondcommandclearsthecache $ sudorndcdumpdb-cache//Dumpthecachetothesepcifiedfile $ sudorndcflush//FlushtheDNScache SEEDLabsŒRemoteDNSCachePoisoningAttackLab 3 Step2 TurnoffDNSSEC DNSSECisintroducedtoprotectagainstattacksonDNSservers Toshowhowattacksworkwithoutthisprotectionmechanism weneedtoturntheprotectionoff.Thisis donebymodifyingthe named.conf.options commentoutthe dnssec-validation entry andadda dnssec-enable entry options { # dnssec-validationauto dnssec-enableno } Step3 FixtheSourcePorts DNSserversnowrandomizethesourceportnumberintheirDNSqueries thismakestheattacksmuchmoredifUnfortunately manyDNSserversstillusepredictablesource portnumber.Forthesakeofsimplicityinthislab weassumethatthesourceportnumberisaednumber WecansetthesourceportforallDNSqueriesto 33333 .Thiscanbedonebyaddingthefollowingoption tothe /etc/bind/named.conf.options query-sourceport33333 Step4 Removethe example.com Zone IfyoudidourﬁLocalDNSAttackLabﬂ youhaveprobably thelocalDNSserver Apollo tohostthe example.com domain.Inthislab thisDNSserver willnothostthatdomain sopleaseremoveitscorrespondingzonefrom /etc/bind/named.conf Step5 StartDNSserver WecannowstarttheDNSserverusingthefollowingcommand.Everytime aonismadetotheDNStheDNSserverneedstoberestarted.Thefollowing commandwillstartorrestartthe BIND9 DNSserver $ sudoservicebind9restart 2.2etheUserMachine Ontheusermachine 10.0.2.18 weneedtouse 10.0.2.16 asthelocalDNSserver bydefault DNSserverprogramisalreadyrunningintheSEEDVM .Thisisachievedbychangingtheresolvercon- /etc/resolv.conf oftheusermachine sotheserver 10.0.2.16 isaddedasthe nameserver entryinthei.e. thisserverwillbeusedastheprimaryDNSserver.Unfortunately providedVMusestheDynamicHostProtocol DHCP toobtainnetworkpa- rameters suchasIPaddress localDNSserver etc.DHCPclientswilloverwritethe /etc/resolv.conf withtheinformationprovidedbytheDHCPserver Onewaytogetourinformationinto /etc/resolv.conf withoutworryingabouttheDHCPisto addthefollowingentrytothe /etc/resolvconf/resolv.conf.d/head Addthefollowingentryto/etc/resolvconf/resolv.conf.d/head nameserver10.0.2.16 Runthefollowingcommandforthechangetotakeeffect $ sudoresolvconf-u Thecontentoftheheadwillbeprependedtothedynamicallygeneratedresolver Normally thisisjustacommentline thecommentin /etc/resolv.conf comesfromthishead SEEDLabsŒRemoteDNSCachePoisoningAttackLab 4 Afteryoutheusermachine usethe dig commandtogetanIPaddressfromahost- nameofyourchoice.Fromtheresponse pleaseprovideevidencestoshowthattheresponseisindeedfrom yourserver.Ifyoucannottheevidence yoursetupisnotsuccessful 3LabTasks ThemainobjectiveofPharmingattacksistoredirecttheusertoanothermachine B whentheusertriesto gettomachine A using A 'shostname.Forexample assuming www.example.com isanonlinebanking site.WhentheusertriestoaccessthissiteusingthecorrectURL www.example.com iftheadversaries canredirecttheusertoamaliciouswebsitethatlooksverymuchlike www.example.com theusermight befooledandgiveawayhis/hercredentialstotheattacker Inthistask weusethedomainname www.example.com asourattackingtarget.Itshouldbenoted thatthe example.com domainnameisreservedforuseindocumentation notforanyrealcompany.The authenticIPaddressof www.example.com 93.184.216.34 anditsnameserverismanagedbythe InternetCorporationforAssignedNamesandNumbers ICANN .Whentheuserrunsthe dig command onthisnameortypesthenameinthebrowser theuser'smachinesendsaDNSquerytoitslocalDNS server whichwilleventuallyaskfortheIPaddressfrom example.com 'snameserver ThegoaloftheattackistolaunchtheDNScachepoisoningattackonthelocalDNSserver suchthat whentheuserrunsthe dig commandtoout www.example.com 'sIPaddress thelocalDNSserver willendupgoingtotheattacker'snameserver ns.dnslabattacker.net togettheIPaddress sothe IPaddressreturnedcanbeanynumberthatisdecidedbytheattacker.Asresults theuserwillbeledtothe attacker'swebsite insteadoftheauthentic www.example.com Therearetwotasksinthisattack cachepoisoningandresultvInthetask students needtopoisontheDNScacheoftheuser'slocalDNSserver Apollo suchthat Apollo 'sDNScache ns.dnslabattacker.net issetasthenameserverforthe example.com domain insteadofthe domain'sregisteredauthoritativenameserver.Inthesecondtask studentsneedtodemonstratetheimpact oftheattack.More theyneedtorunthecommand '' digwww.example.com '' fromthe user'smachine andthereturnedresultmustbeafakeIPaddress 3.1Task1 RemoteCachePoisoning Inthistask theattackersendsaDNSqueryrequesttothevictimDNSserver Apollo triggeringaDNS queryfrom Apollo .ThequerymaygothroughoneoftherootDNSservers .COM DNSserver theresultwillcomebackfrom example.com 'sDNSserver.ThisisillustratedinFigure2.Incase example.com 'snameserverinformationisalreadycachedby Apollo thequerywillnotgothrough therootorthe .COM server thisisillustratedinFigure3.Inthislab thesituationdepictedinFigure3is morecommon sowewillusethisasthebasistodescribetheattackmechanism While Apollo waitsfortheDNSreplyfrom example.com 'snameserver theattackercansend forgedrepliesto Apollo pretendingthattherepliesarefrom example.com 'snameserver.Iftheforged repliesarriveitwillbeacceptedby Apollo .Theattackwillbesuccessful IfyouhavedoneourlocalDNSattacklab youshouldrealizethatthoseattacksassumethattheattacker andtheDNSserverareonthesameLAN i.e. theattackercanobservetheDNSquerymessage.Whenthe attackerandtheDNSserverarenotonthesameLAN thecachepoisoningattackbecomesmoredif ThedifismainlycausedbythefactthatthetransactionIDintheDNSresponsepacketmustmatch withthatinthequerypacket.BecausethetransactionIDinthequeryisusuallyrandomlygenerated without seeingthequerypacket itisnoteasyfortheattackertoknowthecorrectID SEEDLabsŒRemoteDNSCachePoisoningAttackLab 5 Figure2 ThecompleteDNSqueryprocess Obviously theattackercanguessthetransactionID.SincethesizeoftheIDisonly16bits ifthe attackercanforge K responseswithintheattackwindow i.e.beforethelegitimateresponsearrives probabilityofsuccessis K 2 16 .Sendingouthundredsofforgedresponsesisnotimpractical soitwill nottaketoomanytriesbeforetheattackercansucceed However theabovehypotheticalattackhasoverlookedthecacheeffect.Inreality iftheattackerisnot fortunatelyenoughtomakeacorrectguessbeforetherealresponsepacketarrives correctinformationwill becachedbytheDNSserverforawhile.Thiscachingeffectmakesitimpossiblefortheattackertoforge anotherresponseregardingthesamedomainname becausetheDNSserverwillnotsendoutanotherDNS queryforthisdomainnamebeforethecachetimesout.Toforgeanotherresponseonthesamedomain name theattackerhastowaitforanotherDNSqueryonthisdomainname whichmeanshe/shehastowait forthecachetotimeout.Thewaitingperiodcanbehoursordays TheKaminskyAttack DanKaminskycameupwithaneleganttechniquetodefeatthecachingeffect 1 WiththeKaminskyattack attackerswillbeabletocontinuouslyattackaDNSserveronadomainname withouttheneedforwaiting soattackscansucceedwithinaveryshortperiodoftime.Detailsoftheattacks aredescribedin 1,2 .Inthistask wewilltrythisattackmethod.Thefollowingstepswithreferenceto Figure3outlinestheattack 1 TheattackerqueriestheDNSServer Apollo foranon-existingnamein example.com suchas twysw.example.com twysw isarandomname SEEDLabsŒRemoteDNSCachePoisoningAttackLab 6 Figure3 TheDNSqueryprocesswhen example.com 'snameserveriscached 2 Sincethemappingisunavailablein Apollo 'sDNScache Apollo sendsaDNSquerytothename serverofthe example.com domain 3 While Apollo waitsforthereply theattacker Apollo withastreamofspoofedDNSre- sponse eachtryingadifferenttransactionID hopingoneiscorrect.Intheresponse notonlydoes theattackerprovideanIPresolutionfor twysw.example.com theattackeralsoprovidesanﬁAu- thoritativeNameserversﬂrecord indicating ns.dnslabattacker.net asthenameserverforthe example.com domain.IfthespoofedresponsebeatstheactualresponsesandthetransactionID matcheswiththatinthequery Apollo willacceptandcachethespoofedanswer andandthus Apollo 'sDNScacheispoisoned 4 EvenifthespoofedDNSresponsefails e.g.thetransactionIDdoesnotmatchoritcomestoolate itdoesnotmatter becausethenexttime theattackerwillqueryadifferentname Apollo hasto sendoutanotherquery givingtheattackanotherchancetodotheattack.Thiseffectively defeatsthecachingeffect 5 Iftheattacksucceeds Apollo 'sDNScache thenameserverfor example.com willbereplaced bytheattacker'snameserver ns.dnslabattacker.net .Todemonstratethesuccessofthis attack studentsneedtoshowthatsucharecordisin Apollo 'sDNScache.Figure4showsan exampleofpoisonedDNScache SEEDLabsŒRemoteDNSCachePoisoningAttackLab 7 Attack Weneedtotheattackmachine soitusesthetargetedDNSserver i.e. Apollo asitsdefaultDNSserver.PleaseseeSection2.2fortheinstruction.Makesurethatthenetwork forthisVMis '' NATNetwork '' Task1.1 DNSrequest ImplementingtheKaminskyattackisquitechallenging sowebreakit downintothreesub-tasks.ThissubtaskfocusesonDNSrequests.Inordertocompletetheattack asattackers needtotriggerthetargetDNSservertosendoutDNSqueries sowehaveachancetospoof DNSreplies.Sinceweneedtotrymanytimesbeforewecansucceed wehavetoautomatetheprocess.The stepistowriteaprogramtosendoutDNSqueriestothetargetDNSserver eachtimewithadifferent hostnameinthequestionYourjobistowritethisprogramanddemonstrateusingWiresharkthatyour queriescantriggerthetargetDNSservertosendoutDNSqueriesonbehalfofyou BecausewedonotneedtosendoutDNSqueriesveryfast wecanaffordtouseanexternalprogramto dothatforus insteadofimplementingeverythinginCprograms.Forexample youcanuse system invokedig system `` digxyz.example.net '' } FirstneedstosendDNSqueriesto Apollo forsomerandomhostnamesinthe example.com do- main.Rightaftereachqueryissentout theattackerneedstoforgealargenumberofDNSresponsepackets inaveryshorttimewindow hopingthatoneofthemhasthecorrecttransactionIDanditreachesthetarget beforetheauthenticresponsedoes Task1.2 DNSReplies WeneedtospoofDNSrepliesintheKaminskyattack.Performanceis essentialforthesuccessoftheattack soitisbettertowritetheprograminC.Tomakeyourlifeeasier haveprovidedasamplecodecalled spoofdns.c whichshowshowtoconstructDNSreplypackets 1 Whenmodifyingthe spoofdns.c program youneedtoeachDNSwiththecorrectvalue Tounderstandthevalueineachyoucanuse Wireshark tocaptureafewDNSqueryand responsepackets 2 Explainthecode ... Pleaseshowwhatkindofrepliesyouareandexplainwhy.YoushoulduseWiresharktocapture yourspoofedDNSreplies andshowthedetailsofsomeselectedrepliesinthereport Task1.3 TheKaminskyAttack NowwecanputeverythingtogethertoconducttheKaminskyattack Launchyourattackandthencheckthe dump.db toseewhetheryourspoofedDNSresponsehasbeen successfullyacceptedbytheDNSserver.SeeanexampleinFigure4 3.2Task2 ResultV Ifyourattackissuccessful Apollo 'sDNScachewilllooklikethatinFigure ? ? i.e. NS recordfor example.com becomes ns.dnslabattacker.net .Tomakesurethattheattackisindeedsuccessful werunthe dig commandontheusermachine seeFigure ? ? toaskfor www.example.com 'sIPaddress When Apollo receivestheDNSquery itsearchesfor example.com 's NS recordinitscache ns.dnslabattacker.net .ItwillthereforesendaDNSqueryto ns.dnslabattacker.net However beforesendingthequery itneedstoknowtheIPaddressof ns.dnslabattacker.net .This isdonebyissuingaseparateDNSquery.Thatiswherewegetintotrouble SEEDLabsŒRemoteDNSCachePoisoningAttackLab 8 Figure4 ASampleofSuccessfullyPoisonedDNSCache Thedomainname dnslabattacker.net doesnotexistinreality.Wecreatedthisnameforthepur- poseofthislab Apollo willsoonoutaboutthat andmarkthe NS entryinvalid essentiallyrecovering fromthepoisonedcache.OnemaysaythatwhenforgingtheDNSresponse wecanuseanadditionalrecord toprovidetheIPaddressfor ns.dnslabattacker.net .Unfortunately thisadditionalrecordwillnot beacceptedby Apollo .Pleasethinkaboutwhyandgiveyourexplanationinyourlabreport hint think aboutthe zones Therearetwowaystosolvetheproblem sowecandemonstratetheimpactofoursuccesscache- poisoningattack theattackisindeedsuccessful theproblemisthatwecannotshowit UseaRealDomainName IfyouownarealdomainandyoucanitsDNS yourjobiseasy Justuseyourowndomainnameinthe NS record insteadof dnslabattacker.net .Pleaserefertothe setupsectioninourﬁLocalDNSAttackLabﬂtoyourdomain'sDNSserver soitcananswerthe queriesforthe example.com domain UseAFakeDomainName Ifyoudonotownarealdomainname youcanstilldothedemonstra- tionusingourfakedomainname ns.dnslabattacker.net .Wejustneedtodosomeextra urationon Apollo soitrecognizes dnslabattacker.net asarealdomain.Webasicallyaddthe ns.dnslabattacker.net 'sIPaddressto Apollo 'sDNSso Apollo doesnotneedto gooutaskingfortheIPaddressofthishostnamefromanon-existingdomain.Theinstructionsareprovided inthefollowing SEEDLabsŒRemoteDNSCachePoisoningAttackLab 9 Wethevictim'sDNSserver Apollo .Findthe named.conf.default-zones inthe /etc/bind/ folder andaddthefollowingentrytoit zone '' ns.dnslabattacker.net '' { typemaster file '' /etc/bind/db.attacker '' } Createthe /etc/bind/db.attacker andplacethefollowingcontentsinit.Welettheat- tacker'smachineand ns.dnslabattacker.net sharethemachine 192.168.0.200 .Beaware thattheformatofthefollowingcontentscanbemessedupinthePDFifyoucopyandpaste.Wehave linkedthe db.attacker inthelab'swebsite $ TTL604800 @ INSOAlocalhost.root.localhost 2 Serial 604800 Refresh 86400 Retry 2419200 Expire 604800 NegativeCacheTTL @ INNSns.dnslabattacker.net @ INA192.168.0.200 @ INAAAA :1 Oncethesetupisifyourcachepoisoningattackissuccessful anyDNSquerysentto Apollo forthehostnamesin example.com willbesentto 192.168.0.200 whichisattacker'smachine WeneedtotheDNSserveron 192.168.0.200 soitanswersthequeriesforthedomain example.com .Addthefollowingentryin /etc/bind/named.conf.local 192.168.0.200 zone '' example.com '' { typemaster file '' /etc/bind/example.com.db '' } Createacalled /etc/bind/example.com.db anditwiththefollowingcontents.Please donotdirectlycopyandpastefromthePDFastheformatmaybemessedup.Youcandownloadthe example.com.db fromthelab'swebsite $ TTL3D @ INSOAns.example.com.admin.example.com 2008111001 8H 2H 4W 1D @ INNSns.dnslabattacker.net @ INMX10mail.example.com wwwINA1.1.1.1 mailINA1.1.1.2 * .example.comINA1.1.1.100 SEEDLabsŒRemoteDNSCachePoisoningAttackLab 10 Whenthearedonotforgettorestartboth Apollo 'sandtheattacker'sDNS servers otherwise thewillnottakeeffect.Ifeverythingisdoneproperly youcanusethe commandlike '' digwww.example.com ontheusermachine.Thereplywouldbe 1.1.1.1 whichis exactlywhatweputintheabove 4Submission Studentsneedtosubmitadetailedlabreporttodescribewhattheyhavedoneandwhattheyhaveobserved Reportshouldincludetheevidencestosupporttheobservations.Evidencesincludepackettraces screen dumps etc Note PleasedonotforgettoanswerthequestionaskedinTask2 regardingwhytheIPaddressfor ns.dnslabattacker.net intheadditionalisnotacceptedbythevictimDNSserver References 1 D.Schneider.FreshPhish HowarecentlydiscoveredwintheInternet'sDomainNameSys- temmakesiteasyforscammerstolureyoutofakeWebsites IEEESpectrum ,2008 http //spectrum.ieee.org/computing/software/fresh-phish 2 Du Wenliang.ComputerSecurity AHands-onApproach CreateSpaceIndependentPub- lishingPlatform ,2017ISBN-10:154836794X ISBN-13:978-1548367947 https //www handsonsecurity.net/ 