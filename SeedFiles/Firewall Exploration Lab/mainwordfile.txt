SEEDLabsŒLinuxFirewallExplorationLab 1 LinuxFirewallExplorationLab Copyright©2006-2016WenliangDu SyracuseUniversity ThedevelopmentofthisdocumentwaspartiallyfundedbytheNationalScienceFoundationunderAward No.1303306and1318814.ThisworkislicensedunderaCreativeCommonsAttribution-NonCommercial- ShareAlike4.0InternationalLicense.Ahuman-readablesummaryof andnotasubstitutefor thelicenseis thefollowing Youarefreetocopyandredistributethematerialinanymediumorformat.Youmustgive appropriatecredit.Ifyouremix transform orbuilduponthematerial youmustdistributeyourcontributions underthesamelicenseastheoriginal.Youmaynotusethematerialforcommercialpurposes 1Overview Thelearningobjectiveofthislabisforstudentstogaintheinsightsonhowwallsworkbyplaying withwallsoftwareandimplementapacketwall.Firewallshaveseveraltypes thislab wefocuson packet .Packetinspectpackets anddecidewhethertodroporforward apacketbasedonwallrules.Packetareusually stateless theyeachpacketbasedonlyon theinformationcontainedinthatpacket withoutpayingattentiontowhetherapacketispartofanexisting streamoftrafPacketersoftenuseacombinationofapacket'ssourceanddestinationaddress protocol forTCPandUDPtrafportnumbers.Inthislab studentswillplaywiththistypeof wall andalsothroughtheimplementationofsomeofthekeyfunctionalities theycanunderstandhow wallswork.Moreover studentswilllearnhowtouseSSHtunnelstobypasswalls.Thislabcovers thefollowingtopics Ł Firewall Ł Ł Loadablekernelmodule Ł SSHtunnel Readingsandrelatedtopics DetailedcoverageofFirewallscanbefoundinChapter14oftheSEED book ComputerSecurity AHands-onApproach byWenliangDu.ArelatedlabistheFirewallBypassing lab whichshowshowtouseVPNtobypasswalls Labenvironment Thislabhasbeentestedonourpre-builtUbuntu16.04VM whichcanbedownloaded fromtheSEEDwebsite 2LabTasks 2.1Task1 UsingFirewall Linux hasatoolcalled iptables whichisessentiallyawall.Ithasanicefrontendprogramcalled ufw .Inthistask theobjectiveistouse ufw tosetupsomewallpolicies andobservethebehaviorsof yoursystemafterthepoliciesbecomeeffective.YouneedtosetupatleasttwoVMs onecalledMachineA andothercalledMachineB.YourunthewallonyourMachineA.Basically weuse ufw asapersonal wall.Optionally ifyouhavemoreVMs youcansetupawallatyourrouter soitcanprotect anetwork insteadofjustonesinglecomputer.AfteryousetupthetwoVMs youshouldperformthe followingtasks SEEDLabsŒLinuxFirewallExplorationLab 2 Ł PreventAfromdoing telnet toMachineB Ł PreventBfromdoing telnet toMachineA Ł PreventAfromvisitinganexternalwebsite.Youcanchooseanywebsitethatyouliketoblock keepinmind somewebservershavemultipleIPaddresses Youcanthemanualof ufw bytyping '' manufw '' orsearchitonline.Itisprettystraightforwardto use.Pleaserememberthatthewallisnotenabledbydefault soyoushouldrunacommandto enableit.WelistsomecommonlyusedcommandsinAppendixA Beforestartingthetask gotothedefaultpolicy /etc/default/ufw .thefollowingentry andchangetherulefrom DROP ACCEPT otherwise alltheincomingtrafwillbedroppedbydefault # SetthedefaultinputpolicytoACCEPT DROP orREJECT.Pleasenotethatif # youchangethisyouwillmostlikelywanttoadjustyourrules DEFAULT_INPUT_POLICY= '' DROP '' 2.2Task2 ImplementingaSimpleFirewall Thewallyouusedintheprevioustaskisapackettypeofwall.Themainpartofthistypeof wallisthepart whichinspectseachincomingandoutgoingpackets andenforcesthewall policiessetbytheadministrator.Sincethepacketprocessingisdonewithinthekernel themust alsobedonewithinthekernel.Therefore itseemsthatimplementingsuchawallrequiresustomodify Linux kernel.Inthepast thishadtobedonebymodifyingandrebuildingthekernel.Themodern Linux operatingsystemsprovideseveralnewmechanismstofacilitatethemanipulationofpacketswithout rebuildingthekernelimage.Thesetwomechanismsare LoadableKernelModule LKM Netfilter LKM allowsustoaddanewmoduletothekernelattheruntime.Thisnewmoduleenablesustoextend thefunctionalitiesofthekernel withoutrebuildingthekernelorevenrebootingthecomputer.Thepacket partofawallcanbeimplementedasanLKM.However thisisnotenough.Inorderforthe moduletoblockincoming/outgoingpackets themodulemustbeinsertedintothepacketprocessing path.Thiscannotbeeasilydoneinthepastbeforethe Netfilter wasintroducedintothe Linux Netfilter isdesignedtofacilitatethemanipulationofpacketsbyauthorizedusers Netfilter achievesthisgoalbyimplementinganumberof hooks inthe Linux kernel.Thesehooksareinsertedinto variousplaces includingthepacketincomingandoutgoingpaths.Ifwewanttomanipulatetheincoming packets wesimplyneedtoconnectourownprograms withinLKM tothecorrespondinghooks.Oncean incomingpacketarrives ourprogramwillbeinvoked.Ourprogramcandecidewhetherthispacketshould beblockedornot moreover wecanalsomodifythepacketsintheprogram Inthistask youneedtouseLKMand Netfilter toimplementthepacketmodule.This modulewillfetchthewallpoliciesfromadatastructure andusethepoliciestodecidewhetherpackets shouldbeblockedornot.Tomakeyourlifeeasier soyoucanfocusonthepart thecoreof walls weallowyoutohardcodeyourwallpoliciesintheprogram.Youshouldsupportatleastve differentrules includingtheonesintheprevioustask.Guidelinesonhowtouse Netfilter befoundinSection3.Inaddition Chapter14 §14.4 oftheSEEDbookprovidesmoredetailedexplanation Netfilter NoteforUbuntu16.04VM ThecodeintheSEEDbookwasdevelopedinUbuntu12.04.Itneeds tobechangedslightlytoworkinUbuntu16.04.Thechangeisintheofthecallbackfunc- tion telnetFilter becausetheprototypeof Netfilter 'scallbackfunctionhasbeenchangedin Ubuntu16.04.Seethedifferenceinthefollowing SEEDLabsŒLinuxFirewallExplorationLab 3 //InUbuntu12.04 unsignedinttelnetFilter unsignedinthooknum structsk_buff * skb conststructnet_device * conststructnet_device * int * okfn structsk_buff * //InUbuntu16.04 unsignedinttelnetFilter void * priv structsk_buff * skb conststructnf_hook_state * state 2.3Task3 EvadingEgressFiltering Manycompaniesandschoolsenforceegresswhichblocksusersinsideoftheirnetworksfrom reachingouttocertainwebsitesorInternetservices.Theydoallowuserstoaccessotherwebsites.Inmany cases thistypeofwallsinspectthedestinationIPaddressandportnumberintheoutgoingpackets.If apacketmatchestherestrictions itwillbedropped.Theyusuallydonotconductdeeppacketinspections i.e. lookingintothedatapartofpackets duetotheperformancereason.Inthistask weshowhowsuch egresscanbebypassedusingthetunnelmechanism.Therearemanywaystoestablishtunnels thistask weonlyfocusonSSHtunnels YouneedtwoVMsAandBforthistask threewillbebetter .MachineAisrunningbehindawall i.e. insidethecompanyorschool'snetwork andMachineBisoutsideofthewall.Typically thereisa dedicatedmachinethatrunsthewall butinthistask forthesakeofconvenience youcanrunthewall onMachineA.Youcanusethewallprogramthatyouimplementedintheprevioustask ordirectlyuse ufw .Youneedtosetupthefollowingtwowallrules Ł Blockalltheoutgoingtraftoexternaltelnetservers Inreality theserversthatareblockedareusu- allygameserversorothertypesofserversthatmayaffecttheproductivityofemployees.Inthistask weusethetelnetserverfordemonstrationpurposes.YoucanrunthetelnetserveronMachineB.If youhaveathirdVM MachineC youcanrunthetelnetserveronMachineC Ł Blockalltheoutgoingtrafto www.facebook.com soemployees orschoolkids arenotdis- tractedduringtheirwork/schoolhours.Socialnetworksitesarecommonlyblockedbycompanies andschools.Afteryousetupthewall launchyourFirefoxbrowser andtrytoconnecttoFace- book andreportwhathappens.IfyouhavealreadyvisitedFacebookbeforeusingthisbrowser youneedtoclearallthecachesusingFirefox'smenu Edit- > Preferences- > Privacy & Security leftpane - > ClearHistory Buttononright otherwise cachedpagesmaybedisplayed.Ifeverythingissetupproperly youshouldnotbeabletoseeFace- bookpages.ItshouldbenotedthatFacebookhasmanyIPaddresses itcanchangeoverthetime Remembertocheckwhethertheaddressisstillthesamebyusing ping dig command.Ifthe addresshaschanged youneedtoupdateyourwallrules.Youcanalsochoosewebsiteswithstatic IPaddresses insteadofusingFacebook.Forexample mostuniversities'webserversusestaticIP addresses e.g www.syr.edu fordemonstrationpurposes youcantryblocktheseIPs insteadof Facebook Inadditiontosetupthewallrules youalsoneedthefollowingcommandstomanagethewall $ sudoufwenable//thiswillenablethefirewall $ sudoufwdisable//thiswilldisablethefirewall $ sudoufwstatusnumbered//thiswilldisplaythefirewallrules $ sudoufwdelete3//thiswilldeletethe3rdrule SEEDLabsŒLinuxFirewallExplorationLab 4 Figure1 SSHTunnelExample Task3.a TelnettoMachineBthroughtheewall Tobypassthewall wecanestablishanSSH tunnelbetweenMachineAandB soallthetelnettrafwillgothroughthistunnel encrypted evadingthe inspection.Figure1illustrateshowthetunnelworks.ThefollowingcommandestablishesanSSHtunnel betweenthelocalhost port8000 andmachineB usingthedefaultport22 whenpacketscomeoutofB's end itwillbeforwardedtoMachineC'sport23 telnet port .IfyouonlyhavetwoVMs youcanuse oneVMforbothMachineBandMachineC $ ssh-L8000 Machine_C_IP:23seed @ Machine_B_IP //WecannowtelnettoMachineCviathetunnel $ telnetlocalhost8000 Whenwe telnet localhost 'sport 8000 SSHwilltransferallourTCPpacketsfromoneend ofthetunnelon localhost:8000 totheotherendofthetunnelonMachineB fromthere thepackets willbeforwardedto Machine C:23 .RepliesfromMachineCwilltakeareversepath andeventually reachourtelnetclient.Essentially weareabletotelnettoMachineC.Pleasedescribeyourobservationand explainhowyouareabletobypasstheegressYoushoulduseWiresharktoseewhatexactlyis happeningonthewire Task3.b ConnecttoFacebookusingSSHTunnel Toachievethisgoal wecanusetheapproach similartothatinTask3.a i.e. establishingatunnelbetweenyourlocalhost portandMachineB andaskB toforwardpacketstoFacebook.Todothat youcanusethefollowingcommandtosetupthetunnel '' ssh -L8000 FacebookIP:80 ... '' .Wewillnotusethisapproach andinstead weuseamoregeneric approach calleddynamicportforwarding insteadofastaticonelikethatinTask3.a.Todothat weonly specifythelocalportnumber notthedestination.WhenMachineBreceivesapacketfromthetunnel itwilldynamicallydecidewhereitshouldforwardthepackettobasedonthedestinationinformationofthe packet $ ssh-D9000-Cseed @ machine_B SEEDLabsŒLinuxFirewallExplorationLab 5 Figure2 theSOCKSProxy Similartothetelnetprogram whichconnects localhost:9000 weneedtoaskFirefoxtoconnect localhost:9000 everytimeitneedstoconnecttoawebserver sothetrafcangothroughourSSH tunnel.Toachievethat wecantellFirefoxtouse localhost:9000 asitsproxy.Tosupportdynamicport forwarding weneedaspecialtypeofproxycalled SOCKSproxy whichissupportedbymostbrowsers.To setuptheproxyinFirefox gotothemenubar click Edit- > Preferences scrolldownto Network Proxy andclickthe Settings button.ThenfollowFigure2.Afterthesetupisdone pleasedothe following 1 RunFirefoxandgovisittheFacebookpage.CanyouseetheFacebookpage ? Pleasedescribeyour observation 2 Afteryougetthefacebookpage breaktheSSHtunnel cleartheFirefoxcache andtrytheconnection again.Pleasedescribeyourobservation 3 EstablishtheSSHtunnelagainandconnecttoFacebook.Describeyourobservation 4 Pleaseexplainwhatyouhaveobserved especiallyonwhytheSSHtunnelcanhelpbypasstheegress YoushoulduseWiresharktoseewhatexactlyishappeningonthewire.Pleasedescribe yourobservationsandexplainthemusingthepacketsthatyouhavecaptured SEEDLabsŒLinuxFirewallExplorationLab 6 2.4Task4 EvadingIngressFiltering MachineArunsawebserverbehindawall soonlythemachinesintheinternalnetworkcanaccess thiswebserver.Youareworkingfromhomeandneedstoaccessthisinternalwebserver.Youdonothave VPN butyouhaveSSH whichisconsideredasapoorman'sVPN.YoudohaveanaccountonMachineA oranotherinternalmachinebehindthewall butthewallalsoblocksincomingSSHconnection youcannotSSHintoanymachineontheinternalnetwork.Otherwise youcanusethesametechniquefrom Task3toaccessthewebserver.Thewall however doesnotblockoutgoingSSHconnection i.e. ifyou wanttoconnecttoanoutsideSSHserver youcanstilldothat TheobjectiveofthistaskistobeabletoaccessthewebserveronMachineAfromoutside.Wewilluse twomachinestoemulatethesetup.MachineAistheinternalcomputer runningtheprotectedwebserver MachineBistheoutsidemachineathome.OnMachineA weblockMachineBfromaccessingitsport80 webserver and22 SSHserver .YouneedtosetupareverseSSHtunnelonMachineA soonceyouget home youcanstillaccesstheprotectedwebserveronAfromhome 3Guidelines 3.1LoadableKernelModule Thefollowingisasimpleloadablekernelmodule.Itprintsout '' HelloWorld ! '' whenthemoduleis loaded whenthemoduleisremovedfromthekernel itprintsout '' Bye-byeWorld ! '' .Themessages arenotprintedoutonthescreen theyareactuallyprintedintothe /var/log/syslog Youcanuse dmesg|tail-10 toreadthelast10linesofmessage # include < linux/module.h > # include < linux/kernel.h > intinit_module void { printk KERN_INFO '' HelloWorld ! \n '' return0 } voidcleanup_module void { printk KERN_INFO '' Bye-byeWorld ! .\n '' } Wenowneedtocreate Makefile whichincludesthefollowingcontents theaboveprogramisnamed hello.c .Thenjusttype make andtheaboveprogramwillbecompiledintoaloadablekernelmodule obj-m+=hello.o make-C/lib/modules/ $ shelluname-r /buildM= $ PWD modules clean make-C/lib/modules/ $ shelluname-r /buildM= $ PWD clean Oncethemoduleisbuiltbytyping make youcanusethefollowingcommandstoloadthemodule list allmodules andremovethemodule SEEDLabsŒLinuxFirewallExplorationLab 7 $ sudoinsmodmymod.ko insertingamodule $ lsmod listallmodules $ sudormmodmymod.ko removethemodule Also youcanuse modinfomymod.ko toshowinformationaboutaLinuxKernelmodule 3.2ASimpleProgramthatUses Using Netfilter isquitestraightforward.Allweneedtodoistohookourfunctions inthekernel module tothecorresponding Netfilter hooks.Hereweshowanexample # include < linux/module.h > # include < linux/kernel.h > # include < linux/netfilter.h > # include < linux/netfilter_ipv4.h > * Thisisthestructureweshallusetoregisterourfunction * staticstructnf_hook_opsnfho * Thisisthehookfunctionitself * unsignedinthook_func void * priv structsk_buff * skb conststructnf_hook_state * state { * Thisiswhereyoucaninspectthepacketcontainedin thestructurepointedbyskb anddecidewhethertoaccept ordropit.Youcanevenmodifythepacket * //Inthisexample wesimplydropallpackets returnNF_DROP * DropALLpackets * } * Initializationroutine * intinit_module { * Fillinourhookstructure * nfho.hook=hook_func * Handlerfunction * nfho.hooknum=NF_INET_PRE_ROUTING * FirsthookforIPv4 * nfho.pf=PF_INET nfho.priority=NF_IP_PRI_FIRST * Makeourfunctionfirst * nf_register_hook & nfho return0 } * Cleanuproutine * voidcleanup_module { nf_unregister_hook & nfho } SEEDLabsŒLinuxFirewallExplorationLab 8 4SubmissionandDemonstration Studentsneedtosubmitadetailedlabreporttodescribewhattheyhavedone whattheyhaveobserved andexplanation.Reportsshouldincludetheevidencestosupporttheobservations.Evidencesinclude packettraces screendumps etc.Studentsalsoneedtoanswerallthequestionsinthelabdescription.For theprogrammingtasks studentsshouldlisttheimportantcodesnippetsfollowedbyexplanation.Simply attachingcodewithoutanyexplanationisnotenough SEEDLabsŒLinuxFirewallExplorationLab 9 AFirewallLabCheatSheet HeaderFiles Youmayneedtotakealookatseveralheaderincludingthe skbuff.h ip.h icmp.h tcp.h udp.h netfilter.h .Theyarestoredinthefollowingfolder /lib/modules/ $ uname-r /build/include/linux/ IPHeader ThefollowingcodeshowshowyoucangettheIPheader anditssource/destinationIPad- dresses structiphdr * ip_header= structiphdr * skb_network_header skb unsignedintsrc_ip= unsignedint ip_header- > saddr unsignedintdest_ip= unsignedint ip_header- > daddr TCP/UDPHeader ThefollowingcodeshowshowyoucangettheUDPheader anditssource/destination portnumbers.Itshouldbenotedthatweusethe ntohs functiontoconverttheunsignedshortinteger fromthenetworkbyteordertothehostbyteorder.Thisisbecauseinthe80x86architecture thehostbyte orderistheLeastBytewhereasthenetworkbyteorder asusedontheInternet isMost ByteIfyouwanttoputashortintegerintoapacket youshoulduse htons whichis reverseto ntohs structudphdr * udp_header= structudphdr * skb_transport_header skb src_port= unsignedint ntohs udp_header- > source dest_port= unsignedint ntohs udp_header- > dest IPAddressesindifferentformats Youmaythefollowinglibraryfunctionsusefulwhenyouconvert IPaddressesfromoneformattoanother e.g.fromastring '' 128.230.5.3 '' toitscorrespondinginteger inthenetworkbyteorderorthehostbyteorder intinet_aton constchar * cp structin_addr * inp in_addr_tinet_addr constchar * cp in_addr_tinet_network constchar * cp char * inet_ntoa structin_addrin structin_addrinet_makeaddr intnet inthost in_addr_tinet_lnaof structin_addrin in_addr_tinet_netof structin_addrin Using ufw ThedefaultwalltoolforUbuntuis ufw whichisdevelopedtoease iptables wallBydefaultUFWisdisabled soyouneedtoenableit $ sudoufwenable//Enablethefirewall $ sudoufwdisable//Disablethefirewall $ sudoufwstatusnumbered//Displaythefirewallrules $ sudoufwdelete2//Deletethe2ndrule 