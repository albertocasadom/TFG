SEEDLabs 1 Cross-SiteRequestForgery CSRF AttackLab WebApplication Elgg Copyright©2006-2016WenliangDu SyracuseUniversity ThedevelopmentofthisdocumentwaspartiallyfundedbytheNationalScienceFoundationunderAward No.1303306and1318814.ThisworkislicensedunderaCreativeCommonsAttribution-NonCommercial- ShareAlike4.0InternationalLicense.Ahuman-readablesummaryof andnotasubstitutefor thelicenseis thefollowing Youarefreetocopyandredistributethematerialinanymediumorformat.Youmustgive appropriatecredit.Ifyouremix transform orbuilduponthematerial youmustdistributeyourcontributions underthesamelicenseastheoriginal.Youmaynotusethematerialforcommercialpurposes 1Overview TheobjectiveofthislabistohelpstudentsunderstandtheCross-SiteRequestForgery CSRF attack.A CSRFattackinvolvesavictimuser atrustedsite andamalicioussite.Thevictimuserholdsanactive sessionwithatrustedsitewhilevisitingamalicioussite.ThemalicioussiteinjectsanHTTPrequestforthe trustedsiteintothevictimusersession causingdamages Inthislab studentswillbeattackingasocialnetworkingwebapplicationusingtheCSRFattack.The open-sourcesocialnetworkingapplicationiscalled Elgg whichhasalreadybeeninstalledinourVM Elgg hascountermeasuresagainstCSRF butwehaveturnedthemoffforthepurposeofthislab.Thislab coversthefollowingtopics Ł Cross-SiteRequestForgeryattack Ł CSRFcountermeasures SecrettokenandSame-sitecookie Ł HTTPGETandPOSTrequests Ł JavaScriptandAjax Readings DetailedcoverageoftheCross-SiteRequestForgeryattackcanbefoundinChapter9ofthe SEEDbook ComputerSecurity AHands-onApproach byWenliangDu Labenvironment Thislabhasbeentestedonourpre-builtUbuntu16.04VM whichcanbedownloaded fromtheSEEDwebsite 2LabEnvironment ThislabcanonlybeconductedinourUbuntu16.04VM becauseofthethatwehaveper- formedtosupportthislab.Wesummarizetheseinthissection The Elgg WebApplication Weuseanopen-sourcewebapplicationcalled Elgg inthislab Elgg isa web-basedsocial-networkingapplication.Itisalreadysetupinthepre-built Ubuntu VMimage.Wehave alsocreatedseveraluseraccountsonthe Elgg serverandthecredentialsaregivenbelow SEEDLabs 2 User UserName Password Admin admin seedelgg Alice alice seedalice Boby boby seedboby Charlie charlie seedcharlie Samy samy seedsamy DNS Thislabinvolvestwowebsites thevictimwebsiteandtheattacker'swebsite.Both websitesaresetuponourVM.TheirURLsandfoldersaredescribedinthefollowing Attacker'swebsite URL http //www.csrflabattacker.com Folder /var/www/CSRF/Attacker/ Victimwebsite Elgg URL http //www.csrflabelgg.com Folder /var/www/CSRF/Elgg/ TheaboveURLsareisonlyaccessiblefrominsideofthevirtualmachine becausewehave /etc/hosts tomapthedomainnameofeachURLtothevirtualmachine'slocalIPaddress 127.0.0.1 .YoumaymapanydomainnametoaparticularIPaddressusing /etc/hosts .For example youcanmap http //www.example.com tothelocalIPaddressbyappendingthefollowing entryto /etc/hosts 127.0.0.1www.example.com Ifyourwebserverandbrowserarerunningontwodifferentmachines youneedtomodify /etc/hosts onthebrowser'smachineaccordinglytomapthesedomainnamestothewebserver'sIPaddress notto 127.0.0.1 Apache Inourpre-builtVMimage weusedApacheservertohostallthewebsitesused inthelab.Thename-basedvirtualhostingfeatureinApachecouldbeusedtohostseveralwebsites URLs onthesamemachine.Anamed 000-default.conf inthedirectory '' /etc/ apache2/sites-available '' containsthenecessarydirectivesforthe Insidetheeachwebsitehasa VirtualHost blockthattheURLforthe websiteanddirectoryinthesystemthatcontainsthesourcesforthewebsite.Thefollowingexamples showhowtoawebsitewithURL http //www.example1.com andanotherwebsitewith URL http //www.example2.com < VirtualHost * > ServerNamehttp //www.example1.com DocumentRoot/var/www/Example_1/ < /VirtualHost > < VirtualHost * > ServerNamehttp //www.example2.com DocumentRoot/var/www/Example_2/ < /VirtualHost > SEEDLabs 3 Youmaymodifythewebapplicationbyaccessingthesourceinthementioneddirectories.Forexam- ple withtheabovethewebapplication http //www.example1.com canbechangedby modifyingthesourcesinthe /var/www/Example_1/ directory.Afterachangeismadetothe ration theApacheserverneedstoberestarted.Seethefollowingcommand $ sudoserviceapache2start 3LabTasks Forthelabtasks youwillusetwowebsitesthatarelocallysetupinthevirtualmachine.Thewebsiteis thevulnerable Elgg siteaccessibleat www.csrflabelgg.com insidethevirtualmachine.Thesecond websiteistheattacker'smaliciouswebsitethatisusedforattacking Elgg .Thiswebsiteisaccessiblevia www.csrflabattacker.com insidethevirtualmachine 3.1Task1 ObservingHTTPRequest InCross-SiteRequestForgetattacks weneedtoforgeHTTPrequests.Therefore weneedtoknowwhat alegitimateHTTPrequestlookslikeandwhatparametersituses etc.WecanuseaFirefoxadd-oncalled '' HTTPHeaderLive '' forthispurpose.Thegoalofthistaskistogetfamiliarwiththistool.Instructions onhowtousethistoolisgivenintheGuidelinesection §4.1 .PleaseusethistooltocaptureanHTTP GETrequestandanHTTPPOSTrequestin Elgg .Inyourreport pleaseidentifytheparametersusedin thistheserequests ifany 3.2Task2 CSRFAttackusingGETRequest Inthistask weneedtwopeopleinthe Elgg socialnetwork AliceandBoby.Bobywantstobecomea friendtoAlice butAlicerefusestoaddhimtoher Elgg friendlist.BobydecidestousetheCSRFattackto achievehisgoal.HesendsAliceanURL viaanemailorapostingin Elgg Alice curiousaboutit clicks ontheURL whichleadshertoBoby'swebsite www.csrflabattacker.com .Pretendthatyouare Boby describehowyoucanconstructthecontentofthewebpage soassoonasAlicevisitsthewebpage BobyisaddedtothefriendlistofAlice assumingAlicehasanactivesessionwith Elgg Toaddafriendtothevictim weneedtoidentifywhatthelegitimateAdd-FriendHTTPrequest aGET request lookslike.Wecanusethe '' HTTPHeaderLive '' Tooltodotheinvestigation.Inthistask arenotallowedtowriteJavaScriptcodetolaunchtheCSRFattack.Yourjobistomaketheattacksuccessful assoonasAlicevisitsthewebpage withoutevenmakinganyclickonthepage hint youcanusethe img tag whichautomaticallytriggersanHTTPGETrequest Elgg hasimplementedacountermeasuretodefendagainstCSRFattacks.InAdd-FriendHTTPre- quests youmaynoticethateachrequestincludestwowired-lookingparameters elgg ts elgg token Theseparametersareusedbythecountermeasure soiftheydonotcontaincorrectvalues therequestwill notbeacceptedby Elgg .Wehavedisabledthecountermeasureforthislab sothereisnoneedtoinclude thesetwoparametersintheforgedrequests 3.3Task3 CSRFAttackusingPOSTRequest AfteraddinghimselftoAlice'sfriendlist Bobywantstodosomethingmore.HewantsAlicetosayﬁBoby ismyHeroﬂinhersoeverybodyknowsaboutthat.AlicedoesnotlikeBoby letaloneputtingthat SEEDLabs 4 statementinherBobyplanstouseaCSRFattacktoachievethatgoal.Thatisthepurposeofthis task OnewaytodotheattackistopostamessagetoAlice's Elgg account hopingthatAlicewillclick theURLinsidethemessage.ThisURLwillleadAlicetoyour i.e. Boby 's maliciouswebsite www csrflabattacker.com whereyoucanlaunchtheCSRFattack Theobjectiveofyourattackistomodifythevictim'sInparticular theattackerneedsto forgearequesttomodifytheinformationofthevictimuserof Elgg .Allowinguserstomod- ifytheirisafeatureof Elgg .Ifuserswanttomodifytheirtheygotothepage Elgg outaform andthensubmittheformŠsendingaPOSTrequestŠtotheserver-sidescript /profile/edit.php whichprocessestherequestanddoesthe Theserver-sidescript edit.php acceptsbothGETandPOSTrequests soyoucanusethesametrick asthatinTask1toachievetheattack.However inthistask youarerequiredtousethePOSTrequest Namely attackers needtoforgeanHTTPPOSTrequestfromthevictim'sbrowser whenthevictim isvisitingtheirmalicioussite.Attackersneedtoknowthestructureofsucharequest.Youcanobserve thestructureoftherequest i.e. theparametersoftherequest bymakingsometothe andmonitoringtherequestusingthe '' HTTPHeaderLive '' tool.Youmayseesomethingsimilarto thefollowing.UnlikeHTTP GET requests whichappendparameterstotheURLstrings theparameters ofHTTP POST requestsareincludedintheHTTPmessagebody seethecontentsbetweenthetwo P symbols http //www.csrflabelgg.com/action/profile/edit POST/action/profile/editHTTP/1.1 Host www.csrflabelgg.com User-Agent Mozilla/5.0 X11 Ubuntu Linuxi686 rv:23.0 ... Accept text/html application/xhtml+xml application/xml q=0.9 * * q=0.8 Accept-Language en-US en q=0.5 Accept-Encoding gzip deflate Referer http //www.csrflabelgg.com/profile/elgguser1/edit Cookie Elgg=p0dci8baqrl4i2ipv2mio3po05 Connection keep-alive Content-Type application/x-www-form-urlencoded Content-Length:642 __elgg_token=fc98784a9fbd02b68682bbb0e75b428b & __elgg_ts=1403464813 P & name=elgguser1 & description= % 3Cp % 3Iamelgguser1 % 3C % 2Fp % 3E & accesslevel % 5Bdescription % 5D=2 & briefdescription=Iamelgguser1 & accesslevel % 5Bbriefdescription % 5D=2 & location=US ... ... P Afterunderstandingthestructureoftherequest youneedtobeabletogeneratetherequestfromyour attackingwebpageusingJavaScriptcode.TohelpyouwritesuchaJavaScriptprogram weprovidea samplecodeinthefollowingYoucanusethissamplecodetoconstructyourmaliciouswebsiteforthe CSRFattacks.Thisisonlyasamplecode andyouneedtomodifyittomakeitworkforyourattack < html > < body > < h1 > ThispageforgesanHTTPPOSTrequest. < /h1 > < scripttype= '' text/javascript '' > functionforge_post { SEEDLabs 5 varfields //Thefollowingareformentriesneedtobefilledoutbyattackers //Theentriesaremadehidden sothevictimwon'tbeabletoseethem fields+= '' < inputtype='hidden'name='name'value=' **** ' > '' fields+= '' < inputtype='hidden'name='briefdescription'value=' **** ' > '' fields+= '' < inputtype='hidden'name='accesslevel briefdescription ' value= ' 2 ' > '' À fields+= '' < inputtype='hidden'name='guid'value=' **** ' > '' //Createa < form > element varp=document.createElement `` form '' //Constructtheform p.action= '' http //www.example.com '' p.innerHTML=fields p.method= '' post '' //Appendtheformtothecurrentpage document.body.appendChild p //Submittheform p.submit } //Invokeforge_post afterthepageisloaded window.onload=function { forge_post } < /script > < /body > < /html > InLine À thevalue 2 setstheaccesslevelofatopublic.Thisisneeded otherwise theaccess levelwillbesetbydefaulttoprivate sootherscannotseethisItshouldbenotedthatwhencopy-and- pastingtheabovecodefromaPDFthesinglequotecharacterintheprogrammaybecomesomething else butstilllookslikeasinglequote .Thatwillcausesyntaxerrors.Replaceallthesinglequotesymbols withtheonetypedfromyourkeyboardwillthoseerrors Questions Inadditiontodescribingyourattackinfulldetails youalsoneedtoanswerthefollowing questionsinyourreport Ł Question1 TheforgedHTTPrequestneedsAlice'suserid guid toworkproperly.IfBobytargets Alice beforetheattack hecanwaystogetAlice'suserid.Bobydoesnotknow Alice's Elgg password sohecannotlogintoAlice'saccounttogettheinformation.Pleasedescribe howBobycansolvethisproblem Ł Question2 IfBobywouldliketolaunchtheattacktoanybodywhovisitshismaliciouswebpage Inthiscase hedoesnotknowwhoisvisitingthewebpagebeforehand.CanhestilllaunchtheCSRF attacktomodifythevictim's Elgg Pleaseexplain SEEDLabs 6 3.4Task4 Implementingacountermeasurefor Elgg Elgg doeshaveabuilt-incountermeasurestodefendagainsttheCSRFattack.Wehavecommentedout thecountermeasurestomaketheattackwork.CSRFisnotdiftodefendagainst andthereareseveral commonapproaches Ł Secret-tokenapproach Webapplicationscanembedasecrettokenintheirpages andallrequests comingfromthesepageswillcarrythistoken.Becausecross-siterequestscannotobtainthistoken theirforgedrequestswillbeeasilybytheserver Ł Referrerheaderapproach Webapplicationscanalsoverifytheoriginpageoftherequestusingthe referrer header.However duetoprivacyconcerns thisheaderinformationmayhavealreadybeen outattheclientside Thewebapplication Elgg usessecret-tokenapproach.Itembedstwoparameters elgg ts elgg token intherequestasacountermeasuretoCSRFattack.Thetwoparametersareaddedtothe HTTPmessagebodyforthePOSTrequestsandtotheURLstringfortheHTTPGETrequests Elgg secret-tokenandtimestampinthebodyoftherequest Elgg addssecuritytokenandtimestamp toalltheuseractionstobeperformed.ThefollowingHTMLcodeispresentinalltheformswhereuser actionisrequired.Thiscodeaddstwonewhiddenparameters elgg ts elgg token tothePOST request < inputtype= '' hidden '' name= '' __elgg_ts '' value= '' '' > < inputtype= '' hidden '' name= '' __elgg_token '' value= '' '' > The elgg ts elgg token aregeneratedbythe views/default/input/securitytoken php moduleandaddedtothewebpage.Thecodesnippetbelowshowshowitisdynamicallyaddedtothe webpage $ ts=time $ token=generate_action_token $ ts echoelgg_view 'input/hidden ' array 'name'= > '__elgg_token ' 'value'= > $ token echoelgg_view 'input/hidden ' array 'name'= > '__elgg_ts ' 'value'= > $ ts Elgg alsoaddsthesecuritytokensandtimestamptotheJavaScriptwhichcanbeaccessedby elgg.security.token.__elgg_ts elgg.security.token.__elgg_token Elgg securitytokenisahashvalue md5messagedigest ofthesitesecretvalue retrievedfrom database timestamp usersessionIDandrandomgeneratedsessionstring.Therebydefendingagainst theCSRFattack.Thecodebelowshowsthesecrettokengenerationin Elgg functiongenerate_action_token $ timestamp { $ site_secret=get_site_secret $ session_id=session_id //Sessiontoken $ st= $ _SESSION '__elgg_session ' SEEDLabs 7 $ site_secret & & $ session_id { returnmd5 $ site_secret. $ timestamp. $ session_id. $ st } returnFALSE } ThePHPfunction session id isusedtogetorsetthesessionidforthecurrentsession.Thebelow codesnippetshowsrandomgeneratedstringforagivensession elgg session apartfrompublicuser SessionID ... ... //Generateasimpletoken privatefrompotentiallypublicsessionid ! isset $ _SESSION '__elgg_session ' { $ _SESSION '__elgg_session ' = ElggCrypto :getRandomString 32 ElggCrypto :CHARS_HEX ... ... .. Elgg secret-tokenvalidation Theelggwebapplicationvalidatesthegeneratedtokenandtimestampto defendagainsttheCSRFattack.Everyuseractioncalls validate action token functionandthis functionvalidatesthetokens.Iftokensarenotpresentorinvalid theactionwillbedeniedandtheuserwill beredirected Thebelowcodesnippetshowsthefunction validate action token functionvalidate_action_token $ visibleerrors=TRUE $ token=NULL $ ts= NULL { ! $ token { $ token=get_input '__elgg_token ' } ! $ ts { $ ts=get_input '__elgg_ts ' } $ session_id=session_id $ token & & $ ts & & $ session_id { //generatetoken checkwithinputandforwardifinvalid $ required_token=generate_action_token $ ts //Validatetoken $ token== $ required_token { _elgg_validate_token_timestamp $ ts { //Wehavealreadygotthisfar sounlessanything //elsesayssomethingtothecontraryweassumewe'reok $ returnval=true ... ... } else { ... ... register_error elgg_echo 'actiongatekeeper tokeninvalid ' ... ... } ... ... } SEEDLabs 8 Turnoncountermeasure Toturnonthecountermeasure pleasegotothedirectory /var/www/CSRF/ Elgg/vendor/elgg/elgg/engine/classes/Elgg andthefunction gatekeeper inthe ActionsService.php Infunction gatekeeper pleasecommentoutthe '' returntrue '' statementasinthecodecomments publicfunctiongatekeeper $ action { //SEED ModifiedtoenableCSRF //Commentthebelowreturntruestatementtoenablecountermeasure returntrue ... ... } Task Afterturningonthecountermeasureabove trytheCSRFattackagain anddescribeyourobserva- tion.PleasepointoutthesecrettokensintheHTTPrequestcapturedusingFirefox'sHTTPinspectiontool PleaseexplainwhytheattackercannotsendthesesecrettokensintheCSRFattack whatpreventsthem fromoutthesecrettokensfromthewebpage ? 4Guidelines 4.1Usingthe '' HTTPHeaderLive '' add-ontoInspectHTTPHeaders TheversionofFirefox version60 inourUbuntu16.04VMdoesnotsupportthe LiveHTTPHeader add-on whichwasusedinourUbuntu12.04VM.Anewadd-oncalled '' HTTPHeaderLive '' isused initsplace.Theinstructiononhowtoenableandusethisadd-ontoolisdepictedinFigure1.Justclickthe iconmarkedby À asidebarwillshowupontheleft.Makesurethat HTTPHeaderLive isselected atposition Á .Thenclickanylinkinsideawebpage allthetriggeredHTTPrequestswillbecapturedand displayedinsidethesidebarareamarkedby Â .IfyouclickonanyHTTPrequest apop-upwindowwill showuptodisplaytheselectedHTTPrequest.Unfortunately thereisabuginthisadd-ontool itisstill underdevelopment nothingwillshowupinsidethepop-upwindowunlessyouchangeitssize Itseems thatre-drawingisnotautomaticallytriggeredwhenthewindowpopsup butchangingitssizewilltrigger there-drawing Figure1 EnabletheHTTPHeaderLiveAdd-on SEEDLabs 9 4.2UsingtheWebDeveloperTooltoInspectHTTPHeaders ThereisanothertoolprovidedbyFirefoxthatcanbequiteusefulininspectingHTTPheaders.Thetoolis theWebDeveloperNetworkTool.Inthissection wecoversomeoftheimportantfeaturesofthetool.The WebDeveloperNetworkToolcanbeenabledviathefollowingnavigation ClickFirefox'stoprightmenu -- > WebDeveloper -- > Network Clickthe '' Tools '' menu -- > WebDeveloper -- > Network WeusetheuserloginpageinElggasanexample.Figure2showstheNetworkToolshowingtheHTTP POSTrequestthatwasusedforlogin Figure2 HTTPRequestinWebDeveloperNetworkTool Tofurtherseethedetailsoftherequest wecanclickonaparticularHTTPrequestandthetoolwill showtheinformationintwopanes seeFigure3 Figure3 HTTPRequestandRequestDetailsinTwoPanes Thedetailsoftheselectedrequestwillbevisibleintherightpane.Figure4 showsthedetailsofthe loginrequestinthe Headers tab detailsincludeURL requestmethod andcookie .Onecanobserve bothrequestandresponseheadersintherightpane.TochecktheparametersinvolvedinanHTTPrequest wecanusethe Params tab.Figure4 b showstheparametersentintheloginrequesttoElgg including username password .ThetoolcanbeusedtoinspectHTTPGETrequestsinasimilarmannerto HTTPPOSTrequests FontSize ThedefaultfontsizeofWebDeveloperToolswindowisquitesmall.Itcanbeincreasedby focusingclickanywhereintheNetworkToolwindow andthenusing Ctrl + button SEEDLabs 10 HTTPRequestHeaders b HTTPRequestParameters Figure4 HTTPHeadersandParameters 4.3JavaScriptDebugging WemayalsoneedtodebugourJavaScriptcode.Firefox'sDeveloperToolcanalsohelpdebugJavaScript code.Itcanpointustothepreciseplaceswhereerrorsoccur.Thefollowinginstructionshowshowtoenable thisdebuggingtool Clickthe '' Tools '' menu -- > WebDeveloper -- > WebConsole orusetheShift+Ctrl+Kshortcut Onceweareinthewebconsole clickthe JS tab.Clickthedownwardpointingarrowheadbeside JS andensurethereisacheckmarkbeside Error .IfyouarealsointerestedinWarningmessages click Warning .SeeFigure5 Figure5 DebuggingJavaScriptCode 1 Ifthereareanyerrorsinthecode amessagewilldisplayintheconsole.Thelinethatcausedtheerror appearsontherightsideoftheerrormessageintheconsole.Clickonthelinenumberandyouwillbetaken totheexactplacethathastheerror.SeeFigure6 5Submission Youneedtosubmitadetailedlabreporttodescribewhatyouhavedoneandwhatyouhaveobserved PleaseprovidedetailsusingFirefox'sadd-ontools Wireshark and/orscreenshots.Youalsoneedto provideexplanationtotheobservationsthatareinterestingorsurprising SEEDLabs 11 Figure6 DebuggingJavaScriptCode 2 