SEEDLabsŒPacketandLab 1 PacketSnifandLab Copyright©2006-2016WenliangDu SyracuseUniversity ThedevelopmentofthisdocumentwaspartiallyfundedbytheNationalScienceFoundationunderAward No.1303306and1318814.ThisworkislicensedunderaCreativeCommonsAttribution-NonCommercial- ShareAlike4.0InternationalLicense.Ahuman-readablesummaryof andnotasubstitutefor thelicenseis thefollowing Youarefreetocopyandredistributethematerialinanymediumorformat.Youmustgive appropriatecredit.Ifyouremix transform orbuilduponthematerial youmustdistributeyourcontributions underthesamelicenseastheoriginal.Youmaynotusethematerialforcommercialpurposes 1Overview Packetsnifandaretwoimportantconceptsinnetworksecurity theyaretwomajorthreats innetworkcommunication.Beingabletounderstandthesetwothreatsisessentialforunderstandingse- curitymeasuresinnetworking.Therearemanypacketsnifandtools suchas Wireshark Tcpdump Netwox Scapy etc.Someofthesetoolsarewidelyusedbysecurityexperts aswellasby attackers.Beingabletousethesetoolsisimportantforstudents butwhatismoreimportantforstudentsin anetworksecuritycourseistounderstandhowthesetoolswork i.e. howpacketsnifandare implementedinsoftware Theobjectiveofthislabistwo-fold learningtousethetoolsandunderstandingthetechnologiesunder- lyingthesetools.Forthesecondobject studentswillwritesimplesnifferandprograms andgain anin-depthunderstandingofthetechnicalaspectsoftheseprograms.Thislabcoversthefollowingtopics Ł Scapy Ł Snifusingthe pcap library Ł Rawsocket Readingsandrelatedtopics DetailedcoverageofTCPattackscanbefoundinChapter12oftheSEED book ComputerSecurity AHands-onApproach byWenliangDu Labenvironment Thislabhasbeentestedonourpre-builtUbuntu16.04VM whichcanbedownloaded fromtheSEEDwebsite NoteforInstructors Therearetwosetsoftasksinthislab.Thesetfocusesonusingtoolstoconduct packetsnifandItonlyrequiresalittlebitofPythonprogramming usuallyafewlinesof code studentsdonotneedtohaveapriorPythonprogrammingbackground.Thesetoftaskscanbeused bystudentswithamuchbroaderbackground ThesecondsetoftasksisdesignedprimarilyforComputerScience/Engineeringstudents.Studentsneed towritetheirownCprogramsfromthescratchtodosnifandThisway theycangainadeeper understandingonhowsnifandtoolsactuallywork.Studentsneedtohaveasolidprogramming backgroundforthesetasks.Thetwosetsoftasksareindependent instructorscanchoosetoassignoneset orbothsetstotheirstudents dependingontheirstudents'programmingbackground 2LabTaskSet1 UsingToolstoSniffandSpoofPackets Manytoolscanbeusedtodosnifandbutmostofthemonlyprovideedfunctionalities Scapyisdifferent itcanbeusednotonlyasatool butalsoasabuildingblocktoconstructothersnif SEEDLabsŒPacketandLab 2 andtools i.e. wecanintegratetheScapyfunctionalitiesintoourownprogram.Inthissetoftasks wewilluseScapyforeachtask TouseScapy wecanwriteaPythonprogram andthenexecutethisprogramusingPython.Seethe followingexample.WeshouldrunPythonusingtherootprivilegebecausetheprivilegeisrequiredfor packets.Atthebeginningoftheprogram Line À weshouldimportallScapy'smodules $ viewmycode.py # ! /bin/bin/python fromscapy.allimport * À a=IP a.show $ sudopythonmycode.py # # # IP # # # version=4 ihl=None ... WecanalsogetintotheinteractivemodeofPythonandthenrunourprogramonelineatatimeatthe Pythonprompt.Thisismoreconvenientifweneedtochangeourcodefrequentlyinanexperiment $ sudopython > > > fromscapy.allimport * > > > a=IP > > > a.show # # # IP # # # version=4 ihl=None ... 2.1Task1.1 Packets Wiresharkisthemostpopularsniftool anditiseasytouse.Wewilluseitthroughouttheentirelab However itisdiftouseWiresharkasabuildingblocktoconstructothertools.WewilluseScapy forthatpurpose.TheobjectiveofthistaskistolearnhowtouseScapytodopacketsnifinPython programs.Asamplecodeisprovidedinthefollowing # ! /usr/bin/python fromscapy.allimport * defprint_pkt pkt pkt.show pkt=sniff filter='icmp ' prn=print_pkt Task1.1A Theaboveprogramsniffspackets.Foreachcapturedpacket thecallbackfunction print pkt willbeinvoked thisfunctionwillprintoutsomeoftheinformationaboutthepacket.Runtheprogramwith therootprivilegeanddemonstratethatyoucanindeedcapturepackets.Afterthat runtheprogramagain butwithoutusingtherootprivilege describeandexplainyourobservations SEEDLabsŒPacketandLab 3 //Runtheprogramwiththerootprivilege $ sudopythonsniffer.py //Runtheprogramwithouttherootprivilege $ pythonsniffer.py Task1.1B Usually whenwesniffpackets weareonlyinterestedcertaintypesofpackets.Wecando thatbysettinginsnifScapy'susetheBPF BerkeleyPacketFilter syntax youcanthe BPFmanualfromtheInternet.Pleasesetthefollowinganddemonstrateyoursnifferprogramagain eachshouldbesetseparately Ł CaptureonlytheICMPpacket Ł CaptureanyTCPpacketthatcomesfromaparticularIPandwithadestinationportnumber23 Ł Capturepacketscomesfromortogotoaparticularsubnet.Youcanpickanysubnet suchas 128.230.0.0/16 youshouldnotpickthesubnetthatyourVMisattachedto 2.2Task1.2 ICMPPackets Asapackettool ScapyallowsustosettheofIPpacketstoarbitraryvalues.Theobjective ofthistaskistospoofIPpacketswithanarbitrarysourceIPaddress.WewillspoofICMPechorequest packets andsendthemtoanotherVMonthesamenetwork.WewilluseWiresharktoobservewhetherour requestwillbeacceptedbythereceiver.Ifitisaccepted anechoreplypacketwillbesenttothespoofedIP address.ThefollowingcodeshowsanexampleofhowtospoofanICMPpackets > > > fromscapy.allimport * > > > a=IP À > > > a.dst='10.0.2.3' Á > > > b=ICMP Â > > > p=a/b Ã > > > send p Ä Sent1packets Inthecodeabove Line À createsanIPobjectfromtheIPclass aclassattributeisforeachIP headerWecanuse ls ls IP toseealltheattributenames/values.Wecanalsousea.show andIP.show todothesame.Line Á showshowtosetthedestinationIPaddressIfaisnotset adefaultvaluewillbeused > > > ls version BitField 4bits =4 4 ihl BitField 4bits =None None tos XByteField=0 0 len ShortField=None None id ShortField=1 1 flags FlagsField 3bits = < Flag0 > < Flag0 > frag BitField 13bits =0 0 ttl ByteField=64 64 proto ByteEnumField=0 0 chksum XShortField=None None SEEDLabsŒPacketandLab 4 src SourceIPField='127.0.0.1 ' None dst DestIPField='127.0.0.1 ' None options PacketListField= Line Â createsanICMPobject.Thedefaulttypeisechorequest.InLine Ã westack b together toformanewobject.The operatorisoverloadedbytheIPclass soitnolongerrepresentsdivision instead itmeansadding b asthepayloadof andmodifyingtheof accordingly.Asaresult wegetanewobjectthatrepresentanICMPpacket.Wecannowsendoutthispacketusing send Line Ä .Pleasemakeanynecessarychangetothesamplecode andthendemonstratethatyoucanspoofan ICMPechorequestpacketwithanarbitrarysourceIPaddress 2.3Task1.3 Traceroute TheobjectiveofthistaskistouseScapytoestimatethedistance intermsofnumberofrouters yourVMandaselecteddestination.Thisisbasicallywhatisimplementedbythe traceroute tool.In thistask wewillwriteourowntool.Theideaisquitestraightforward justsendanpacket anytype tothe destination withitsTime-To-Live TTL setto1Thispacketwillbedroppedbytherouter whichwillsendusanICMPerrormessage tellingusthatthetime-to-livehasexceeded.Thatishowweget theIPaddressoftherouter.WethenincreaseourTTLto2 sendoutanotherpacket andgetthe IPaddressofthesecondrouter.Wewillrepeatthisprocedureuntilourpacketreachthedestination Itshouldbenotedthatthisexperimentonlygetsanestimatedresult becauseintheory notallthesepackets takethesameroute butinpractice theymaywithinashortperiodoftime .Thecodeinthefollowing showsoneroundintheprocedure a=IP a.dst= ' 1.2.3.4' a.ttl=3 b=ICMP send a/b IfyouareanexperiencedPythonprogrammer youcanwriteyourtooltoperformtheentireprocedure automatically.IfyouarenewtoPythonprogramming youcandoitbymanuallychangingtheTTLin eachround andrecordtheIPaddressbasedonyourobservationfromWireshark.Eitherwayisacceptable aslongasyougettheresult 2.4Task1.4 and-then Inthistask youwillcombinethesnifandtechniquestoimplementthefollowingsniff-and- then-spoofprogram.YouneedtwoVMsonthesameLAN.FromVMA ping anIPX.Thiswill generateanICMPechorequestpacket.IfXisalive ping programwillreceiveanechoreply printouttheresponse.Yoursniff-and-then-spoofprogramrunsonVMB whichmonitorstheLANthrough packetsnifWheneveritseesanICMPechorequest regardlessofwhatthetargetIPaddressis programshouldimmediatelysendoutanechoreplyusingthepackettechnique.Therefore regard- lessofwhethermachineXisaliveornot ping programwillalwaysreceiveareply indicatingthatX isalive.YouneedtouseScapytodothistask.Inyourreport youneedtoprovideevidencetodemonstrate thatyourtechniqueworks SEEDLabsŒPacketandLab 5 3LabTaskSet2 WritingProgramstoSniffandSpoofPackets 3.1Task2.1 WritingPacketProgram Snifferprogramscanbeeasilywrittenusingthe pcap library.With pcap thetaskofsniffersbecomes invokingasimplesequenceofproceduresinthe pcap library.Attheendofthesequence packetswill beputinbufferforfurtherprocessingassoonastheyarecaptured.Allthedetailsofpacketcapturingare handledbythe pcap library TheSEEDbookﬁ ComputerSecurity AHands-onApproach ﬂprovidesasamplecodeinChapter12 showinghowtowriteasimplesnifferprogramusing pcap .Weincludethesamplecodeinthefollowing seethebookfordetailedexplanation # include < pcap.h > # include < stdio.h > * Thisfunctionwillbeinvokedbypcapforeachcapturedpacket Wecanprocesseachpacketinsidethefunction * voidgot_packet u_char * args conststructpcap_pkthdr * header constu_char * packet { printf `` Gotapacket\n '' } intmain { pcap_t * handle charerrbuf PCAP_ERRBUF_SIZE structbpf_programfp charfilter_exp = '' ipprotoicmp '' bpf_u_int32net //Step1 OpenlivepcapsessiononNICwithnameeth3 //Studentsneedstochange '' eth3 '' tothename //foundontheirownmachines usingifconfig handle=pcap_open_live `` eth3 '' BUFSIZ,1,1000 errbuf //Step2 Compilefilter_expintoBPFpsuedo-code pcap_compile handle & fp filter_exp,0 net pcap_setfilter handle & fp //Step3 Capturepackets pcap_loop handle -1 got_packet NULL pcap_close handle //Closethehandle return0 } //Note don'tforgettoadd '' -lpcap '' tothecompilationcommand //Forexample gcc-osniffsniff.c-lpcap TimCarstenshasalsowrittenatutorialonhowtouse pcap librarytowriteasnifferprogram.The tutorialisavailableat http //www.tcpdump.org/pcap.htm SEEDLabsŒPacketandLab 6 Task2.1A UnderstandingHowaSnifferWorks Inthistask studentsneedtowriteasnifferprogramto printoutthesourceanddestinationIPaddressesofeachcapturedpacket.Studentscantypeintheabovecode ordownloadthesamplecodefromtheSEEDbook'swebsite https //www.handsonsecurity net/example-code .Studentsshouldprovidescreenshotsasevidencestoshowthattheirsnifferpro- gramcanrunsuccessfullyandproducesexpectedresults.Inaddition pleaseanswerthefollowingquestions Ł Question1 Pleaseuseyourownwordstodescribethesequenceofthelibrarycallsthatareessential forsnifferprograms.Thisismeanttobeasummary notdetailedexplanationliketheoneinthe tutorialorbook Ł Question2 Whydoyouneedtherootprivilegetorunasnifferprogram ? Wheredoestheprogram failifitisexecutedwithouttherootprivilege ? Ł Quesiton3 Pleaseturnonandturnoffthepromiscuousmodeinyoursnifferprogram.Canyou demonstratethedifferencewhenthismodeisonandoff ? Pleasedescribehowyoucandemonstrate Task2.1B WritingFilters Pleasewriteexpressionsforyoursnifferprogramtocaptureeachof thefollowings.Youcanonlinemanualsfor pcap Inyourlabreports youneedtoinclude screenshotstoshowtheresultsafterapplyingeachofthese Ł CapturetheICMPpacketsbetweentwohosts Ł CapturetheTCPpacketswithadestinationportnumberintherangefrom10to100 Task2.1C Passwords Pleaseshowhowyoucanuseyoursnifferprogramtocapturethepass- wordwhensomebodyisusing telnet onthenetworkthatyouaremonitoring.Youmayneedtomodify yoursniffercodetoprintoutthedatapartofacapturedTCPpacket telnet usesTCP .Itisacceptableif youprintouttheentiredatapart andthenmanuallymarkwherethepassword orpartofit 3.2Task2.2 Whenanormalusersendsoutapacket operatingsystemsusuallydonotallowtheusertosetallthe intheprotocolheaders suchasTCP UDP andIPheaders .OSeswillsetmostofthewhile onlyallowinguserstosetafewsuchasthedestinationIPaddress thedestinationportnumber etc However ifusershavetherootprivilege theycansetanyarbitraryinthepacketheaders.Thisiscalled packetanditcanbedonethrough rawsockets Rawsocketsgiveprogrammerstheabsolutecontroloverthepacketconstruction allowingprogrammers toconstructanyarbitrarypacket includingsettingtheheaderandthepayload.Usingrawsocketsis quitestraightforward itinvolvesfoursteps 1 createarawsocket 2 setsocketoption 3 constructthe packet 4 sendoutthepacketthroughtherawsocket.Therearemanyonlinetutorialsthatcanteach youhowtouserawsocketsinCprogramming.Wehavelinkedsometutorialstothelab'swebpage.Please readthem andlearnhowtowriteapacketprogram.Weshowasimpleskeletonofsuchaprogram intsd structsockaddr_insin charbuffer 1024 //Youcanchangethebuffersize * CreatearawsocketwithIPprotocol.TheIPPROTO_RAWparameter * tellsthesytemthattheIPheaderisalreadyincluded SEEDLabsŒPacketandLab 7 * thispreventstheOSfromaddinganotherIPheader * sd=socket AF_INET SOCK_RAW IPPROTO_RAW sd < 0 { perror `` socket error '' exit -1 } * Thisdatastructureisneededwhensendingthepackets * usingsockets.Normally weneedtofilloutseveral * fields butforrawsockets weonlyneedtofillout * thisonefield * sin.sin_family=AF_INET //HereyoucanconstructtheIPpacketusingbuffer //-constructtheIPheader ... //-constructtheTCP/UDP/ICMPheader ... //-fillinthedatapartifneeded ... //Note youshouldpayattentiontothenetwork/hostbyteorder * SendouttheIPpacket * ip_lenistheactualsizeofthepacket * sendto sd buffer ip_len,0 structsockaddr * & sin sizeof sin < 0 { perror `` sendto error '' exit -1 } Task2.2A Writeaprogram PleasewriteyourownpacketprograminC.Youneedto provideevidences e.g. Wiresharkpackettrace toshowthatyourprogramsuccessfullysendsoutspoofed IPpackets Task2.2B SpoofanICMPEchoRequest SpoofanICMPechorequestpacketonbehalfofanother machine i.e. usinganothermachine'sIPaddressasitssourceIPaddress .Thispacketshouldbesenttoa remotemachineontheInternet themachinemustbealive .YoushouldturnonyourWireshark soifyour issuccessful youcanseetheechoreplycomingbackfromtheremotemachine Questions Pleaseanswerthefollowingquestions Ł Question4 CanyousettheIPpacketlengthtoanarbitraryvalue regardlessofhowbigthe actualpacketis ? Ł Question5 Usingtherawsocketprogramming doyouhavetocalculatethechecksumfortheIP header ? Ł Question6 Whydoyouneedtherootprivilegetoruntheprogramsthatuserawsockets ? Where doestheprogramfailifexecutedwithouttherootprivilege ? 3.3Task2.3 SniffandthenSpoof Inthistask youwillcombinethesnifandtechniquestoimplementthefollowingsniff-and- then-spoofprogram.YouneedtwoVMsonthesameLAN.FromVMA ping anIPX.Thiswill SEEDLabsŒPacketandLab 8 generateanICMPechorequestpacket.IfXisalive ping programwillreceiveanechoreply printouttheresponse.Yoursniff-and-then-spoofprogramrunsonVMB whichmonitorstheLANthrough packetsnifWheneveritseesanICMPechorequest regardlessofwhatthetargetIPaddressis programshouldimmediatelysendoutanechoreplyusingthepackettechnique.Therefore regard- lessofwhethermachineXisaliveornot ping programwillalwaysreceiveareply indicatingthatX isalive.YouneedtowritesuchaprograminC andincludescreenshotsinyourreporttoshowthatyour programworks.Pleasealsoattachthecode withadequateamountofcomments inyourreport 4Guidelines 4.1FillinginDatainRawPackets Whenyousendoutapacketusingrawsockets youbasicallyconstructthepacketinsideabuffer sowhen youneedtosenditout yousimplygivetheoperatingsystemthebufferandthesizeofthepacket.Working directlyonthebufferisnoteasy soacommonwayistotypecastthebuffer orpartofthebuffer structures suchasIPheaderstructure soyoucanrefertotheelementsofthebufferusingtheof thosestructures.YoucantheIP ICMP TCP UDPandotherheaderstructuresinyourprogram.The followingexampleshowhowyoucanconstructanUDPpacket structipheader { typefield ... .. } structudpheader { typefield ... ... } //Thisbufferwillbeusedtoconstructrawpacket charbuffer 1024 //TypecastingthebuffertotheIPheaderstructure structipheader * ip= structipheader * buffer //TypecastingthebuffertotheUDPheaderstructure structudpheader * udp= structudpheader * buffer +sizeof structipheader //AssignvaluetotheIPandUDPheaderfields ip- > field= ... udp- > field= ... 4.2Network/HostByteOrderandtheConversions Youneedtopayattentiontothenetworkandhostbyteorders.Ifyouusex86CPU yourhostbyteorder uses LittleEndian whilethenetworkbyteorderuses BigEndian .Whateverthedatayouputintothepacket bufferhastousethenetworkbyteorder ifyoudonotdothat yourpacketwillnotbecorrect.Youactually donotneedtoworryaboutwhatkindofEndianyourmachineisusing andyouactuallyshouldnotworry aboutifyouwantyourprogramtobeportable SEEDLabsŒPacketandLab 9 Whatyouneedtodoistoalwaysremembertoconvertyourdatatothenetworkbyteorderwhenyou placethedataintothebuffer andconvertthemtothehostbyteorderwhenyoucopythedatafromthebuffer toadatastructureonyourcomputer.Ifthedataisasinglebyte youdonotneedtoworryabouttheorder butifthedataisa short int long oradatatypethatconsistsofmorethanonebyte youneedtocall oneofthefollowingfunctionstoconvertthedata htonl convertunsignedintfromhosttonetworkbyteorder ntohl reverseofhtonl htons convertunsignedshortintfromhosttonetworkbyteorder ntohs reverseofhtons Youmayalsoneedtouse inet addr inet network inet ntoa inet aton convertIPaddressesfromthedotteddecimalform astring toa32-bitintegerofnetwork/hostbyteorder YoucangettheirmanualsfromtheInternet 5Submission Studentsneedtosubmitadetailedlabreporttodescribewhattheyhavedone whattheyhaveobserved howtheyinterprettheresults.Reportsshouldincludeevidencestosupporttheobservations.Evidencesin- cludepackettraces screenshots etc.Reportsshouldalsolisttheimportantcodesnippetswithexplanations Simplyattachingcodewithoutanyexplanationwillnotreceivecredits 