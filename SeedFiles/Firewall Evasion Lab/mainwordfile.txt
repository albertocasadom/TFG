SEEDLabsŒFirewallEvasionLab 1 FirewallEvasionLab BypassingFirewallsusingVPN Copyright©2018WenliangDu SyracuseUniversity ThedevelopmentofthisdocumentwaspartiallyfundedbytheNationalScienceFoundationunderAward No.1303306and1718086.ThisworkislicensedunderaCreativeCommonsAttribution-NonCommercial- ShareAlike4.0InternationalLicense.Ahuman-readablesummaryof andnotasubstitutefor thelicenseis thefollowing Youarefreetocopyandredistributethematerialinanymediumorformat.Youmustgive appropriatecredit.Ifyouremix transform orbuilduponthematerial youmustdistributeyourcontributions underthesamelicenseastheoriginal.Youmaynotusethematerialforcommercialpurposes 1Overview Organizations InternetServiceProviders ISPs andcountriesoftenblocktheirinternalusersfromaccess- ingcertainexternalsites.ThisiscalledegressForexample topreventwork-timedistraction many companiessetuptheiregresswallstoblocksocialnetworksites sotheiremployeecannotaccessthose sitesfrominsidetheirnetwork.Forpoliticalreasons manycountriessetupegressattheirISPs toblocktheirpeoplefromaccessingselectedforeignwebsites.Unfortunately thesewallscanbeeasily bypassed andservices/productsthathelpusersbypasswallsarewidelyavailableontheInternet.The mostcommonlyusedtechnologytobypassegresswallsisVirtualPrivateNetwork VPN .Inparticular thistechnologyiswidelyusedbysmartphoneusersthatareaffectedbyegresstherearemanyVPN apps forAndroid iOS andotherplatforms thatcanhelpusersbypassegresswalls ThelearningobjectiveofthislabisforstudentstoseehowVPNworksinactionandhowVPNcanhelp bypassegresswalls.WewillimplementaverysimpleVPNinthislab anduseittobypasswalls.A typicalVPNdependsontwopiecesoftechnologies IPtunnelingandencryption.Thetunnelingtechnology isthemostessentialonetohelpbypasswalls theencryptiontechnologyisforprotectingthecontentof thetrafthatgoesthroughtheVPNtunnel.Forthesakeofsimplicity wewillonlyfocusonthetunneling part sothetrafinsideourtunnelisnotencrypted.WehaveaseparateVPNlab whichcoversboth tunnelingandencryption.Ifreadersareinterested theycanworkonourVPNlabtolearnhowtobuilda completeVPN.Inthislab weonlyfocusonhowtouseVPNtunneltobypasswalls.Thislabcoversthe followingtopics Ł Firewall Ł VPN Readingsandrelatedtopics Detailedcoverageofwallsandwallevasiontechniquescanbefound inChapter14oftheSEEDbook ComputerSecurity AHands-onApproach byWenliangDu.Arelatedlab istheFirewallExplorationlab whichshowshowwallsworkandhowtouseSSHtunnelingtobypass walls Labenvironment Thislabhasbeentestedonourpre-builtUbuntu16.04VM whichcanbedownloaded fromtheSEEDwebsite SEEDLabsŒFirewallEvasionLab 2 2LabTasks 2.1Task1 VMSetup Weneedtwomachines oneinsidethewall andtheotheroutsidethewall.Theobjectiveistohelp themachineinsidethewalltoreachouttotheexternalsitesblockedbythewall.Weusetwovirtual machines VM1andVM2 forthesetwomachines.VM1andVM2aresupposedtobetwomachines connectedviatheInternetthroughrouters.ThissetupmayrequiremorethantwoVMs.Forthesakeof simplicity weuseaLANtoemulatetheInternetconnection.Basically wesimplyconnectVM1andVM2 toaLANusingthe NATNetwork adapter.Figure1depictsthelabsetup Figure1 LabEnvironmentSetup 2.2Task2 SetupFirewall Inthistask youwillsetupawallonVM1toblocktheaccessofatargetwebsite.Youneedtomake surethattheIPaddressofthetargetwebsiteiseitheredorinaedrange otherwise youmayhave troublecompletelyblockingthiswebsite.PleaserefertotheFirewallLabfordetailsabouthowtoblocking websites Intherealworld thewallshouldrunonaseparatemachine notonVM1.Tominimizethenumber ofVMsusedinthislab weputthewallonVM1.SettingupthewallonVM1requiresthesuperuser privilege andsodoesthesetupoftheVPNtunnel.Onemayimmediatelysaythatifwealreadyhavethe superuserprivilege whycannotwejustsimplydisablethewallonVM1.Thisisagoodargument keepinmind weputthewallonVM1simplybecausewedonotwanttocreateanotherVMinthelab environment.Therefore althoughyouhavethesuperuserprivilegeonVM1 youarenotallowedtousethe privilegetothewall.YouhavetouseVPNtobypassit Comparedtoputtingthewallonanexternalmachine puttingthewallonVM1doeshaveasmall issuethatweneedtodealwith.Whenwesetupthewalltoblockpackets weneedtomakesurenotto blockthepacketsfromgettingtothevirtualinterfaceusedbytheVPN orevenourVPNwillnotbeableto getthepackets.Therefore wecannotsetthewallrulebeforetherouting norcanwesetthewallrule onthevirtualinterface.WejustneedtosettheruleonVM1'srealnetworkinterface soitwillnotaffectthe packetsthatgotothevirtualinterface Wecanusethe ufw programtosetupwallrules.Thisprogramisafront-endofthe iptables program.Onecandirectlyuse iptables butforthisexperiment itismoreconvenienttouse ufw $ sudoufwenable $ sudoufwdenyoutoneth12to128.230.210.0/24 SEEDLabsŒFirewallEvasionLab 3 $ sudoufwstatus Status active ToActionFrom -- -- -- -- -- -- 128.230.210.0/24DENYOUTAnywhereoneth12 Pleaseidentifyawebsitethatyouwouldliketoblock setupthewall andthendemonstratethatyour wallisworkingandthetargetIPaddressisnolongerreachable.Providescreenshotsinyourlabreport 2.3Task3 BypassingFirewallusingVPN TheideaofusingVPNtobypasswallisdepictedinFigure2.WeestablishaVPNtunnelbetweenVM1 VPNClientVM andVM2 VPNServerVM .WhenauseronVM1triestoaccessablockedsite trafwillnotdirectlygothroughitsnetworkadapter becauseitwillbeblocked.Instead thepacketsto theblockedsitefromVM1willberoutedtotheVPNtunnelandarriveatVM2.Oncetheyarrivethere VM2willroutethemtothedestination.Whenthereplypacketscomeback itwillcomebacktoVM2 whichwillthenredirectthepacketstotheVPNtunnel andeventuallygetthepacketbacktoVM1.Thatis howtheVPNhelpsVM1tobypasswalls Figure2 BypassingwallusingVPN WehavecreatedasampleVPNprogram includingaclientprogram vpnclient andaserverpro- gram vpnserver bothofwhichcanbedownloadedfromthislab'swebsite.ThissimpleVPNprogram onlyestablishesaVPNtunnelbetweentheclientandserver itdoesnotencryptthetunneltrafThe programisexplainedindetailinChapter16oftheSEEDbooktitled ComputerSecurity AHands-on Approach thechapteralsoexplainshowTUN/TAPworksandhowtouseittocreateVPN The vpnclient vpnserver programsarethetwoendsofaVPNtunnel.Theycommunicate witheachotherusingeitherTCPorUDPviathesocketsdepictedinFigure3.Inoursamplecode choosetouseUDPforthesakeofsimplicity.Thedottedlinebetweentheclientandserverdepictsthepath fortheVPNtunnel.TheVPNclientandserverprogramsconnecttothehostingsystemviaaTUNinterface throughwhichtheydotwothings 1 getIPpacketsfromthehostingsystem sothepacketscanbesent throughthetunnel 2 getIPpacketsfromthetunnel andthenforwardittothehostingsystem whichwill SEEDLabsŒFirewallEvasionLab 4 Figure3 VPNclientandserver forwardthepackettoitsdestination.ThefollowingproceduredescribeshowtocreateaVPNtunnel usingthe vpnclient vpnserver programs Step1 RunVPNServer WeruntheVPNserverprogram vpnserver ontheServerVM.Af- tertheprogramruns avirtualTUNnetworkinterfacewillappearinthesystem wecanseeitusingthe '' ifconfig-a '' command thenameoftheinterfacewillbe tun0 inmostcases buttheycanbe tunX X isanumber .ThisnewinterfaceisnotyetsoweneedtoitbygivingitanIP address.Weuse 192.168.53.1 forthisinterface butyoucanuseotherIPaddresses Runthefollowingcommands.Thecommandwillstarttheserverprogram andthesecondcommand assignsanIPaddresstothe tun0 interfaceandthenactivatesit.Itshouldbenotedthatthecommand willblockandwaitforconnections soweneedtoanotherwindowrunthesecondcommand $ sudo./vpnserver Runthefollowingcommandinanotherwindow $ sudoifconfigtun0192.168.53.1/24up Unlessacomputerwillonlyactasahost notasagateway.TheVPNServer needstoforwardpacketstootherdestinations soitneedstofunctionasagateway.Weneedtoenablethe IPforwardingforacomputertobehavelikeagateway.IPforwardingcanbeenabledusingthefollowing command $ sudosysctlnet.ipv4.ip_forward=1 Step2 RunVPNClient WenowruntheVPNclientprogramontheClientVM.Werunthefollow- ingcommandonthismachine thecommandwillconnecttotheVPNserverprogramrunningon 10.0.2.8 .Thiscommandwillblockaswell soweneedtoanotherwindowtothe tun0 interfacecreatedbytheVPNclientprogram.WeassignIPaddress 192.168.53.5 tothe tun0 inter- face youcanchooseotherIPaddresses OnVPNClientVM SEEDLabsŒFirewallEvasionLab 5 $ sudo./vpnclient10.0.2.8 Runthefollowingcommandinadifferentwindow $ sudoifconfigtun0192.168.53.5/24up Step3 SetUpRoutingonClientandServerVMs Aftertheabovetwosteps thetunnelwillbeestab- lished.Beforewecanusethetunnel weneedtosetuproutingpathsonbothclientandservermachinesto directtheintendedtrafthroughthetunnel.Wecanusethe route commandtoaddanroutingentry.The followingexampleshowshowtoroutethe 10.20.30.0/24 -boundpacketstotheinterface eth0 $ sudorouteadd-net10.20.30.0/24eth0 TobypasswallsontheClientVM youneedtosetuproutingentriesaccordingly sothetrafto theblockedsitewillberoutedtowardstheVPN.Youneedtothinkaboutwhatroutingentriestoaddinorder tobypassthewall Step4 SetUpNATonServerVM Whenthedestinationsendspacketsbacktousers thepacket willbesenttotheVPNServer thinkaboutwhyandwritedownyouranswerinthereport .Thereturn packetwillreachtheVPNServer'sNATadapter becausethesourceIPsofalltheoutgoingpackets fromtheServerVMarechangedtotheNAT'sexternalIPaddress whichisbasicallythehostcomputer's IPaddressinoursetup .Usually theNATwillreplacethedestinationIPaddresswiththeIPaddressof theoriginalpacket i.e 192.168.53.5 inourcase andgiveitbacktowhoeverownstheIPaddress Unfortunately wehaveaproblemhere BeforetheNATsendsoutthepacket itneedstoknowtheMACaddressofthemachinewhoowns 192.168.53.5 soitsendsanARPrequest.Ourprivatenetworkisvirtual andthisIPaddressbelongsto tun0 interfaceontheVPNClient.therefore 192.168.53.5 willnotreceivetheARPrequest even ifitdoes ithasnouse .TheNATwillthendropthepacket becausetherecipientdoesnotexist TheactualrecipientshouldbetheVPNServerVM eventhoughitdoesnotowntheIPaddress 192.168.53.5 IfwecantheNATasagateway wecanasktheNATtoroutethepacketsfor 192.168.53.5 totheVPNServer whichwilleventuallydeliverthepacketsthroughthetunneltotheVPNClient.How- ever wehavenotouthowtotheNATasagatewayinVirtualBox wedidcomeuptwo work-aroundsolutions.OneideaistoﬁfoolﬂtheNATtobelievethattheMACaddressof 192.168.53.5 istheVPNServerVM'sMACaddress sothepacketwillbedeliveredtotheVPNServerbytheNAT.We canachievethisusinganARPcachepoisoningontheNAT basicallytellingtheNATbeforehandaboutthe MACaddressof 192.168.53.5 AbettersolutiontogetroundthelimitationoftheNATistocreateanotherNATrightontheServerVM soallpacketscomingoutoftheServerVMwillhavethisVM'sIPaddressastheirsourceIP.Toreachthe Internet thesepacketswillgothroughanotherNAT whichisprovidedbyVirtualBox butsincethesource IPistheServerVM thissecondNATwillhavenoproblemrelayingbackthereturnedpacketsfromthe InternettotheServerVM.Usingthissolution wedonotneedtouseARPcachepoisoningtoﬁfoolﬂthe NATanymore.ThefollowingcommandscanenabletheNATontheServerVM inyourcase thenameof NATNetwork adaptermaynotbecalled eth8 youjustneedtoitsrealnameonyourVM Cleanalliptablesrules $ sudoiptables-F $ sudoiptables-tnat-F AddaruleonpostroutingpositiontotheNatNetworkadapter eth8 SEEDLabsŒFirewallEvasionLab 6 connectedtoVPNserver $ sudoiptables-tnat-APOSTROUTING-jMASQUERADE-oeth8 Demonstration Ifyouhavedonethestepsabovecorrectly youshouldbeabletobypassthewall.You shouldshowthatyoucanreachtheblockedwebsitefromClientVMviatheVPN.Yoursolutionshouldnot onlyworkforwebtrafbutalsoforallothertrafForexample iftheblockedmachinerunsa telnet server youshouldbeableto telnet tothisblockedserverfromClientVM Inyourlabreport youshouldprovidetheevidencetoshowthatyourtrafdidgothroughtheVPN tunnel notthroughsomeﬁsidedoorsﬂ.Thebestwaytoshowthatistocapturethenetworktrafusing Wireshark anddescribethepathofyourpacketsusingthecapturedtrafWithoutsuchanevidence havenoideawhetheryoursuccessisduetoawall i.e.thetargetedwebsiteisnot blockedatall orduetoyourVPN 3SubmissionRequirement YoushouldsubmitadetailedlabreporttodescribehowyousetupyourVPNtobypasswalls.You shouldprovidesufevidencestoconvinceusthatyourtechniqueworks.Wewillnottakeyourwords forit wemustseeyourevidences.Ifyourevidencesarenotconvincing wewillnotgiveyourthecredits 