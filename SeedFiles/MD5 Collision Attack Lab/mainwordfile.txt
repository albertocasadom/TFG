SEEDLabsŒMD5CollisionAttackLab 1 MD5CollisionAttackLab Copyright©2018WenliangDu SyracuseUniversity ThisworkislicensedunderaCreativeCommonsAttribution-NonCommercial-ShareAlike4.0International License.Ahuman-readablesummaryof andnotasubstitutefor thelicenseisthefollowing Youarefreeto copyandredistributethematerialinanymediumorformat.Youmustgiveappropriatecredit.Ifyouremix transform orbuilduponthematerial youmustdistributeyourcontributionsunderthesamelicenseasthe original.Youmaynotusethematerialforcommercialpurposes 1Introduction Asecureone-wayhashfunctionneedstosatisfytwoproperties theone-waypropertyandthecollision- resistanceproperty.Theone-waypropertyensuresthatgivenahashvalue h itiscomputationallyinfeasible toaninput M suchthat hash M =h .Thecollision-resistancepropertyensuresthatitiscompu- tationallyinfeasibletotwodifferentinputs M 1 M 2 suchthat hash M 1 =hash M 2 Severalwidely-usedone-wayhashfunctionshavetroublemaintainingthecollision-resistanceprop- erty.AttherumpsessionofCRYPTO2004 XiaoyunWangandco-authorsdemonstratedacollisionattack againstMD5 1 .InFebruary2017 CWIAmsterdamandGoogleResearchannouncedthe SHAttered at- tack whichbreaksthecollision-resistancepropertyofSHA-1 3 .Whilemanystudentsdonothavetrouble understandingtheimportanceoftheone-wayproperty theycannoteasilygraspwhythecollision-resistance propertyisnecessary andwhatimpacttheseattackscancause Thelearningobjective ofthislabisforstudentstoreallyunderstandtheimpactofcollisionattacks seeinhandwhatdamagescanbecausedifawidely-usedone-wayhashfunction'scollision-resistance propertyisbroken.Toachievethisgoal studentsneedtolaunchactualcollisionattacksagainsttheMD5 hashfunction.Usingtheattacks studentsshouldbeabletocreatetwodifferentprogramsthatsharethe sameMD5hashbuthavecompletelydifferentbehaviors.Thislabcoversanumberoftopicsdescribedin thefollowing Ł One-wayhashfunction Ł Thecollision-resistanceproperty Ł Collisionattacks Ł MD5 LabEnvironment Thislabhasbeentestedonourpre-built Ubuntu12.04 Ubuntu16.04 VMs bothofwhichcanbedownloadedfromtheSEEDwebsite.ThelabusesatoolcalledﬁFastMD5Collision Generationﬂ whichwaswrittenbyMarcStevens thenameofthebinaryiscalled md5collgen inour VMs Ł For Ubuntu16.04 VM md5collgen hasalreadybeeninstalledinside /home/seed/bin Ł For Ubuntu12.04 VM youneedtodownloadazip md5 patch.zip fromthislab'sweb page andrunasimpleshellscript patch.sh toinstallthe md5collgen program Ł Ifyouareinterestedininstallingthetooltoyourownmachine youcandownloadthesourcecode directlyfrom https //www.win.tue.nl/hashclash/ Acknowledgment ThislabwasdevelopedwiththehelpofVishtaspJokhi agraduatestudentintheDe- partmentofElectricalEngineeringandComputerScienceatSyracuseUniversity SEEDLabsŒMD5CollisionAttackLab 2 2LabTasks 2.1Task1 GeneratingTwoDifferentFileswiththeSameMD5Hash Inthistask wewillgeneratetwodifferentwiththesameMD5hashvalues.Thebeginningpartsofthese twoneedtobethesame i.e. theysharethesameWecanachievethisusingthe md5collgen program whichallowsustoprovideawithanyarbitrarycontent.Thewayhowtheprogramworks isillustratedinFigure1.Thefollowingcommandgeneratestwooutput out1.bin out2.bin foragivena prefix.txt $ md5collgen-pprefix.txt-oout1.binout2.bin Figure1 MD5collisiongenerationfroma Wecancheckwhethertheoutputaredistinctornotusingthe diff command.Wecanalsousethe md5sum commandtochecktheMD5hashofeachoutputSeethefollowingcommands $ diffout1.binout2.bin $ md5sumout1.bin $ md5sumout2.bin Since out1.bin out2.bin arebinary wecannotviewthemusingatext-viewerprogram cat weneedtouseabinaryeditortoview andedit them.Wehavealreadyinstalledahex editorsoftwarecalled bless inourVM.Pleaseusesuchaneditortoviewthesetwooutputand describeyourobservations.Inaddition youshouldanswerthefollowingquestions Œ Question1 Ifthelengthofyourisnotmultipleof64 whatisgoingtohappen ? Œ Question2 Createawithexactly64bytes andrunthecollisiontoolagain andseewhat happens Œ Question3 Arethedata 128bytes generatedby md5collgen completelydifferentforthetwo outputPleaseidentifyallthebytesthataredifferent 2.2Task2 UnderstandingMD5'sProperty Inthistask wewilltrytounderstandsomeofthepropertiesoftheMD5algorithm.Thesepropertiesare importantforustoconductfurthertasksinthislab.MD5isaquitecomplicatedalgorithm butfromvery highlevel itisnotsocomplicated.AsFigure2shows MD5dividestheinputdataintoblocksof64bytes andthencomputesthehashiterativelyontheseblocks.ThecoreoftheMD5algorithmisacompression function whichtakestwoinputs a64-bytedatablockandtheoutcomeofthepreviousiteration.The compressionfunctionproducesa128-bitIHV whichstandsforﬁIntermediateHashValueﬂ thisoutputis thenfedintothenextiteration.Ifthecurrentiterationisthelastone theIHVwillbethehashvalue TheIHVinputfortheiteration IHV 0 isaedvalue SEEDLabsŒMD5CollisionAttackLab 3 Figure2 HowtheMD5algorithmworks BasedonhowMD5works wecanderivethefollowingpropertyoftheMD5algorithm Giventwo inputs M N MD5 M =MD5 N i.e. theMD5hashesof M N arethesame thenforanyinput T MD5 M k T =MD5 N k T k representsconcatenation Thatis ifinputs M N havethesamehash addingthesamesuf T tothemwillresultintwooutputs thathavethesamehashvalue.ThispropertyholdsnotonlyfortheMD5hashalgorithm butalsoformany otherhashalgorithms.Yourjobinthistask istodesignanexperimenttodemonstratesthatthisproperty holdsforMD5 Youcanusethe cat commandtoconcatenatetwo binaryortextintoone.Thefollowing commandconcatenatesthecontentsof file2 tothecontentsof file1 andplacestheresultin file3 $ catfile1file2 > file3 2.3Task3 GeneratingTwoExecutableFileswiththeSameMD5Hash Inthistask youaregiventhefollowingCprogram.Yourjobistocreatetwodifferentversionsofthis program suchthatthecontentsoftheir xyz arraysaredifferent butthehashvaluesoftheexecutablesare thesame # include < stdio.h > unsignedcharxyz 200 = { * Theactualcontentsofthisarrayareuptoyou * } intmain { inti i=0 < 200 i++ { printf `` % x '' xyz } printf `` \n '' } Youmaychoosetoworkatthesourcecodelevel i.e. generatingtwoversionsoftheaboveCprogram suchthataftercompilation theircorrespondingexecutablehavethesameMD5hashvalue.However itmaybeeasiertodirectlyworkonthebinarylevel.Youcanputsomerandomvaluesinthe xyz array compiletheabovecodetobinary.Thenyoucanuseahexeditortooltomodifythecontentofthe xyz array directlyinthebinary Findingwherethecontentsofthearrayarestoredinthebinaryisnoteasy.However ifwethearray withsomeedvalues wecaneasilytheminthebinary.Forexample thefollowingcodethearray 0x41 whichistheASCIIvalueforletter A .Itwillnotbediftolocate200 A 'sinthebinary SEEDLabsŒMD5CollisionAttackLab 4 unsignedcharxyz 200 = { 0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x41 0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x41 0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x41 ... omitted ... 0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x41 } Guidelines Frominsidethearray wecantwolocations fromwherewecandividetheexecutable intothreeparts aa128-byteregion andasufThelengthoftheneedstobemultiple of64bytes.SeeFigure3foranillustrationofhowtheisdivided Figure3 Breaktheexecutableintothreepieces Wecanrun md5collgen onthetogeneratetwooutputsthathavethesameMD5hashvalue Letususe P Q torepresentthesecondpart eachhaving128bytes oftheseoutputs i.e. thepartafter theTherefore wehavethefollowing MD5 prefix k P =MD5 prefix k Q BasedonthepropertyofMD5 weknowthatifweappendthesamesuftotheabovetwooutputs resultantdatawillalsohavethesamehashvalue.Basically thefollowingistrueforanysuf MD5 prefix k P k suffix =MD5 prefix k Q k suffix Therefore wejustneedtouse P Q toreplace128bytesofthearray betweenthetwodividing points andwewillbeabletocreatetwobinaryprogramsthathavethesamehashvalue.Theiroutcomes aredifferent becausetheyeachprintouttheirownarrays whichhavedifferentcontents Tools Youcanuse bless toviewthebinaryexecutableandthelocationforthearray.For dividingabinarytherearesometoolsthatwecanusetodivideafromaparticularlocation.The head tail commandsaresuchusefultools.Youcanlookattheirmanualstolearnhowtousethem Wegivethreeexamplesinthefollowing $ head-c3200a.out > prefix $ tail-c100a.out > suffix $ tail-c+3300a.out > suffix Thecommandabovesavesthe 3200 bytesof a.out prefix .Thesecondcommandsaves thelast 100 bytesof a.out suffix .Thethirdcommandsavesthedatafromthe 3300 thbytetothe SEEDLabsŒMD5CollisionAttackLab 5 endofthe a.out suffix .Withthesetwocommands wecandivideabinaryintopiecesfrom anylocation.Ifweneedtogluesomepiecestogether wecanusethe cat command Ifyouuse bless tocopy-and-pasteablockofdatafromonebinarytoanotherthemenuitem '' Edit- > SelectRange '' isquitehandy becauseyoucanselectablockofdatausingastartingpoint andarange insteadofmanuallycountinghowmanybytesareselected 2.4Task4 MakingtheTwoProgramsBehaveDifferently Intheprevioustask wehavesuccessfullycreatedtwoprogramsthathavethesameMD5hash buttheir behaviorsaredifferent.However theirdifferencesareonlyinthedatatheyprintout theystillexecutethe samesequenceofinstructions.Inthistask wewouldliketoachievesomethingmoreandmore meaningful Assumethatyouhavecreatedasoftwarewhichdoesgoodthings.Yousendthesoftwaretoatrusted authoritytogetTheauthorityconductsacomprehensivetestingofyoursoftware andconcludes thatyoursoftwareisindeeddoinggoodthings.Theauthoritywillpresentyouwithastatingthat yourprogramisgood.TopreventyoufromchangingyourprogramaftergettingthetheMD5 hashvalueofyourprogramisalsoincludedinthe theissignedbytheauthority youcannotchangeanythingontheoryourprogramwithoutrenderingthesignatureinvalid Youwouldliketogetyourmalicioussoftwarebytheauthority butyouhavezerochanceto achievethatgoalifyousimplysendyourmalicioussoftwaretotheauthority.However youhavenoticed thattheauthorityusesMD5togeneratethehashvalue.Yougotanidea.Youplantopreparetwodifferent programs.Oneprogramwillalwaysexecutebenigninstructionsanddogoodthings whiletheotherprogram willexecutemaliciousinstructionsandcausedamages.Youawaytogetthesetwoprogramstoshare thesameMD5hashvalue YouthensendthebenignversiontotheauthorityforSincethisversiondoesgoodthings willpasstheandyouwillgetathatcontainsthehashvalueofyourbenignprogram Becauseyourmaliciousprogramhasthesamehashvalue thisisalsovalidforyourmalicious program.Therefore youhavesuccessfullyobtainedavalidforyourmaliciousprogram.Ifother peopletrustedtheissuedbytheauthority theywilldownloadyourmaliciousprogram Theobjectiveofthistask istolaunchtheattackdescribedabove.Namely youneedtocreatetwopro- gramsthatsharethesameMD5hash.However oneprogramwillalwaysexecutebenigninstructions theotherprogramwillexecutemaliciousinstructions.Inyourwork whatbenign/maliciousinstructionsare executedisnotimportant itissuftodemonstratethattheinstructionsexecutedbythesetwoprograms aredifferent Guidelines CreatingtwocompletelydifferentprogramsthatproducethesameMD5hashvalueisquite hard.Thetwohash-collidingprogramsproducedby md5collgen needtosharethesamemoreover aswecanseefromtheprevioustask ifweneedtoaddsomemeaningfulsuftotheoutputsproducedby md5collgen thesufaddedtobothprogramsalsoneedstobethesame.Thesearethelimitationsof theMD5collisiongenerationprogramthatweuse.Althoughthereareothermorecomplicatedandmore advancedtoolsthatcanliftsomeofthelimitations suchasacceptingtwodifferentes 2 theydemand muchmorecomputingpower sotheyareoutofthescopeforthislab.Weneedtoawaytogenerate twodifferentprogramswithinthelimitations Therearemanywaystoachievetheabovegoal.Weprovideoneapproachasareference butstudents areencouragedtocomeuptheirownideas.Instructorsmayconsiderrewardingstudentsfortheirown ideas.Inourapproach wecreatetwoarrays X Y .Wecomparethecontentsofthesetwoarrays ifthey SEEDLabsŒMD5CollisionAttackLab 6 arethesame thebenigncodeisexecuted otherwise themaliciouscodeisexecuted.Seethefollowing pseudo-code ArrayX ArrayY main { X'scontentsandY'scontentsarethesame runbenigncode else runmaliciouscode return } Wecaninitializethearrays X Y withsomevaluesthatcanhelpustheirlocationsintheexe- cutablebinaryOurjobistochangethecontentsofthesetwoarrays sowecangeneratetwodifferent versionsthathavethesameMD5hash.Inoneversion thecontentsofXandYarethesame sothebenign codeisexecuted intheotherversion thecontentsofXandYaredifferent sothemaliciouscodeisexe- cuted.WecanachievethisgoalusingatechniquesimilartotheoneusedinTask3.Figure4illustrateswhat thetwoversionsoftheprogramlooklike Figure4 Anapproachtogeneratetwohash-collidingprogramswithdifferentbehaviors FromFigure4 weknowthatthesetwobinaryhavethesameMD5hashvalue aslongas P Q aregeneratedaccordingly.Intheversion wemakethecontentsofarraysXandYthesame inthesecondversion wemaketheircontentsdifferent.Therefore theonlythingweneedtochangeisthe contentsofthesetwoarrays andthereisnoneedtochangethelogicoftheprograms 3Submission Youneedtosubmitadetailedlabreport withscreenshots todescribewhatyouhavedoneandwhatyou haveobserved.Youalsoneedtoprovideexplanationtotheobservationsthatareinterestingorsurprising Pleasealsolisttheimportantcodesnippetsfollowedbyexplanation.Simplyattachingcodewithoutany explanationwillnotreceivecredits SEEDLabsŒMD5CollisionAttackLab 7 References 1 JohnBlack MartinCochran andTrevorHighland.Astudyofthemd5attacks Insightsandimprove- ments.In Proceedingsofthe13thInternationalConferenceonFastSoftwareEncryption FSE'06 pages 262Œ277 Berlin Heidelberg,2006.Springer-Verlag 2 MarcStevens.Oncollisionsformd5.Master'sthesis EindhovenUniversityofTechnology,62007 3 MarcStevens ElieBursztein PierreKarpman AngeAlbertini andYarikMarkov.Thecollision forfullSHA-1.CWIAmsterdamandGoogleResearch https //shattered.io/ ,2017 