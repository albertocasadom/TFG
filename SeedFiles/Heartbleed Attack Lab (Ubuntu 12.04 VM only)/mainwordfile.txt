SEEDLabsŒHeartbleedAttack 1 HeartbleedAttackLab Copyright©2016WenliangDu SyracuseUniversity ThedevelopmentofthisdocumentwaspartiallyfundedbytheNationalScienceFoundationunderAward No.1303306and1318814.ThisworkislicensedunderaCreativeCommonsAttribution-NonCommercial- ShareAlike4.0InternationalLicense.Ahuman-readablesummaryof andnotasubstitutefor thelicenseis thefollowing Youarefreetocopyandredistributethematerialinanymediumorformat.Youmustgive appropriatecredit.Ifyouremix transform orbuilduponthematerial youmustdistributeyourcontributions underthesamelicenseastheoriginal.Youmaynotusethematerialforcommercialpurposes 1Overview TheHeartbleedbug CVE-2014-0160 isasevereimplementationwintheOpenSSLlibrary whichen- ablesattackerstostealdatafromthememoryofthevictimserver.Thecontentsofthestolendatadependon whatisthereinthememoryoftheserver.Itcouldpotentiallycontainprivatekeys TLSsessionkeys user names passwords creditcards etc.ThevulnerabilityisintheimplementationoftheHeartbeatprotocol whichisusedbySSL/TLStokeeptheconnectionalive Theobjectiveofthislabisforstudentstounderstandhowseriousthisvulnerabilityis howtheattack works andhowtotheproblem.TheaffectedOpenSSLversionrangeisfrom 1.0.1 1.0.1f .The versionintheSEEDUbuntu12.04VMis 1.0.1 Readingsandrelatedtopics DetailedcoverageoftheformatstringattackcanbefoundinChapter17of theSEEDbook ComputerSecurity AHands-onApproach byWenliangDu Labenvironment Thislabhasbeentestedonourpre-builtUbuntu12.04VM whichcanbedownloaded fromtheSEEDwebsite.IfyouareusingourSEEDUbuntu16.04VM thisattackwillnotwork thevulnerabilityhasalreadybeenpatched.YoucandownloadtheSEEDUbuntu12.04VMfromtheSEED website.IfyouhaveanAmazonEC2account youcanourVMfromtheﬁCommunityAMIsﬂ.The nameoftheVMis SEEDUbuntu12.04-Generic .ItshouldbenotedthatAmazon'ssitesaysthatthis isa64-bitVM thatisincorrect.TheVMis32-bit.However thisincorrectinformationdoesnotcauseany problem 2LabEnvironment Inthislab weneedtosetuptwoVMs onecalledattackermachineandtheothercalledvictimserver Weusethepre-built SEEDUbuntu12.04 VM.TheVMsneedtousethe NAT-Network adapterforthe networksetting.ThiscanbedonebygoingtotheVMsettings pickingNetwork andclickingtheAdaptor tagtoswitchtheadapterto NAT-Network .MakesurebothVMsareonthesameNAT-Network ThewebsiteusedinthisattackcanbeanyHTTPSwebsitethatusesSSL/TLS.However sinceitis illegaltoattackarealwebsite wehavesetupawebsiteinourVM andconducttheattackonourown VM.Weuseanopen-sourcesocialnetworkapplicationcalled ELGG andhostitinthefollowingURL https //www.heartbleedlabelgg.com Weneedtomodifythe /etc/hosts ontheattackermachinetomaptheservernametotheIPad- dressoftheserverVM.Searchthefollowinglinein /etc/hosts andreplacetheIPaddress 127.0.0.1 withtheactualIPaddressoftheserverVMthathoststhe ELGG application 127.0.0.1www.heartbleedlabelgg.com SEEDLabsŒHeartbleedAttack 2 3LabTasks Beforeworkingonthelabtasks youneedtounderstandhowtheheartbeatprotocolworks.Theheartbeat protocolconsistsoftwomessagetypes HeartbeatRequestpacketandHeartbeatResponsepacket.Client sendsaHeartbeatRequestpackettotheserver.Whentheserverreceivesit itsendsbackacopyofthe receivedmessageintheHeartbeatResponsepacket.Thegoalistokeeptheconnectionalive.Theprotocol isillustratedinFigure ? ? 3.1Task1 LaunchtheHeartbleedAttack Inthistask studentswilllaunchtheHeartbleedattackonoursocialnetworksiteandseewhatkindof damagescanbeachieved.TheactualdamageoftheHeartbleedattackdependsonwhatkindofinformation isstoredintheservermemory.Iftherehasnotbeenmuchactivityontheserver youwillnotbeableto stealusefuldata.Therefore weneedtointeractwiththewebserveraslegitimateusers.Letusdoitasthe administrator anddothefollowings Ł Visit https //www.heartbleedlabelgg.com fromyourbrowser Ł Loginasthesiteadministrator UserName admin Password seedelgg Ł AddBobyasfriend Goto More- > Members andclick Boby- > AddFriend Ł SendBobyaprivatemessage Afteryouhavedoneenoughinteractionaslegitimateusers youcanlaunchtheattackandseewhat informationyoucangetoutofthevictimserver.WritingtheprogramtolaunchtheHeartbleedattackfrom scratchisnoteasy becauseitrequiresthelow-levelknowledgeoftheHeartbeatprotocol.Fortunately peoplehavealreadywrittentheattackcode.Therefore wewillusetheexistingcodetogain experienceintheHeartbleedattack.Thecodethatweuseiscalled attack.py whichwasoriginally writtenbyJaredStafford.Wemadesomesmallchangestothecodeforeducationalpurposes.Youcan downloadthecodefromthelab'swebsite changeitspermissionsotheisexecutable.Youcanthenrun theattackcodeasfollows $ ./attack.pywww.heartbleedlabelgg.com Youmayneedtoruntheattackcodemultipletimestogetusefuldata.Tryandseewhetheryoucanget thefollowinginformationfromthetargetserver Ł Usernameandpassword Ł User'sactivity whattheuserhasdone Ł Theexactcontentoftheprivatemessage ForeachpieceofsecretthatyoustealfromtheHeartbleedattack youneedtoshowthescreen-dumpas theproofandexplainhowyoudidtheattack andwhatyourobservationsare SEEDLabsŒHeartbleedAttack 3 3.2Task2 FindtheCauseoftheHeartbleedVulnerability Inthistask studentswillcomparetheoutcomeofthebenignpacketandthemaliciouspacketsentbythe attackercodetooutthefundamentalcauseoftheHeartbleedvulnerability TheHeartbleedattackisbasedontheHeartbeatrequest.Thisrequestjustsendssomedatatotheserver andtheserverwillcopythedatatoitsresponsepacket soallthedataareechoedback.Inthenormalcase supposethattherequestincludes3bytesofdataﬂABCﬂ sothelengthhasavalue3.Theserverwill placethedatainthememory andcopy3bytesfromthebeginningofthedatatoitsresponsepacket.Inthe attackscenario therequestmaycontain3bytesofdata butthelengthmaysay1003.Whentheserver constructsitsresponsepacket itcopiesfromthestartingofthedata i.e.ﬁABCﬂ butitcopies1003bytes insteadof3bytes.Theseextra1000typesobviouslydonotcomefromtherequestpacket theycomefrom theserver'sprivatememory andtheymaycontainotheruser'sinformation secretkeys password etc Figure1 TheBenignHeartbeatCommunication Inthistask wewillplaywiththelengthoftherequest.First let'sunderstandhowtheHeartbeat responsepacketisbuiltfromFigure1.WhentheHeartbeatrequestpacketcomes theserverwillparsethe packettogetthepayloadandthe Payload length value whichishighlightedinFigure1 .Here payloadisonlya3-bytestring '' ABC '' andthe Payload length valueisexactly3.Theserverprogram willblindlytakethislengthvaluefromtherequestpacket.Itthenbuildstheresponsepacketbypointingto thememorystoring '' ABC '' andcopy Payload length bytestotheresponsepayload.Inthisway responsepacketwouldcontaina3-bytestring '' ABC '' WecanlaunchtheHeartBleedattacklikewhatisshowninFigure2.Wekeepthesamepayload 3bytes butsetthe Payload length to1003.Theserverwillagainblindlytakethis Payload length valuewhenbuildingtheresponsepacket.Thistime theserverprogramwillpointtothestring '' ABC '' copy1003bytesfromthememorytotheresponsepacketasapayload.BesidesthestringﬂABCﬂ theextra 1000bytesarecopiedintotheresponsepacket whichcouldbeanythingfromthememory suchassecret activity logginginformation passwordandsoon Ourattackcodeallowsyoutoplaywithdifferent Payload length values.Bydefault thevalueis settoaquitelargeone 0x4000 butyoucanreducethesizeusingthecommandoption '' -l '' letterell '' -- length '' asshowninthefollowingexamples $ ./attack.pywww.heartbleedlabelgg.com-l0x015B $ ./attack.pywww.heartbleedlabelgg.com -- length83 SEEDLabsŒHeartbleedAttack 4 Figure2 TheHeartbleedAttackCommunication Yourtaskistoplaywiththeattackprogramwithdifferentpayloadlengthvaluesandanswerthefollow- ingquestions Ł Question2.1 Asthelengthvariabledecreases whatkindofdifferencecanyouobserve ? Ł Question2.2 Asthelengthvariabledecreases thereisaboundaryvaluefortheinputlengthvari- able.Atorbelowthatboundary theHeartbeatquerywillreceivearesponsepacketwithoutattaching anyextradata whichmeanstherequestisbenign .Pleasethatboundarylength.Youmayneed totrymanydifferentlengthvaluesuntilthewebserversendsbackthereplywithoutextradata.To helpyouwiththis whenthenumberofreturnedbytesissmallerthantheexpectedlength thepro- gramwillprint '' ServerprocessedmalformedHeartbeat butdidnotreturn anyextradata '' 3.3Task3 CountermeasureandBugFix TotheHeartbleedvulnerability thebestwayistoupdatetheOpenSSLlibrarytothenewestversion Thiscanbeachievedusingthefollowingcommands.Itshouldbenotedthatonceitisupdated itishardto gobacktothevulnerableversion.Therefore makesureyouhavetheprevioustasksbeforedoing theupdate.YoucanalsotakeasnapshotofyourVMbeforetheupdate $ sudoapt-getupdate $ sudoapt-getupgrade Task3.1 TryyourattackagainafteryouhaveupdatedtheOpenSSLlibrary.Pleasedescribeyourobser- vations Task3.2 TheobjectiveofthistaskistoouthowtotheHeartbleedbuginthesourcecode ThefollowingC-stylestructure notexactlythesameasthesourcecode istheformatoftheHeartbeat request/responsepacket struct { HeartbeatMessageTypetype //1byte requestortheresponse uint16payload_length //2byte thelengthofthepayload SEEDLabsŒHeartbleedAttack 5 opaquepayload HeartbeatMessage.payload_length opaquepadding padding_length } HeartbeatMessage The 1byte ofthepacketisthetypeinformation andthesecond 2bytes isthepayload length followedbytheactualpayloadandpaddings.Thesizeofthepayloadshouldbethesameasthevalue inthe payload length butintheattackscenario payload length canbesettoadifferent value.Thefollowingcodesnippetshowshowtheservercopiesthedatafromtherequestpackettothe responsepacket Listing1 ProcesstheHeartbeatrequestpacketandgeneratetheresponsepacket * Allocatememoryfortheresponse sizeis1byte * messagetype plus2bytespayloadlength plus * payload pluspadding * unsignedintpayload unsignedintpadding=16 * Useminimumpadding * //Readfromtypefieldfirst hbtype= * p++ * Afterthisinstruction thepointer * pwillpointtothepayload_lengthfield * //Readfromthepayload_lengthfield //fromtherequestpacket n2s p payload * Functionn2s p payload reads16bits * frompointerpandstorethevalue * intheINTvariable '' payload '' * pl=p //plpointstothebeginningofthepayloadcontent hbtype==TLS1_HB_REQUEST { unsignedchar * buffer * bp intr * Allocatememoryfortheresponse sizeis1byte * messagetype plus2bytespayloadlength plus * payload pluspadding * buffer=OPENSSL_malloc 1+2+payload+padding bp=buffer //Enterresponsetype lengthandcopypayload * bp++=TLS1_HB_RESPONSE s2n payload bp //copypayload memcpy bp pl payload * plisthepointerwhich * pointstothebeginning * ofthepayloadcontent * SEEDLabsŒHeartbleedAttack 6 bp+=payload //Randompadding RAND_pseudo_bytes bp padding //thisfunctionwillcopythe3+payload+paddingbytes //fromthebufferandputthemintotheheartbeatresponse //packettosendbacktotherequestclientside OPENSSL_free buffer r=ssl3_write_bytes TLS1_RT_HEARTBEAT buffer 3+payload+padding } PleasepointouttheproblemfromthecodeinListing1andprovideasolutiontothebug i.e. isneededtothebug .Youdonotneedtorecompilethecode justdescribehowyoucan theprobleminyourlabreport Moreover pleasecommentonthefollowingdiscussionsbyAlice Bob andEvaregardingthefunda- mentalcauseoftheHeartbleedvulnerability Alicethinksthefundamentalcauseismissingtheboundary checkingduringthebuffercopy Bobthinksthecauseismissingtheuserinputvalidation Evathinksthat wecanjustdeletethelengthvaluefromthepackettosolveeverything 4Submission Studentsneedtosubmitadetailedlabreporttodescribewhattheyhavedoneandwhattheyhaveobserved Reportshouldincludetheevidencestosupporttheobservations.Evidencesincludepackettraces screen dumps etc 