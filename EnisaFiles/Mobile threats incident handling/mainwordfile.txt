European Union Agency Network Information Security www.enisa.europa.eu Mobile threats incident handling Handbook Document teachers Mobile threats incident handling Handbook Document teachers Page ii About ENISA The European Union Agency Network Information Security ENISA centre network ENISA works groups develop advice recommendations good practice information security It assists EU member states implementing relevant EU legislation works enhanc e existing expertise EU member states supporting development cross - border communities committed improving network information security throughout EU More information ENISA work found www.enisa.europa.eu Authors This document created Yonas Leguesse Christos Sidiropoulos Lauri Palkmets Cosmin Ciobanu consultation DFN - CERT Services 1 Germany ComCERT 2 Poland S - CURE 3 The Netherlands Contact For contacting authors please use cert - relations @ enisa.europa.eu For media enquires paper please use press @ enisa.europa.eu 1 Mirko Wollenberg 2 M Maj Tomasz Chlebowski 3 Don Stikvoort Legal notice Notice must taken publication represents views interpretations authors editors unless stated otherwise This publication construed legal action ENISA ENISA bodies unless adopted pursu ant Regulation EU No 526/2013 This publication necessarily represent state - - art ENISA may update time time Third - party sources quoted appropriate ENISA responsible content external sou rces including external websites referenced publication This publication intended information purposes It must accessible free charge Neither ENISA person acting behalf responsible use might ade information contained publication Copyright Notice © European Union Agency Network Information Security ENISA 2014 Reproduction authorised provided source acknowledged Mobile threats incident handling Handbook Document teachers Page iii Table Contents 1 Introduction 2 1.1 Legal limitations 2 1.2 Organisational issues 2 1.3 Technical problems 3 2 Mobile forensics 3 2.1 Data acquisition 3 2.2 Chai n custody 3 2.3 Network forensics 4 3 Introduction Android 4 3.1 Android Operating System 4 3.2 Application structure 4 3.2 1 Application Components 4 3.2.2 Android application package file APK 5 3.2.3 The Manifest File 6 3.2.4 Malware Targeting Android 6 3.3 Introduction training 7 3.4 Resources 10 3.4.1 Tools 10 3.4.2 Additional Files 12 3.5 Keys Exercise 13 3.5 1 Task 1 Familiarisation Android AVD ADB 13 3.5.2 Task 2 Cloning Application 20 3.5.3 Task 3 Analysing Cloned Application 27 3.5.4 Task 4 Analysing Simplelocker 30 3.5.5 Task 5 Optional Analysing Other Artifacts 31 3.5.6 Questions 31 4 Summary exercise 33 5 References 34 Mobile threats incident handling Handbook Document teachers Page 1 Main Objective This course introduce concepts tools techniques used Mobile Incident Handling The students familiarise risks found Mobile platforms also ways identifying mitigating risks Targeted Audience CERT staff involved pro cess incid ent handling especially responsible detection new threat related directly CERT customers Total duration 6 - 7 hours Time Schedule Introduction training 0.5 hour Task 1 Familiarisation Android AVD ADB 1 hour Task 2 Cloning Application 2 hours Task 3 Analysing Cloned Application 1 hour Task 4 Analysing Simplelocker 0.5 hour Task 5 Optional Analysing Other Artifacts 1 hour Frequency On ce per team member Mobile threats incident handling Handbook Document teachers Page 2 1 Introduction The Smartphone become essential tool sections European society top government officials businesses consumers 4 Smartphones famous versatility single day smartphone may contactless wallet 5 barcode rea der satellite navigation system email social network client WiFi hotspot used make phone call Given growing importance smartphones important assess privacy security risks devices This training aterial covers key information security risks opportunities smartphone users It also provide practical advice addressing risks well recommendations We stress risks balanced po tential benefits smartpho nes To give one example however smartphones used smart - health sensors allowing heart patients stay home safely heart issues controlled monitored medical staff In way smartphones increase patient save healthcare costs 6 1.1 Legal limitations Apart technical limitations see might also legal regulations impacting ability handle incidents acquire analyse data Especially combination Bring Your Own Device BYOD usage company owned devices p rivate purposes restrictions might impact ability handle incidents As regulations differ legislations sure toadapt regards For example countries forensic investigation techniques manipulate dat device hand forensic data longer fit court A starting point might study - A flair sharing - encouraging information exchange CERTs 7 1.2 Organisational issues Usage mobile devices might subject th e policies rules devices This applies privacy also organisational policies Additionally risks may depend ent usage scenarios 8 Usage Scenario Description Consumer life e.g private phone - calls social networking messaging navigation gaming online banking - - go entertainment location based services Internet browsing micro - blogging email photography video recording e - health etc Employee The smartp hone used employee business government organization It used business phone calls Internet browsing corporate 4 Computerwoche Die Kanz lerin bekommt ihr Merkel - Phone http //www.computerwoche.de/net zwerke/mobile - wireless/1910789/ 5 PCMAG.COM Google 's Schmidt Shows Off 'Gingerbread ' NFC Phone http //www.pcmag.com/article2/0,2817,2372746,00.asp 6 The Tech Journal Monitor Body On Your Android Cellphones http //thetechjournal.com/tech - news/monitor - - body - - - android - cellphones.xhtml 7 A flair sharing - encouraging information ex change CERTs http //www.enisa.europa.eu/activities/cert/support/legal - information - sharing 8 Smartphones Information security risks opportunities recommendations users https //www.enisa.europa.eu/activities/identity - - trust/risks - - da ta - breaches/smartphones - information - security - risks - opportunities - - recommendations - - users/ Mobile threats incident handling Handbook Document teachers Page 3 email expens 9 e management customer relationship management travel assistance contact management business social networking video conferencing scheduling tasks reading documents In cases workflow applications run smartphone e.g fill forms part employee task Usage scenario subject IT security policies set way High official The smartphone used high top - level official business government organisation close aide The smartphone used Employee usage scenario addition used dealing sensitive information and/or tasks Usage scenario subject security policies functionality smartphone may restricted customized example adding cryptographic modules protecting call - confidentiality 1.3 Technical problems In general mobile platforms offer limited security capabilities For example encrypted obscure file systems deployed hinder reverse engineering attempts oth er hand approach negative impact incident investigation 2 Mobile forensics Mobile forensics refers digital forensics relating recovery data digital evidence mobile device i.e Mobile phones aswell digital devices tablets GPS devices It important recovery done forensically sound conditions There number items must kept mind dealing mobile forensics 2.1 Data acquisition Usually forced acquire data powered - system might way take images interfaces hardware/software access internal device memory may missing purpose Take care acquire data mory extensions SD Cards may contain valuable information investigation purposes 2.2 Chain custody Establishing maintaining chain custody CoC maintaining integrity mobile device prove quite difficult ealing mobile devices Most available forensic tools require investigator install application system analysed Additionally way physically make file systems read - Investigating device test environme nt might recognised malware lead evidence loss Acquiring evidence mobile devices may therefore taint integrity evidence rendering non admittable trials According UK ACPO guidelines 9 ment agencies agents change data 9 ACPO guidelines http //www.athenaforensics.co.uk/acpo - guidelines Mobile threats incident handling Handbook Document teachers Page 4 2.3 Network forensics Devices using company - provided Wi - Fi subject network forensic tools already place Connect ions made via cell networks much harder analyse On e way would use Femtocell 10 stations Please take care legal compliance issues might introduced approach Of course provides limited range coverage est bed environment company campus 3 Introduction Android This introductory course focus mainly Android 3.1 A ndroid O perating S ystem Android mobile operating system OS developed Google used several smartphones Android phones typically come several built - applications also support third - party programs Developers create programs Android using free Android SDK Software Developer Kit Android programs written Java run Google 's `` Da lv ik '' virtual machine optimized mobile devices Users download Android '' apps '' online Android Market 11 3.2 Application structure 3.2.1 Application Components Application components essential building blo cks Android applicati Each component different point system enter application 12 Here four types application components Activities Services Content providers Broadcast receivers An activity represents single screen user interface An application might one activity shows specific user interface another activity shows different one If application one activity one marked default activity presented application launched A service component runs background perform long - running operations For example service might play music background user dif ferent application 10 Black Hat Intercepting Calls Cloning Phones With Femtocells http //securitywatch.pcma g.com/hacking/314370 - black - hat - intercepting - calls - - cloning - phones - - femtocells 11 Application Fundamentals http //developer.android.com/guide/components/fundamentals.html 12 Application Fundamentals http //developer.android.com/guide/components/fund amentals.html Mobile threats incident handling Handbook Document teachers Page 5 Broadcast Receivers simply respond broadcast messages applications system For example receiving SMS bro adcast receiver intercept communication initiate appropriate action A content pr ovider component supplies data one application others request Such requests handled methods ContentResolver class The data may stored file system database somewhere else entirely 3.2.2 Android application package file APK Android application package file APK package file format used distribute install application software middleware onto Google's Android operating system essentially apk packages ions requirements Android application An APK file therefore compiled Android program packaged one file An APK file contains program 's code .dex files resources assets certificates manifest file The fi lename APK package must ends `` .apk '' Figure 1 Structure APK 13 In diagram see diagramattically approach JAVA code compiled packed Android AP K. 13 Decompile Secure android apk https //decompileandsecureapk.wordpress.com/2014/05/10/decompile - - secure - android - apk/ Mobile threats incident handling Handbook Document teachers Page 6 3.2.3 The Manifest File An Android application must declare components file must root application project directory The manifest number things addition declaring application 's components Identify user permissions application requires Declare minimum application program interface API Le vel required application Declare hardware software features used required application API libraries application needs linked 3.2.4 Malwar e Targeting Android Studies shown majority mobile malware designed target Google's Android operating system OS 14 F - Secure reported 99 percent 277 new mobile threat families detected first quarter 2014 designed infect Android devices Mobile Threat Report Q1 2014 15 The figure marked spike Android malware levels F - Secure reported 91 percent detected mobile malware targeted Google 's OS Q1 2013 The increase indicative wider year - - year increase mobile malware levels F - Secure detected 149 new mobile malware variants Q1 201 4 Figure 2 What Does 14 Android users targeted 99 percent mobile malware http //www.v3.co.uk/v3 - uk/news/2342442/android - users - targeted - - - 99 - percent - - mobile - malware 15 Mobile Threat Report Q1 2014 http //www.f - secure.com/static/doc/labs_global/Research/Mobile_Threat_Report_Q1_2014_print.pdf Mobile threats incident handling Handbook Document teachers Page 7 Figure 3 What Does It 16 3.3 Introduction training The Students given 5 main tasks 1 Familiarisation Android Android Virtual Device AVD Android Debug Bridge ADB 2 Cloning Application 3 Anal sing Cloned Application 4 Analysing malicious application simplelocker 5 Optional Anal sing Other Artifacts In first task students familiarise Android Android Vir ual Device AVD Android Debug Bridge ADB Next students get better understa nding structure Android application They learn simple steps legitimate The students familiarise apktool 17 tool reverse engi neering third party closed binary Android apps A classes prepared advance placed Modifications folder /home/enisa/Desktop/Training - Material/Mobile_Threats_IH VM 16 Mobile Threat Report Q1 2014 http //www.f - secure.com/static/doc/labs_global/Research/Mobile_Threat_Report_Q1_2014_print.pdf 17 Apktool http //code.google.com/p/android - apktool/ Mobile threats incident handling Handbook Document teachers Page 8 Figure 4 Cloning & Modify ing APK T students also analyse data generated A ndro id device cloned application run If students careful enough able Mobile threats incident handling Handbook Document teachers Page 9 Figure 5 Network Traffic Analysis As part analysis students com pare legitimate application clone one To start use apktool retrieve anifest By comparing manifest file two applications student able identify differences permissions see application components added Figure 6 Comparison APK files Mobile threats incident handling Handbook Document teachers Page 10 After identifying differences permissions application components students use students first use dex2jar 18 order generate .jar file .apk The student use java decompiler JD - GUI convert java classes java code This code analysed suspicious functions additional useful information authentication parameters URLs encryption keys etc The code may always clear different obfuscation techniques 19 used developers There also number automated malware analysis tools Anubis 20 Mobile Sandbox 21 These online tools generate reports providing useful information permissions URLs used application If suspicion apk cloned injected code apks uploaded sandbox compared discover differences permissions used The report shows Anubis implify search differences Figure 7 Screenshot Anubis report Finally students given time analyse existing artefacts including famous Simplelocker 22 ransomware provided virtual machines The results findings reported discussed 3.4 Resources 3.4.1 Tools The tools found VM 18 dex2jar https //code.google.com/p/dex2jar/ 19 Java Obfuscation Techniques http //www.sable.mcgill.ca/JBCO/examples.html 20 Anubis https //anubis.iseclab.org/ 21 Mobile Sandbox http //mobilesandbox.org/ 22 Symantec Android.Simplocker http //www.symantec.com/security_response/earthlink_writeup.jsp ? docid=2014 - 060610 - 5533 - 99 Mobile threats incident handling Handbook Document teachers Page 11 Android Emulator 23 Description The Android emulator serve testing/demo Android device Android Apps installed emulator Name Enisa Version 4.0.3 Software APKs Commands ./emulator avd Enisa tcpdump dump pcap used launch emulator enable sniffing emulator network traffic All traffic saved dump .pcap Note Emulator located home/enisa/.android/avd/ ./emulator launched path /home/enisa/Tools/adt - bundle - linux - x86_64 - 20140321 /sdk/tools Clear dump.pcap running new emulator session JD - GUI 24 Description JD - GUI java de - compiler This tool used interpret decompiled java code retrieved APKs Version 0.3.5 Software JD - GUI .jar file retrieved .apk Android ADT Description This IDE used course Version Eclipse Android Dev Tools Software Custom Mod_App project Note Workspace located Home/enisa/ workspace Wireshark 25 Description Used interpret pcap files generated sniffing Android emulator network data 23 Android Emulator http //developer.android.com/tools/help/emulator.html 24 Java Decompiler http //jd.benow.ca/ 25 Wireshark https //www.wireshark.org/ Mobile threats incident handling Handbook Document teachers Page 12 Dex2Jar 26 Description This tool used generate .jar file .apk file The .jar file decompiled using java decompiler Commands /home/enisa/ Desktop/Training - Material/Tools/dex2jar - 0.0.9.15 /dex2jar.sh < apk_to_decompile > .apk Version 0.0.9.15 Apktool 27 Description This tool used decode apks well build Android applications apks Commands apktool < apkname > .apk decode apk apktool b < apkname > build modified decoded apk generate new apk file The new apk found path < apkname > /dist/ ADB 28 Description This tool used install push pull apps host PC emulator Commands adb install home/enisa/Tools/SignApk/ < apkname > .apk SignApk 29 Description This tool used sign newly built apk file Commands Java jar signapk.jar certificate.pem key pk8 < apk_name > .apk < signed _apk_name > .apk Note SignApk path /home/ enisa/Desktop/Training - Material/Tools/SignApk 3.4.2 Additional Files mySuperAV .apk Description A dummy Android application created exercise This apk decoded modified - built MOD Folder 26 Dex2jar https //code.google.com/p/dex2jar/ 27 Apktool http //ibotpeaches.github.io/Apktool/ 28 ADB http //developer.android.com/tools/help/adb.html 29 SignAPK https //code.google.com/p/signapk/ Mobile threats incident handling Handbook Document teachers Page 13 Description The Mod Folder contains required code modifications Content smali files included smali folder AndroidManifest.xml Modifications permissions receivers 3.5 Keys E xercise 3.5.1 Task 1 Familiarisation Android AVD ADB 3.5.1.1 Open Android SDK Manager cd /android/adt - bundle - linux - x86 - 20140702/sdk/tools ./android Figure 8 Andr id SDK Manager 3.5.1.2 Open Android AVD Manager cd /android/adt - bundle - linux - 20140702/sdk/tools/ android avd Mobile threats incident handling Handbook Document teachers Page 14 Figure 9 Andr id AVD Manager 3.5.1.3 Browse /home/enisa/.android Desktop OS AVD Data Location Ubuntu /home/ < username > /.android/ Max OS X /Users/ < username > /.android Windows 7 C \ Users \ < username > \ .android 3.5.1.4 Browse Enisa AVD folder cache.img disk image /cache partition sdcard.img disk image SD card created AVD setup userdata - qemu.img disk image /data partition Mobile threats incident handling Handbook Document teachers Page 15 3.5.1.5 Figure 10 Create AVD 3.5.1.6 Add Hardware open AVDs Modify Nexus 7 Hardware Cloning Device modifying features Figure 11 Device Definitions Mobile threats incident handling Handbook Document teachers Page 16 Figure 12 Nexus 7 - Mod Assign New Device SimpleLockerAVD Mobile threats incident handling Handbook Document teachers Page 17 Figure 13 Modified Device Note Open AVDs use separate terminals cd /android/adt - bundle - linux - 20140702/sdk/tools/ ./emulator avd Enisa - tcpdump dump.pcap cd /android/adt - bundle - linux - 20140702/sdk/tools/ ./emulator avd SimpleLockerAVD Mobile threats incident handling Handbook Document teachers Page 18 Figure 14 Launch AVDs different terminals Note emulators must opened different terminals These Terminals dedicated AVD close write commands close emulator 3.5.1.7 Sending commands telnet Connect telnet localhost 5 554 Commands power status full power status charging gsm call 0123456789 sms send 12345 hello test sms geo fix 48 51 Mobile threats incident handling Handbook Document teachers Page 19 3.5.1.8 Try shortcut keys Figure 15 Basic Emulator Commands 30 3.5.1.9 Enable USB debugging emulator Developer Options > USB debugging 30 AVD http //developer.android.com/tools/help/emulator.html Mobile threats incident handling Handbook Document teachers Page 20 Figure 16 Developer Options 3.5.1.10 List Devices cd /android/adt - bundle - linux - x86 - 20140702/sdk/tools adb devices 3.5.1.11 Run command specific device adb emulator - 5554 shell 3.5.1.12 Browse device folders using shell adb shell cd /data/data ls cd /data/app ls exit 3.5.1.13 Push pull file Emulator Create file desktop test.txt adb push /home/Enisa/Desktop/test.txt /sdcard/testpush.txt adb pull/home/Enisa/Desktop/testpull.txt /sdcard/testpush.txt 3.5.2 Task 2 Cloning Applica tion 3.5.2.1 Run Android emulator In terminal r un commands cd /android/adt - bundle - linux - 20140702 /sdk/tools/ ./emulator avd Enisa - tcpdump dump.pcap 3.5.2.2 Download Install MySuperAV In Android Emulator Go url 10.0 .2.2/Good.html Browser Click download link Mobile threats incident handling Handbook Document teachers Page 21 Figure 17 Good store 3.5.2.3 Install app Figure 18 Download Figure 19 Install Mobile threats incident handling Handbook Document teachers Page 22 3.5.2.4 Run app Figure 20 App Screenshot 3.5.2.5 Task use adb pull get apk file adb pull /data/app/com.example.mysuperav .apk /home/enisa/ /home/enisa/Desktop 3.5.2.6 Uninstall app 3.5.2.7 Decode app apktool mysuperAV .apk Figure 21 ApkTool Decode 3.5.2.8 Inject Code - Classes Copy custom smali folder folder Mobile threats incident handling Handbook Document teachers Page 23 Figure 22 Inserting Code 3.5.2.9 Inject Code - Manifest Copy contents Mods/manifest/Mods_AndroidManifest.xml decoded mysuperAV /AndroidManifest.xml use leafpad read instructions Mods_AndroidManifest.xml Figure 23 Manifest Files Mobile threats incident handling Handbook Document teachers Page 24 Figure 24 manifest modification 3.5.2.10 Build app apktool b mysuperAV Figure 25 Building App 3.5.2.11 Move apk signAPK folder Copy apk mysuperAV/dist/mysuperAV.apk places Tools/SignAPK folder Mobile threats incident handling Handbook Document teachers Page 25 Figure 26 Placing apk SingAPK 3.5.2.12 Sign ap k java jar signapk.jar certifi cate.pem key.pk8 mysuperAV.apk mysuperAV_signed.apk Figure 27 Sign apk 3.5.2.13 Install app In Android Emulator Make sure mysuperAV installed Go url 10.0 .2.2/Bad.html Browser Click Download link Install app Figure 28 Bad Store Mobile threats incident handling Handbook Document teachers Page 26 Figure 29 Download apk 3.5.2.14 Run app Open run app See works fine Close app 3.5.2.15 Add Contact Name Bank Phone +123456789 3.5.2.16 Send SMS emulato r Figure 30 Send SMS 3.5.2.17 Vie w Stolen Data Open found Bad Server ! This text file contains stolen data taken victims device sudo leafpad /var/www/html/myfile.txt Figure 31 Stolen Data Mobile threats incident handling Handbook Document teachers Page 27 3.5.3 Task 3 Analy sing Cloned Application 3.5.3.1 Task use adb pull get apk file adb pull /data/app/com.example.mysuperav.apk /home/enisa/ /home/enisa/Desktop 3.5.3.2 Analyse network traffic cd /android/adt - bundle - linux - 20140702 /sdk/tools/ wireshark dump.pcap find http post bad server /bad.php Figure 32 Network Traffic 3.5.3.3 Create new Investigation Folder Place original Mobile_threats_IH/mysuperAV.apk cloned/signed Tools/SignAPK/mysuperAV_signed.apk apk Mobile_threats_IH /Investigation Note Alternatively also find apks path /var/www/html/ Copy paste investigations folder Figure 33 Investigation Folder Mobile threats incident handling Handbook Document teachers Page 28 3.5.3.4 Decode apk files In terminal run command cd Desktop/Training - Material/Mobile_threats_IH /Investigation apktool mysuperAV .apk apktool mysuperAV_signed .apk Figure 34 Decode apk files 3.5.3.5 Compare content Manifests In terminal run command cd Desktop/Training - Material/Mobile_threats_IH /Investigation diff mysuperAV/AndroidManifest.cml mysuperAV_signed/AndroidManifest.xml Figure 35 Modified Manifest 3.5.3.6 Convert apks jar files cd Desktop/Training - Material/Tools/dex2ja r/ ./ dex2jar.sh ../../Mobile_threats_IH/mysuperAV .apk ./ dex2jar.sh ../../Mobile_threats_IH/mysuperAV_signed .apk Mobile threats incident handling Handbook Document teachers Page 29 Figure 36 Dex2jar 3.5.3.7 Analyse classes Open JD - GUI Programming > JD - GUI Open apks JD - GUI Figure 37 SMSBroadcastReceiver Mobile threats incident handling Handbook Document teachers Page 30 Figure 38 AESHelper 3.5.4 Task 4 Analysing Simplelocker 3.5.4.1 Task Install Simplelocker Disable Network connection VM ! ! ! Go Mobile Folder cd /home/enisa/ Desktop/Training - Material/ Mobile_threats_IH Unzip Simple locker file 7z e Simpl elocker.apk.zip < ask password class > Install using adb install adb push adb install /home/enisa/Desktop/Training - Material/Mobile_threats_IH Simplelocker.apk 3.5.4.2 Task Analyse Simplelocker Use apk tool analyse manifest Use dex2jar create jar file Open jar file jd - gui Challenge 1 What encryption algorithm used ? AES/CBC/PKCS7Padding Challenge 2 What encryption key jndlasf074hr Challenge 3 What files types encrypted see constants class 3.5.4.3 Task Remove Simplelocker Uninstall simplelocker using adb uninstall Mobile threats incident handling Handbook Document teachers Page 31 db uninstall org.simplelocker 3.5.5 Task 5 Optional Anal sing Other Artifacts Under /home/enisa/Mobile_threats_IH find samples apks Apk.zip Since art facts still active order analyse network connections may wish use sandbox tools Anubis If wish run applications locally use segregated unprotected network devices contain personal data accounts credentials etc use dns http server host simulating C & C servers possible approach could run tool sandboxed malware analysis tool check network connections configure dn http servers accordingly disable network connection note may always produce results code may check network connection prior running code 3.5.5.1 Task Flappy Bird Analyse code Flappy bird APKs One malware Which one ? Go Mobile Folder cd /home/enisa/Desktop/Training - Material/Mobile_threats_IH Unzip Simple locker file unzip Apk.zip < ask password class > 3.5.5.2 Upload apk files automated tools Anubis Mobile Sandbox Joe sandbox mobile O thers 3.5.6 Questions No Question Answer 1 List suspicious permissions acquired 2 Can identify background app components Services/Broadcast Receivers ? Mobile threats incident handling Handbook Document teachers Page 32 3 Can identify initial/starting activity ? 4 Do notice suspicious network connections initiated application ? 5 From code see suspicious Functions ? 6 If link functions permissions and/or suspicious network connections ? 7 List useful information eg encryption keys data saved database etc 8 What main purpose artefact ? Mobile threats incident handling Handbook Document teachers Page 33 4 Summary exercise The summary contain following information Possible issues using emulator malware analysis detection emulated environment malware 31 infection host system malware infection third party systems running virtual environment networked investigating cellular radio behaviour Possible issues analysing alware native Android hardware infection third party systems malware might detectable device networked building secure safe test environment Examine information table incident analysis logs/reports Discussion exper iences made exercise Mobile evice management MDM features 31 Detecting Android Sandboxes http //www.dexlabs.org/blog/btdetect Mobile threats incident handling Handbook Document teachers Page 34 5 R eferences Computerwoche Die Kanzlerin bekommt ihr Merkel - Phone http //www.computerwoche.de/netzwerke/mobile - wireless/1910789 PCMAG.COM Google 's Schmidt S hows Off 'Gingerbread ' NFC Phone http //www.pcmag.com/article2/0,2817,2372746,00.asp The Tech Journal Monitor Body On Your Android Cellphones http //thetechjournal.com/tech - news/monitor - - body - - - android - cellphones.xhtml A flair sharin g - encouraging information exchange CERTs http //www.enisa.europa.eu/activities/cert/support/legal - information - sharing Smartphones Information security risks opportunities recommendations users https //www.enisa.europa.eu/activities/id entity - - trust/risks - - data - breaches/smartphones - information - security - risks - opportunities - - recommendations - - users/ ACPO guidelines http //www.athenaforensics.co.uk/acpo - guidelines Black Hat Intercepting Calls Cloning Phones With Femtocells http //securitywatch.pcmag.com/hacking/314370 - black - hat - intercepting - calls - - cloning - phones - - femtocells Application Fundamentals http //developer.android.com/guide/components/fundamentals.html Decompile Secure android apk https //decompileandsec ureapk.wordpress.com/2014/05/10/decompile - - secure - android - apk/ Android users targeted 99 percent mobile malware http //www.v3.co.uk/v3 - uk/news/2342442/android - users - targeted - - - 99 - percent - - mobile - malware Mobile Threat Report Q1 2014 http //www.f - secure.com/static/doc/labs_global/Research/Mobile_Threat_Report_Q1_2014_print.pdf Mobile Threat Report Q1 2014 http //www.f - secure.com/static/doc/labs_global/Research/Mobile_Threat_Report_Q1_2014_print.pdf A pktool http //code.google.com/p/an droid - apktool/ dex2jar https //code.google.com/p/dex2jar/ Java Obfuscation Techniques http //www.sable.mcgill.ca/JBCO/examples.html Anubis https //anubis.iseclab.org/ Mobile Sandbox http //mobilesandbox.org/ Symantec Android.Simplocker http //www.symant ec.com/security_response/earthlink_writeup.jsp ? docid=2014 - 060610 - 5533 - 99 Android Emulator http //developer.android.com/tools/help/emulator.html Java Decompiler http //jd.benow.ca/ Wireshark https //www.wireshark.org/ Dex2jar https //code.google.com/p/dex2j ar/ Apktool http //ibotpeaches.github.io/Apktool/ Mobile threats incident handling Handbook Document teachers Page 35 ADB http //developer.android.com/tools/help/adb.html SignAPK https //code.google.com/p/signapk/ AVD http //developer.android.com/tools/help/emulator.html Detecting Android Sandboxes http //www.dexlabs.org/b log/btdetect Mobile threats incident handling Handbook Document teachers Page 36 PO Box 1309 710 01 Heraklion Greece Tel +30 28 14 40 9710 info @ enisa.europa.eu www.enisa.europa.eu ENISA European Union Agency Network Information Security Science Technology Park Crete ITE Vassilika Vouton 700 13 Heraklion Greece Athens Office 1 Vass Sofias & Meg Alexandrou Marousi 151 24 Athens Greece European Union Agency Network Information Security www.enisa.europa.eu Mobile threats incident handling Toolset Document students Mobile threats incident handling Toolset Document students Page ii About ENISA The European Union Agency Network Information Security ENISA centre network ENISA works groups develop dvice recommendations good practice information security It assists EU member states implementing relevant EU legislation works enhance existing expertise EU member states supporting development cross - border communities committed improving network information security throughout EU More information ENISA work found www.enisa.europa.eu Acknowledgements Contributors report We would like thank ENISA colleagues contributed input report supervised completion especially Lauri Palkmets Cosmin C iobanu Andreas Sfakianakis Romain Bourgue Yonas Leguesse We would also like thank team Don Stikvoort Michael Potter S - Mirko Wollenberg PRESE CURE Consulting Germany produced second version documents consultants Agreements Acknowledgements consultants countless people reviewed document Contact For contacting authors please use CERT - Relations @ enisa.europa.eu For media enquires paper please use press @ enisa.europa.eu Mobile threats incident handling Toolset Document students Page iii Legal notice Notice must taken publication represents views interpretations authors editors unless stated otherwise This publication cons trued legal action ENISA ENISA bodies unless adopted pursuant Regulation EU No 526/2013 This publication necessarily represent state - - art ENISA may update time time Third - party sources quoted appropriate ENISA responsible content external sources including external websites referenced publication This publication intended information purposes It must accessible free charge Neither ENISA r person acting behalf responsible use might made information contained publication Copyright Notice © European Union Agency Network Information Security ENISA 2013 Reproduction authorised provided source acknowledged Mobile threats incident handling Toolset Document students Page iv Table Contents 1 What Will You Learn 1 2 Exercise Task 1 2.1 Task 1 Familiarisation Android AVD ADB 1 2.2 Task 2 Cloning Application 8 2.3 Task 3 Analysing Cloned Application 14 2.4 Ta sk 4 Analysing Simplelocker 16 2.5 Task 5 Optional Analysing Other Artifacts 16 3 Conclusion 18 Mobile threats incident handling Toolset Document students Page 1 1 What Will You Learn Mobile devices add additional conditions investigator First access device might difficult geograp hy Bring Your Own Device BYOD privacy issues Data access investigation tools used environments might working It might necessary adjust implemented inciden - handling processes adapt specific platforms This course serve introduction Mobile Technologies Incident Handling within field 2 Ex ercise Task The Students given 5 main tasks 1 Familiarisation Android AVD ADB 2 Cloning Application 3 Anal sing Cloned Applicatio n 4 Anal sing Simplelocker 5 Optional Anal sing Other Artifacts 2.1 Task 1 Familiarisation Android AVD ADB 2.1.1 Open Android SDK Manager cd /android/adt - bundle - linux - x86 - 20140702/sdk/tools ./android Figure 1 Andr SDK Manager 2.1.2 Open Android AVD Manager cd /android/adt - bundle - linux - 20140702/sdk/tools/ android avd Mobile threats incident handling Toolset Document students Page 2 Figure 2 Andr AVD Manager 2.1.3 Browse /home/enisa/.android Desktop OS AVD Data Location Ubuntu /home/ < username > /.android/ Max OS X /Users/ < username > /.android Windows 7 C \ Users \ < username > \ .android 2.1.4 Browse Enisa AVD folder cache.img disk image /cache partition sdcard.img disk image SD card created AVD setup userdata - qemu.img disk image /data partition Mobile threats incident handling Toolset Document students Page 3 2.1.5 Create Figure 3 Create AVD 2.1.6 Add Hardware open AVDs Modify Nexus 7 Hardware Cloning Device modifying features Add GPS Enisa AVD Edit using AVD Manager Figure 4 Device Definitions Mobile threats incident handling Toolset Document students Page 4 Figure 5 Nexus 7 - Mod Assign New Device SimpleLockerAVD Mobile threats incident handling Toolset Document students Page 5 Figure 6 Modified Device Note Open AVDs use separate terminals cd /android/adt - bundle - linux - 20140702/sdk/tools/ ./emulator avd Enisa - tcpdump dump.pcap cd /android/adt - bundle - linux - 20140702/sdk/tools/ ./emulator avd SimpleLockerAVD Mobile threats incident handling Toolset Document students Page 6 Figure 7 Launch AVDs different terminals Note emulato rs must opened different terminals These Terminals dedicated AVD close write commands close emulator 2.1.7 Sending commands telnet Connect telnet localhost 5554 Commands power status full power status charging gsm call 0123456789 sms send 12345 hello test sms geo fix 48 51 Mobile threats incident handling Toolset Document students Page 7 2.1.8 Try shortcut keys Figure 8 Basic Emulator Commands 1 2.1.9 Enable USB debugging emulator Developer Options > USB debugging Figure 9 Developer Options 1 http //developer.android.com/tools/help/emulator.html Mobile threats incident handling Toolset Document students Page 8 2.1.10 List Devices cd /android/adt - bundle - linux - x86 - 20140702/sdk/tools adb devices 2.1.11 Run command specific device adb emulator - 5554 shell 2.1.12 Browse device folders using shell adb shell cd /data/data ls cd /data/app ls exit 2.1.13 Push pull file Emulator Create file desktop test.txt adb push /home/Enisa/Desktop/test.txt /sdcard/testpush.txt adb pull/home/Enisa/Desktop/testpull.txt /sdcard/testpush.txt 2.2 Task 2 Cloning Application 2.2.1 Run Android emulator In terminal r un commands cd /android/adt - bundle - linux - 20140702 /sdk/tools/ ./emulator avd Enisa - tcpdump dump.pcap 2.2.2 Download Install MySuperAV In Android Emulator Go url 10.0 .2.2/Good.html Browser Click download link Figure 10 Good Store Mobile threats incident handling Toolset Document students Page 9 2.2.3 Install app Figure 11 Download Figure 12 Install 2.2.4 Run app Figure 13 App Screenshot 2.2.5 Task use adb pull get apk file 2.2.6 Uninstall app 2.2.7 Decode app apktool mysuperAV .apk Mobile threats incident handling Toolset Document students Page 10 Figure 14 ApkTool Decode 2.2.8 Inject Code - Classes Copy custom smali folder folder Figure 15 Inserting Code 2.2.9 Inject Code - Manifest Copy contents Mods/manifest/Mods_AndroidManifest.xml Manifest mysuperAV/AndroidManifest.xml use leafpad read instructions Mods_AndroidManifest.xml Figure 16 Manifest Files Mobile threats incident handling Toolset Document students Page 11 Figure 17 manifest modification Build app apktool b mysuperAV Figure 18 Building App Move apk signAPK folder Copy apk mysuperAV/dist/mysuperAV.apk places Tools/SignAPK folder Mobile threats incident handling Toolset Document students Page 12 Figure 19 Placing apk SingAPK 2.2.10 Sign ap k java jar signapk.jar certificate.pem key.pk8 mysuperAV.apk mysuperAV_signed.apk Figure 20 Sign apk 2.2.11 Install app In Android Emulator Make sure mysuperAV installed Go url 10.0 .2.2/Bad.html Browser Click Download link Install app Figure 21 Bad Store Mobile threats incident handling Toolset Document students Page 13 Figure 22 Download apk 2.2.12 Run app Open run app See works fine Close app 2.2.13 Add Contact Name Bank Phone +123456789 2.2.14 Send SMS emulato r 5554 Figure 23 Send SMS 2.2.15 View Stolen Data Open found Bad Server ! This text file contains stolen data taken victims device sudo leafpad /var/www/html/myfile.txt Figure 24 Stolen Data Mobile threats incident handling Toolset Document students Page 14 2.3 Task 3 Analysing Cloned Application 2.3.1 Task use adb pull get apk file 2.3.2 Analyse network traffic cd /android/adt - bundle - linux - 20140702 /sdk/tools/ wireshark dump.pcap find http post bad server /bad.php Figure 25 Network Traffic 2.3.3 Create new Investigation Folder Place original Mobile_threats_IH/mysuperAV.apk cloned/signed Tools/SignAPK/mysuper AV_signed.apk apk Mobile_threats_IH /Investigation Note Alternatively also find apks path /var/www/html/ Copy paste investigations folder Figure 26 Investigation Folde r Mobile threats incident handling Toolset Document students Page 15 2.3.4 Decode apk files In terminal run command cd Desktop/Training - Material/Mobile_threats_IH /Investigation apktool mysuperAV .apk apktool mysuperAV_signed .apk Figure 27 Decode apk files 2.3.5 Compare content Manifests In terminal run command cd Desktop/Training - Material/Mobile_threats_IH /Investigation diff mysuperAV/AndroidManifest.cml mysuperAV_signed/AndroidManifest.xml Figure 28 Modified Manifest 2.3.6 Convert apks jar files cd Desktop/Training - Material/Tools/dex2jar/ ./ dex2jar.sh ../../Mobile_threats_IH/mysuperAV .apk ./ dex2jar.sh ../../Mobile_threats_IH/mysuperAV_signed .apk Mobile threats incident handling Toolset Document students Page 16 Figure 29 Dex2jar 2.3.7 Analyse classes Open JD - GUI Programming > JD - GUI Open apks JD - GUI 2.4 Task 4 Analysing Simplelocker 2.4.1 Task Install Simplelocker Disable Network connection VM ! ! ! cd Desktop/Training - Material/Mobile_threats_IH 7z e Simpl elocker.apk.zip < ask password class > Install using adb install adb push 2.4.2 Task Analyse Simplelocker Use apktool analyse manifest Use dex2jar create jar file Open jar file jd - gui Challenge 1 What encryption algorithm used ? Challenge 2 What encryption key Challenge 3 What files types encrypt ed 2.4.3 Task Remove Simplelocker Uninstall simplelocker using adb uninstall 2.5 Task 5 Optional Analysing Other Artifacts Under /home/enisa/Mobile_threats_IH find samples apks Apk.zip malicious others Some samples still dangerous Command Control servers still active You may wish hand students additio nal practice Since artefacts still active order analyse network connections may wish use sandbox tools Anubis If wish run applications locally Mobile threats incident handling Toolset Document students Page 17 use segregated unprotected network c lean/dummy devices without personal data accounts credentials etc use dns http server host simulating C & C servers possible approach could run tool sandboxed malware analysis tool check network connections nd configure dns http servers accordingly disable network connection note may always produce results code may check network connection prior running code 2.5.1 Task Flappy Bird Analyse code Flappy bird AP Ks One malware Which one ? Go Mobile Folder cd /home/enisa/Desktop/Training - Material/Mobile_threats_IH Unzip Simple locker file unzip Apk.zip < ask password class > 2.5.2 Upload apk files automated tools Anubis Mobile Sandbox Joe sandbox mobile Others 2.6 Questions No Question Answer 1 List suspicious permissions acquired 2 Can identify background app components Services/Broadcast Receivers ? 3 Can identify initial/starting activity ? Mobile threats incident handling Toolset Document students Page 18 4 Do notice suspicious network connections initiated application ? 5 From code see suspicious Functions ? 6 If link functions permissions and/or suspicious network connections ? 7 List useful information eg encryption keys data saved database etc 8 What main purpose artefact ? 3 Conclusion answer questions listed section 2.1.5.1 Mobile threats incident handling Toolset Document students Page 19 PO Box 1309 710 01 Heraklion Greece Tel +30 28 14 40 9710 info @ enisa.europa.eu www.enisa.europa.eu ENISA European Union Agency Network Information Security Science Technology Park Crete ITE Vassilika Vouton 700 13 Heraklion Greece Athens Office 1 Vass Sofias & Meg Alexandrou Marousi 151 24 Athens Greece 