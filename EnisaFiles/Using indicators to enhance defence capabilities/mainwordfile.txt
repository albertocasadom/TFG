European Union Agency Network Information Security www.enisa.europa.eu Using indicators enhance defence capabilities Actionable information November 2014 Using indicators enhance defence capabilities Actionable information November 2014 Page ii About ENISA The European Union Agency Network Information Security ENISA centre network ENISA works wit h groups develop advice recommendations good practice information security It assists EU member states implementing relevant EU legislation works rks ENISA seeks enhance existing expertise EU member states supporting development cross - border communities committed improving network information security throughout EU More information ENISA work found www.enisa.europa.eu Authors This document created CERT capability tea ENISA consultation CERT Polska NASK Poland 1 Contact For contacting authors please use cert - relations @ enisa.europa.eu For media enquires paper please use press @ enisa.europa.eu Acknowledgements ENISA wants thank institutions Andrew Kompanek CERT/CC Takahiro Kakumaru NEC 1 Using indicators enhance defence capabilities Actionable information November 2014 Page iii Legal notice Notice must taken publication represents views interpretations authors editors unless stated otherwise This publication construed legal action ENISA ENISA bodies unless adopted pursuant Regulation EU No 526/2013 This publication necessarily represent state - - art ENISA may update time time Third - party sources quoted appropriate ENISA responsible content external sources inc luding external websites referenced publication This publication intended information purposes It must accessible free charge Neither ENISA person acting behalf responsible use might made information contained publication Copyright Notice Â© European Union Agency Network Information Security ENISA 201 4 Reproduction authorised provided source acknowledged Using indicators enhance defence capabilities Actionable information November 2014 Page iv Contents 1 Introduction exercise ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... .. 1 1.1 Goal exercise ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... .. 1 1.2 The Scenario ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... .. 1 2 Introducti analysis environment ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... .. 2 2.1 Setup requirements ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... 2 3 Tasks ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... 3 3.1 Task 1 Create CRITs analyst account ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... .. 3 3.2 Task 1 Upload information ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... 6 3.3 Task 2 Use CRITs services extract even information ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... 12 3.4 Task 4 Visualize relationships ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... .. 17 3.5 Task 5 Create indicators ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... 19 3.6 Task 6 Apply indicators log status ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... 23 4 Conclusions ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... .. 26 5 Tools ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... 28 6 References ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... ... ... ... ... .. ... ... ... ... ... ... 28 Using indicators enhance defence capabilities Actionable information November 2014 Page v Main Objective The main objective exercise teach students work threat intelligence platforms like CRITS In practical part exercise participants use CRITs platform build malicious campaign add related information analyse Targeted Audience CERT staff involved process incid ent handling especially responsible detection new threat related directly CERT customers Total duration 6 - 7 hours Time Schedule Introduction exercise 0.5 hour Task 1 0.5 hour Task 2 1 5 hours Task 3 1 5 hours Task 4 0 5 hour Frequency N/A Using indicators enhance defence capabilities Actionable information November 2014 Page 1 1 Introduction exercise 1.1 Goal exercise This exercise developed training Incident Response Team members IT security professionals responsible creating acting indicators derived malicious campaigns incidents It also provide useful info rmation network administrator responsible network security The goal exercise learn create indicators log usage Research CRITs system focusing use CRITs select ndicators While CRITs help reader organise work including logging actions handling objects ultimately reader ha full responsibility planning choosing indicator This training meant teach u se CRITs everyday tasks provide foundation developing advanced indicator management skills Th e exercise starts standard CRITs installation guides every step get instance running 1.2 The Scenar io STIRC Inc leading contractor defence industry working highly classified military projects In first week July 2014 employee STIRC Inc received e - mail outlining changes agenda conference required attendance near future Unfortunately new schedule conflicted commitments leading employee call organise rs order withdraw particip ation The organise rs informed employee send message garding changes agenda This worried - became suspicious reported case STIRC Inc. Security Team The security team recognized fraudulent e - mail potential threat company network The team found PDF file sent agenda malicious subsequently took action devices network study analysis Security Team As part response incident STIRC Inc. Security Team se proprietary client - side honeypot used run code contained malicious PDF file redirected traffic honeypot IP addresses associated campaign This led logging connection malici ous code intended exfiltrate files honeypot perimeter defence mechanisms mitigate particular threat possible defend agains similar activity future During course exercise student provided artefacts obtained analysis incident You use CRITs 1 software visualize better understand campaign 1 http //crits.github.io/ Using indicators enhance defence capabilities Actionable information November 2014 Page 2 2 Introduction analysis environment 2.1 Setup requirements In order make exercise setup easier virtual machine prepared OVA package 2 format The virtual machine run 64 - bit computer running VirtualBox Follow steps outlined belo w set exercise environment Download ova VirtualBox appliance file 3 Choose .ova file disk MAC address conflicts may exist internal network b c - If list empty click adapter icon plus sign right list Figure 1 Host Only Networks Boot machine log using following credentials username root b password root Add following entry etc/hosts file host machine This file following locations /etc/hosts Linux systems b % SystemRoot % \ system32 \ drivers \ etc \ hosts Windows 2000 newer 2 http //en.wikipedia.org/wiki/Open_Virtualization_Format 3 https //www.enisa.europa.eu/ftp/crits - headless.ova Using indicators enhance defence capabilities Actionable information November 2014 Page 3 c /private/etc/hosts /etc/hosts Mac OS X 10.2 newer You add following entry ip_address address saw previous step < ip_address > crits.lan The entry required web server able validate 3 Tasks 3.1 Task 1 Create CRITs analyst account During first task become familiar CRITs interface create first analyst account This account created employee wants use CRITs Login CRITs instance http //crits.lan /crits using following credentials login crits password O8 { oD ' k Figure 2 CRITs Login Page go - view quick look recent changes CRITs instance e.g someone adding new samples e - mails domains As see empty objects created Your first task create analyst account Note You use Administrator account analyst work Click Using indicators enhance defence capabilities Actionable information November 2014 Page 4 navigation menu includes available views By clicking plus signs left items right entries expand submenu Figure 3 CRITs dashboard view First add org select anization STIRC screen similar one presented Figure 4 CRITs Control Panel users view Using indicators enhance defence capabilities Actionable information November 2014 Page 5 Your STIRC tured Remember password least 8 characters long include least 1 capital letter 1 lowercase letter 1 digit special character Figure 5 CRITs Add user dialog You using ac count remainder exercise Log - using navigation menu - try log newly created analyst Using indicators enhance defence capabilities Actionable information November 2014 Page 6 3.2 Task 1 Upload information You receive three files 4 dump_sandbox.pcap - traffic dump specially - crafted sandbox Security Team analyse threat dump_honeypot.pcap - traffic dump data exfiltration event honeypot set Security Team incident email.eml - email messag e attackers send employee The attachment content removed message These files help analyse course campaign visuali e connections different events Your first step load data CRITs To create new campaign logged administrator using credentials presented beginning exercise Create new Campaign using CRITs Control Panel | identifiers reference related tickets internal ticketing service You leave fields empty remember real - life scenario generally enter ticket number STIRC example presented Figure 6 CRITs New Campaign dialog A campaign logical concept provided CRITs corresponds set activities want treat distinct malicious campaign This helps organise different sets data loaded 4 https //www.enisa.europa.eu/ftp/crits - headless - files.zip Using indicators enhance defence capabilities Actionable information November 2014 Page 7 First log newly created CRITs analyst In order upload e - mail message go Navigation Select newly created campaign choose email.eml file Your upload window look similar one provided Figure 7 CRITs New e - mail dialog Now verify e - This provide w ith st ructured view e - mail file loaded You see Figure 8 CRITs e - mail details Some rows filled data due lack data left empty You edit - Originating - internal IP address This generally extern al IP address IP address mail server sent mail local server The presence internal IP probably due misconfiguration e - mail server STIRC Inc. infrastructure Edit IP address correct one I find following lines Using indicators enhance defence capabilities Actionable information November 2014 Page 8 Received mail11 stirc eu 127.0.0.1 localhost 127.0.0.1 maiad port 10024 ESMTP id 80214 - 04 < EarlCushing @ dayrep.com > Wed 02 Jul 2014 09:43:52 - 0500 EDT Received mail.cert.bh smarthost.malicouisdoamin.evil.cn 183.128.2.34 mail11 stirc.eu Postfix ESMTP id B814FF61A5 < EarlCushing @ dayrep.com > Wed 02 Jul 2014 00:41:55 - 0500 EDT Thi shows originating IP address fact 183.128.2.34 Use pencil icon correct CRITs mail server see information edit successful presented Figure 9 CRITs e - mail X - O riginating IP - ipv4 - e sure IP part campaign Finally check Figure 10 CRITs Add IP address dialog case extracted e - data IP address obtained phishing e - mail The screenshot shows filled dialog box Now create explicit relationship Email IP Address To copy Using indicators enhance defence capabilities Actionable information November 2014 Page 9 website This show objects contain way another th e IP address Go screenshot Figure 11 CRITs search results Now copied object clipboard Go back Figure 12 CRITs e - mail view Choose following options Destination ID object identifier second part relation ship Indicator containing IP address campaign Email message This way create distinguish Object something observed course campaign Indicator form basis actions We make distinction clear discuss Indicators later exercise Now create doma mail originated according analysis raw e - mail described smarthost.malicouisdoamin.evil .cn STIRC 183.128.2.34 address The resulting dialog box presented Using indicators enhance defence capabilities Actionable information November 2014 Page 10 Figure 13 CRITs Add new domain dialog If click text marked blue search Emails headers In way see create relationships dif ferent campaigns Examples searchable field values shown Figure 14 CRITs e - mail view Using indicators enhance defence capabilities Actionable information November 2014 Page 11 One useful searches done clicking X - Mailer value Perl5 Mail :Internet v2.03 Because one e - mail database one search result presen pictured Figure 15 CRITs search results Navigation menu You choose PCAP file add description click like pictured This create new object Figure 16 CRITs add new PCAP dialog Carry actions second PCAP file Figure 17 CRITs add new PCAP dialog Using indicators enhance defence capabilities Actionable information November 2014 Page 12 3.3 Task 2 Use CRITs services extract even information CRITs extended using 3rd - party extensions called services They used extract additional information files uploaded That additional information provide deeper insight campaign The goal task show use services manage create data based output services The first service use called MetaCap purpose extract tadata PCAP file Go PCAPs view pictured choose dump_honeypot.pcap file clicking Figure 18 CRITs PCAP view After clicking details butto n see details PCAP including hash PCAP contents filename Figure 19 CRITs dump_honeypot.pcap view Figure 20 CRITs metacap analysis view Both MetaCap ChopShop service mentioned use ChopShop Protocol Analysis Framework Due bug framework invoke service several times runs successfully During tests run 23 times ran without displaying error message th run pictured Using indicators enhance defence capabilities Actionable information November 2014 Page 13 Figure 21 CRITs metacap options dialog The remarks also apply ChopShop service 5 Figure 22 CRITs metacap results view From results MetaCap presented easily create CRITs Indicators corresponding IP Address objects IP values packet headers PCAP clicking plus sign displayed next highlig hted values This create two distinct data objects CRITs Indicator IP Address observable Indicator refer If wanted create IP Address would manually using < Shift+i > keyboard shortcut Click plus sign next second IP Address 183.128.2.34 This corresponds malicious mail server identified earlier In case CRITs actually create new IP Address object 5 This bug described https //github.com/crits/crits_services/issues/53 Using indicators enhance defence capabilities Actionable information November 2014 Page 14 already added IP Ad dress manually Instead system create relationship Indicator existing IP Address pictured Figure 23 CRITs ChopShop options dialog This show additional information HTTP DNS sessions found PCAP file pictured Using indicators enhance defence capabilities Actionable information November 2014 Page 15 Figure 24 ChopShop results view From screen see D NS queries results along HTTP sessions established All malware traffic made via HTTPS therefore shown MetaCap ing Using indicators enhance defence capabilities Actionable information November 2014 Page 16 Figure 25 CRITs metacap tcpdump tab view If want structured Wireshark - MetaCap Figure 26 CRITs dump_honeypot.pcap metacap viewer tab view Now try extract information second PCAP dump_sandbox.pcap As identify additional connections e.g previously mentioned HTTPS connections remember create cover yet You see details HTTPS connection Using indicators enhance defence capabilities Actionable information November 2014 Page 17 Figure 27 CRITs dump_sandbox.pcap metacap viewer tab view 3.4 Task 4 Visualize relationships All information extracted data loaded easily visualized using relationship service This allow see connections th e different elements campaign If created appropriate relationships files extracted objects First navigate initial e - mail message You going E - mail view using similar one pictured Figure 28 CRITs e - mail `` relationships service '' tab view Depth 3 If created every object correctly see connections e - mail domain PCAP files labelled using hash contents Notice malicious e - mail server IP address used label two different nodes graph Indicator IP object You distinguish colour scheme described legend upper - left corner see smaller graph includes immediate connections e - mail e.g PCAP files filtered view The new graph shown Using indicators enhance defence capabilities Actionable information November 2014 Page 18 Figure 29 CRITs e - mail `` relationships service '' tab view Depth 1 Next navigate PCAP files visualize relationships different perspective You going PCAPs view using Navigation Menu going nships pictured dump_honeypot.pcap file Figure 30 CRITs PCAP '' relationships service '' tab view Depth 3 box upper right corner view If change depth 1 time see e - result similar one pictured Figure 31 CRITs PCAP `` relation ships service '' tab view Depth 1 Using indicators enhance defence capabilities Actionable information November 2014 Page 19 unlabelled 3.5 Task 5 Create indicators This task although consisting simple steps requires forethought You must decide indicators use preventive actions example update firewall ACLs We already created indicators IP addresses found e - omething little complex In task consider everything could reasonably used Indicator scenario address even X - Mailer h eader CRITs includes flexible set Indicator types see information useful associate campaign Remember think th e - mail message IP addresses extracted PCAP files This sign highlighted sample screenshot Figure 32 CRITs e - mail details view The first option available us create Indicator sender email address Unfortunately address spoofed - clearly belongs one conference organise rs Hence would pointless create indicator The ap Analysing e - mail Subject also rather generic might later used normal i.e non - phishing email In contrast X - Mailer seems rather good choice It looks like phishing maili ng spam come header With additional investigation using mail server could determine whether case Hence create Indicator The next question need answer We cover actions available us next task For click plus sign left X - Mailer value Using indicators enhance defence capabilities Actionable information November 2014 Page 20 A domain added second task smarthost.malicouisdoamin.evil.cn also indicator used blackhol e sinkhole 6 C & C domain We deal actions next task It often useful consider additional context information deciding indicator use blocking For example IP address check history th e ASN IP address originated using bhp.he website http // bgp.he.net/AS4134 reputation service If ASN announces bogons 7 may worth blocking traffic originating directed ASN rather - CIDR selecting options list The dialog box pictured You also add Indicator Figure 33 CRITs Add new indicator window hat also store host - based indicators derived malware sample A wide range different types 6 http //en.wikipedia.org/wiki/Black_hole_ % 28networking % 29 7 http //www.team - cymru.org/Services/Bogons/ Using indicators enhance defence capabilities Actionable information November 2014 Page 21 Figure 34 CRITs Add new ndicator window We covered indicators available exercise However future consider reviewing list identify indicator types may apply campaign currently analysing Now click dicators Indicators view You go view pictured using Navigation Menu Figure 35 CRITs Indicators view identified This crucial prioritizing actions take You use Confidence value describe confident indicator effective flagging malicious activity It assigned one following values accordi ng CRITs documentation 8 8 https //github.com/crits/crits/wiki/Indicators Using indicators enhance defence capabilities Actionable information November 2014 Page 22 Unknown - default value Benign - determined Indicator nothing worried Low - something look n't need immediate attention Medium - something look attend soon possible High - really bad everyone needs drop respond Confidence intuitively viewed measure sure indicator good The values course one possible interpretations Unknown - use value received information external sources verify means independent verification For example case organization researcher know contacts domain connected campaign study Benign - use indicator cl early demonstrated corresponding malicious activity analysed You also remove Indicator mess view Low - use know source indicator whether person automated tool b een consistently reliable past likely actual indicator For example might mark indicator lacks information derived Medi um - use source information made invalidated assumptions using widely accepted reasoning and/or generalization derive indicator See example You also use trusted external sources yo u expect information correct based experience High - reserve Indicator sure understand exactly hen know derived directly PCAP file containing malicious traffic Impact uses values described Impact intuitively measure much priority give mitigating threats using indicator The higher impact course one many possible interpretations Unknown - use impact hard estimate An example would domain r eceived external sources see included campaign analysing Benign - use decide take actions regarding Indicator This different previous value know ction needed You also remove indicator may consider keeping informational purposes Low - require immediate action Action may taken later security team resources otherwise committed This really hard implement Indicator current infrastructure sure threat mitigated via sources An example would specific header C & C HTTP response Maybe network evice allows inspect HTTP directly already blocked domain IP address Medium - taken security team finishes current tasks An example provided High - indi intention order security team drop everything address imminent threat Using indicators enhance defence capabilities Actionable information November 2014 Page 23 An example would IP address host actively attacking network blocked Below example Confidence Impact values defined CIDR block indicator defined earlier malicious AS routing traffic malicious e - mail server Figure 36 CRITs I ndicator details view This example provides good illustration block offending IP Address right away preventive action blocking entire AS comes malicious AS This inferred fact offender came AS AS announces bogons So AS may linked campaign however also possible values Sliding right increases appropriate level sliding left decreases You actionable information prepared define take defensive actions log CRITs This purpose yo ur next task 3.6 Task 6 Apply indicators log status Indicators chosen previous tasks applied While CRITs helps creating indicators logging actions performed using indicators help actually applying That part Here demonstrate log actions First open view one IP indicators You see number tables including pictured Using indicators enhance defence capabilities Actionable information November 2014 Page 24 - Figure 37 CRITs IP indicator view This table allow add descriptions actions performed specified indicators Click plus symbol next table header You see dialog box like one pictured Figure 38 CRITs Indicator new action window In standard CRITs installation two actions available Blocked Outbound At Desktop Firewall Blocked Outbound At Firewall You administrator Using indicators enhance defence capabilities Actionable information November 2014 Page 25 Figure 39 CRITs Con trol panel items view tailor network configurat ion Figure 40 CRITs Indicator action window Try add new action one indicators Go back IP indicator view click plus information actions taken Figure 41 CRITs IP indicator new action window environments may require time measure becomes active For example try sinkhole domain TTL may make impossible sinkhole right away You may wait Using indicators enhance defence capabilities Actionable information November 2014 Page 26 day sinkhole capturing connections In case fields - explanatory flagging whether measure currently active After time turn action think hat longer needed All dates - explanatory field mandatory In cases example blocking IP address firewall reason action inferred various information already present CRITs Now familiar CRITs handles action logging go list indicators created previous task assign actions Remember limit existing action types - new action easily added administrator First consider domain name used C & C server The obvious choice sinkhole t. This done changing DNS server configuration return different predefined response queries ask home.windows - security.su You also blackhole i.e return NXDOMAIN response Second consider IP addresses Again obvious choice block firewall However also less obvious choice would require lot additional work You redirect traffic specially crafted honeypot server In way de ceive attackers learn objective closely monitoring honeypot environment The X - Mailer header value could used basis blocking incoming mail SMTP server However would probably appropriate mark message header spam This done using appropriate spam filter configuration local mail system Finally consider last indicators ASN associated mail server There ways tackle problem Firs course block communication AS In cases approach may problematic since users access web servers hosted AS including legitimate ones In particular case Chinese AS announces There another somewhat less popular approach You choose tarpit 9 AS giving time act possibly reducing data leakage In cases whe limited set users access AS reason want rate limit traffic AS prove successful even unpopular You also redirect traffic incoming AS segregated hon eypot server However like previous case time consuming assumes resources monitor honeypot attempted attacks 4 Conclusions During course exercise learned leverage CRITs visualize relationships among different elements campaign Of course even useful begun populate CRITs information multiple campaigns As information manage 9 Tarpitting group techniques used purposely delay incoming connections The idea delayed connections prove less effective spammers computer worms The delay implemented IP level TCP level SMTP level Using indicators enhance defence capabilities Actionable information November 2014 Page 27 becomes richer enable identify relationships among campaigns highlighting common IP addresses domain names malware samples You also learned extract indicators incident data develop miti gation actions track actions The hope taking structured approach indicator management ultimately better equipped secure network Using indicators enhance defence capabilities Actionable information November 2014 Page 28 5 Tools Name Version URL System Category CRITS 3.1.0 http //crits.github.io/ GNU/Linux Threat Intel Virtualbox http //www.virtualbox.org GNU/Linux Utils 6 References 1 http //www.sans.org/reading - room/whitepapers/warfare/tools - standards - cyber - threat - intelligence - projects - 34375 https //www.enisa.europa.eu/activities/cert/support/data - sharing Using indicators enhance defence capabilities Actionable information November 2014 Page 29 PO Box 1309 710 01 Heraklion Greece Tel +30 28 14 40 9710 info @ enisa.europa.eu www.enisa.europa.eu ENISA European Union Agency Network Information Security Science Technology Park Crete ITE Vassilika Vouton 700 13 Heraklion Greece Athens Office 1 Vass Sofias & Meg Alexandrou Marousi 151 24 Athens Greece 